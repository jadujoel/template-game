"use strict";(()=>{var zr=Object.defineProperty,qr=Object.defineProperties,Qr=Object.getOwnPropertyDescriptors,dn=Object.getOwnPropertySymbols,Xr=Object.prototype.hasOwnProperty,Yr=Object.prototype.propertyIsEnumerable,ln=(e,t,i)=>t in e?zr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Kr=(e,t)=>{for(var i in t||(t={}))Xr.call(t,i)&&ln(e,i,t[i]);if(dn)for(var i of dn(t))Yr.call(t,i)&&ln(e,i,t[i]);return e},Jr=(e,t)=>qr(e,Qr(t));var na=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},g=(e,t,i)=>(na(e,t,"read from private field"),i?i.call(e):t.get(e));var Bi=(e,t,i,s)=>(na(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),St=(e,t,i)=>(na(e,t,"access private method"),i);var Zr,eu,tu;eu=Symbol.toStringTag,tu=Symbol.iterator,Zr=new WeakMap;function pt(){}var iu={typename:"none",debug:pt,log:pt,info:pt,warn:pt,error:pt,table:pt,trace:pt},K=su;function su(){return iu}function au(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function nu(e){return!_n(e)}function _n(e){return e===void 0}function ou(e){return!ru(e)}function oa(e){return nu(e)&&ou(e)}function ru(e){return e===null}function hn(e){return Array.isArray(e)}function Nt(e){return typeof e=="number"&&!isNaN(e)}function In(e){return typeof e=="function"}function Ei(e){return typeof e=="string"}function js(e){return Nt(e)?!0:Ei(e)?Rn(e):!1}function Rn(e){return!isNaN(parseFloat(e))}function Xe(){}var uu,du,lu;du=Symbol.toStringTag,lu=Symbol.iterator,uu=new WeakMap;var hu;hu=new WeakMap;var cu=Object.defineProperty,pu=(e,t,i)=>t in e?cu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,z=(e,t,i)=>(pu(e,typeof t!="symbol"?t+"":t,i),i);var mu=(e=>(e.CAF=".caf",e.WEBM=".webm",e.MP4=".mp4",e.OGG=".ogg",e.MP3=".mp3",e.WAV=".wav",e))(mu||{}),fu="BusConfig",Dn=class{constructor(e={}){z(this,"typename",Dn.typename),z(this,"id","mainBus"),z(this,"volume",1),z(this,"pan",0),z(this,"destination",id),Object.assign(this,e)}},gu=Dn;z(gu,"typename",fu);var vu=class{constructor(e={}){z(this,"speed",1),z(this,"pitch",1),Object.assign(this,e)}},cn=vu,Vn="sound",yu=class{constructor(e={}){z(this,"typename",Vn),z(this,"id",""),z(this,"group","mainGroup"),z(this,"type","buffer"),z(this,"triggerLimit",0),z(this,"pitch",0),z(this,"pan",0),z(this,"volume",1),z(this,"encoding",new cn),Object.assign(this,e),e.encoding!=null&&(this.encoding=new cn(e.encoding))}};z(yu,"typename",Vn);var bu=Object.defineProperty,pn=Object.getOwnPropertySymbols,wu=Object.prototype.hasOwnProperty,Tu=Object.prototype.propertyIsEnumerable,Ks=(e,t,i)=>t in e?bu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Js=(e,t)=>{for(var i in t||(t={}))wu.call(t,i)&&Ks(e,i,t[i]);if(pn)for(var i of pn(t))Tu.call(t,i)&&Ks(e,i,t[i]);return e},T=(e,t,i)=>(Ks(e,typeof t!="symbol"?t+"":t,i),i);function mt(){}var Su={typename:"none",debug:mt,log:mt,info:mt,warn:mt,error:mt,table:mt,trace:mt},rs=Nu;function Nu(){return Su}var Pu=Object.defineProperty,Eu=(e,t,i)=>t in e?Pu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Au=(e,t,i)=>(Eu(e,typeof t!="symbol"?t+"":t,i),i);function ra(e,t){return Math.max(e,t)}function L(e,t,i){return Math.min(Math.max(e,t),i)}var mn=class extends Error{constructor(){super(...arguments),Au(this,"name","AssertionError")}};function Ln(e,t){if(!e)throw Hn(t)?new mn(t):(t==null?void 0:t.Err)!==void 0?new t.Err(t.msg):new mn(t==null?void 0:t.msg)}function xu(e,t){Ln(Ou(e),{msg:t!=null?t:"thing is undefined"})}function ku(e,t){Ln(!_u(e),{msg:t!=null?t:"thing is null"})}function Gu(e,t){xu(e,t),ku(e,t)}function Mu(e,t){return Gu(e,t),e}function Ou(e){return!Cu(e)}function Cu(e){return e===void 0}function _u(e){return e===null}function Iu(e){return typeof e=="number"&&!isNaN(e)}function Hn(e){return typeof e=="string"}function Wn(e){return Iu(e)?!0:Hn(e)?Ru(e):!1}function Ru(e){return!isNaN(parseFloat(e))}var Du,Vu,Lu;Vu=Symbol.toStringTag,Lu=Symbol.iterator,Du=new WeakMap;function Hu(e){return!Wn(e)||e>1||e<0?0:e>=.5?1:1-(.5-e)*2}function Wu(e){return!Wn(e)||e>1||e<0?0:e<=.5?1:1-(e-.5)*2}var ju=["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"],Uu=Object.defineProperty,Fu=(e,t,i)=>t in e?Uu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Si=(e,t,i)=>(Fu(e,typeof t!="symbol"?t+"":t,i),i);function ft(){}var $u={typename:"none",debug:ft,log:ft,info:ft,warn:ft,error:ft,table:ft,trace:ft},zi=Bu;function Bu(){return $u}var zu=Object.defineProperty,qu=(e,t,i)=>t in e?zu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Zs=(e,t,i)=>(qu(e,typeof t!="symbol"?t+"":t,i),i),Qu=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},we=(e,t,i)=>(Qu(e,t,"read from private field"),i?i.call(e):t.get(e)),Xu=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)};function Yu(e=navigator.userAgent){return e.includes("Firefox")}var Ku=class extends Error{constructor(){super(...arguments),Zs(this,"name","StrictMapError")}},se,jn,Un,fn=class{constructor(){Xu(this,se,new Map),Zs(this,jn,"StrictMap"),Zs(this,Un,we(this,se).entries())}get(e){if(!we(this,se).has(e))throw new Ku(`Key: '${e}' does not exist.`);return we(this,se).get(e)}set(e,t){return we(this,se).set(e,t),this}forEach(e,t){we(this,se).forEach(e,t)}clear(){we(this,se).clear()}delete(e){return we(this,se).delete(e)}entries(){return we(this,se).entries()}has(e){return we(this,se).has(e)}keys(){return we(this,se).keys()}size(){return we(this,se).size}values(){return we(this,se).values()}};jn=Symbol.toStringTag,Un=Symbol.iterator,se=new WeakMap;function Us(e){return(...t)=>{try{return[null,e(...t)]}catch(i){return[i,null]}}}var Ju=class extends Error{constructor(){super(...arguments),Si(this,"name","AutomatorError")}},qt=class{constructor(e){Si(this,"AutomatableParameters"),Si(this,"audioParams",new fn),Si(this,"defaults",new fn),Si(this,"firefoxHacks",new Map),this.AutomatableParameters=e}automate({paramId:e,valueCurve:t,when:i,duration:s}){zi().debug("[ecas] automate",{paramId:e,valueCurve:t,when:i,duration:s});let a=this.audioParams.get(e);if(a.cancelAndHoldAtTime(0),Yu()){this.firefoxHack({paramId:e,valueCurve:t,when:i,duration:s,audioParam:a});return}let[n]=Us(()=>a.setValueCurveAtTime(t,i,s))();if(n===null)return;zi().log("[ecas]: failed to override scheduled valueCurve. Using a linear ramp to the end value instead.",n),a.cancelAndHoldAtTime(0);let r=t.at(-1);if(r!==void 0){let[u]=Us(()=>a.linearRampToValueAtTime(r,i+s))();u!==null&&zi().log("[ecas]: failed to schedule linearRampToValueAtTime that was used as a fallback when the valueCurve failed.",u)}}firefoxHack({paramId:e,audioParam:t,valueCurve:i,when:s,duration:a}){var n;let r=(n=this.firefoxHacks.get(e))!=null?n:[],u=[],d=i.length,h=a/d;for(let p of r)window.clearTimeout(p);this.firefoxHacks.set(e,u);for(let[p,v]of i.entries()){let E=p*h,x=E*1e3;u.push(window.setTimeout(()=>{t.cancelAndHoldAtTime(0);let[_]=Us(()=>t.linearRampToValueAtTime(v,s+E-.3))();_!==null&&zi().log("[ecas]: (automator) failed to set linearRamp",_)},x))}}add(e,t,i){if(this.audioParams.has(e))throw new Ju(`AudioParam with id ${e} has already been added.`);this.set(e,t),i!=null?this.setDefault(e,i):this.setDefault(e,t.value)}cancel({paramId:e,when:t}){this.audioParams.get(e).cancelScheduledValues(t)}get(e){return this.audioParams.get(e)}set(e,t){this.audioParams.set(e,t)}current(e){return this.audioParams.get(e).value}getDefault(e){return this.defaults.get(e)}setDefault(e,t){this.defaults.set(e,t)}dispose(){this.audioParams.clear()}},es="AlgorithmicReverbInsert",Fn=class{constructor(e,t={id:es}){T(this,"typename",es),T(this,"id",es),T(this,"automator",new qt(["dry-gain","wet-gain"])),T(this,"options"),T(this,"inputGainNode"),T(this,"outputGainNode"),T(this,"dryGainNode"),T(this,"wetGainNode"),T(this,"reverbNode"),T(this,"audioContext"),this.options={id:t.id,mix:1,time:.2,decay:.2,reverse:!1},this.audioContext=e,this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.reverbNode=e.createConvolver(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.inputGainNode.connect(this.reverbNode),this.reverbNode.connect(this.wetGainNode),this.wetGainNode.connect(this.outputGainNode),this.modify(Js(Js({},this.options),t)).catch(rs().error),this.automator.add("dry-gain",this.dryGainNode.gain,t.mix),this.automator.add("wet-gain",this.wetGainNode.gain)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}async modify(e,t=0){let i=!1;e.id!==void 0&&(this.options.id=this.id=e.id),e.mix!==void 0&&(this.options.mix=L(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(L(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(L(this.options.mix,1e-4,1),t)),e.reverse!==void 0&&this.options.reverse!==e.reverse&&(this.options.reverse=e.reverse,i=!0),e.time!==void 0&&this.options.time!==e.time&&(this.options.time=L(e.time,1e-4,10),i=!0),e.decay!==void 0&&this.options.decay!==e.decay&&(i=!0,this.options.decay=Math.min(Math.max(e.decay,1e-4),this.options.time)),i&&this.buildImpulse()}buildImpulse(){let e=this.audioContext.sampleRate*this.options.time,t=this.audioContext.createBuffer(2,e,this.audioContext.sampleRate),i=t.getChannelData(0),s=t.getChannelData(1),a,n;for(n=0;n<e;n++)a=this.options.reverse?e-n:n,i[n]=(Math.random()*2-1)*Math.pow(1-a/e,this.options.decay),s[n]=(Math.random()*2-1)*Math.pow(1-a/e,this.options.decay);this.reverbNode.buffer!=null&&(this.inputGainNode.disconnect(this.reverbNode),this.reverbNode.disconnect(this.wetGainNode),this.reverbNode=this.audioContext.createConvolver(),this.inputGainNode.connect(this.reverbNode),this.reverbNode.connect(this.wetGainNode)),this.reverbNode.buffer=t}};T(Fn,"typename",es);var $n="BiquadFilterInsert",Bn=class{constructor(e,t){T(this,"typename",Bn.typename),T(this,"id",$n),T(this,"automator",new qt(["frequency","detune","Q","gain"])),T(this,"options"),T(this,"node"),this.node=e.createBiquadFilter(),this.id=t.id,this.options=Object.assign({id:t.id,detune:0,frequency:e.sampleRate/2,gain:0,Q:1,type:"lowpass"},t),this.node.Q.value=this.options.Q,this.node.detune.value=this.options.detune,this.node.frequency.value=this.options.frequency,this.node.gain.value=this.options.gain,this.node.type=this.options.type,this.automator.add("Q",this.node.Q),this.automator.add("detune",this.node.detune),this.automator.add("frequency",this.node.frequency),this.automator.add("gain",this.node.gain)}get input(){return this.node}get output(){return this.node}get getOptions(){return this.options}async modify(e,t,i){if(typeof e.Q=="number"&&(this.options.Q=L(e.Q,1e-4,1e3),this.node.Q.cancelScheduledValues(0),this.node.Q.linearRampToValueAtTime(this.options.Q,t)),typeof e.detune=="number"){let s=34028234663852886e22,a=-34028234663852886e22;this.options.detune=L(e.detune,a,s),this.node.detune.cancelScheduledValues(0),this.node.detune.linearRampToValueAtTime(this.options.detune,t)}if(typeof e.frequency=="number"){let s=i/2;this.options.frequency=L(e.frequency,10,s),this.node.frequency.cancelScheduledValues(0),this.node.frequency.exponentialRampToValueAtTime(this.options.frequency,t)}typeof e.gain=="number"&&(this.options.gain=L(e.gain,-40,40),this.node.gain.cancelScheduledValues(0),this.node.gain.linearRampToValueAtTime(this.options.gain,t)),e.type!==void 0&&e.type!==null&&ju.includes(e.type)&&(this.node.type=this.options.type=e.type),await new Promise(s=>{setTimeout(()=>{s()},ra((t-this.node.context.currentTime)*1e3,0))})}},zn=Bn;T(zn,"typename",$n);var ts="ReverbConvolverInsert",qn=class{constructor(e,t,i){if(T(this,"typename",ts),T(this,"id",ts),T(this,"automator",new qt(["dry-gain","wet-gain"])),T(this,"soundHandler"),T(this,"options",{id:ts,normalize:!1,reverse:!1,impulseResponse:"none",mix:1}),T(this,"inputGainNode"),T(this,"outputGainNode"),T(this,"dryGainNode"),T(this,"wetGainNode"),T(this,"convolverNode"),this.soundHandler=i,this.inputGainNode=e.createGain(),this.convolverNode=e.createConvolver(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.inputGainNode.connect(this.convolverNode),this.convolverNode.connect(this.wetGainNode),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.wetGainNode.connect(this.outputGainNode),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain),this.id=t.id,t.impulseResponse===void 0){rs().warn("[ecas] convolver reverb impulse file should be specified.");return}this.modify(t).catch(rs().error)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}get audioParams(){return{dryGain:this.dryGainNode.gain,wetGain:this.wetGainNode.gain}}async modify(e,t=0){let i=!1;e.id!==void 0&&(this.options.id=this.id=e.id),e.mix!==void 0&&(this.options.mix=L(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(L(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(L(this.options.mix,1e-4,1),t)),e.normalize!==void 0&&this.options.normalize!==e.normalize&&(this.options.normalize=e.normalize,this.convolverNode.normalize=this.options.normalize,i=!0),e.reverse!==void 0&&this.options.reverse!==e.reverse&&(this.options.reverse=e.reverse,i=!0),e.impulseResponse!==void 0&&this.options.impulseResponse!==e.impulseResponse&&(i=!0,this.options.impulseResponse=e.impulseResponse),i&&await this.updateBuffer()}async updateBuffer(){let e=this.options.reverse?this.soundHandler.getAudioBufferReversed(this.options.impulseResponse):this.soundHandler.getAudioBuffer(this.options.impulseResponse);this.convolverNode.buffer=Mu(await e)}};T(qn,"typename",ts);var Qn="DelayInsert",Xn=class{constructor(e,t={id:"delay"}){T(this,"typename",Qn),T(this,"automator",new qt(["delayTime","feedback","dry-gain","wet-gain","cutoff"])),T(this,"options"),T(this,"inputGainNode"),T(this,"outputGainNode"),T(this,"dryGainNode"),T(this,"wetGainNode"),T(this,"feedbackGainNode"),T(this,"delayNode"),T(this,"filterNode"),this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.feedbackGainNode=e.createGain(),this.filterNode=e.createBiquadFilter(),this.filterNode.type="lowpass",this.delayNode=e.createDelay(t.maxDelayTime!==void 0?t.maxDelayTime:1),this.inputGainNode.connect(this.dryGainNode).connect(this.outputGainNode),this.inputGainNode.connect(this.delayNode).connect(this.wetGainNode).connect(this.outputGainNode),this.delayNode.connect(this.feedbackGainNode).connect(this.filterNode).connect(this.delayNode),this.options={id:t.id,feedback:.1,mix:1,delayTime:.3,maxDelayTime:1,cutoff:2e4},this.modify(Object.assign(this.options,t)).catch(rs().error),this.automator.add("cutoff",this.filterNode.frequency),this.automator.add("delayTime",this.delayNode.delayTime),this.automator.add("feedback",this.feedbackGainNode.gain),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain)}get id(){return this.options.id}set id(e){this.options.id=e}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}async modify(e,t=0){e.delayTime!==void 0&&(this.options.delayTime=L(e.delayTime,0,this.options.maxDelayTime),this.delayNode.delayTime.cancelScheduledValues(0),this.delayNode.delayTime.linearRampToValueAtTime(this.options.delayTime,t)),e.feedback!==void 0&&(this.options.feedback=L(e.feedback,1e-4,1),this.feedbackGainNode.gain.cancelScheduledValues(0),this.feedbackGainNode.gain.exponentialRampToValueAtTime(this.options.feedback,t)),e.maxDelayTime!==void 0&&(this.options.maxDelayTime=L(e.maxDelayTime,0,10)),e.mix!==void 0&&(this.options.mix=L(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(L(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(this.options.mix,t)),e.id!==void 0&&(this.options.id=e.id),e.cutoff!==void 0&&(this.options.cutoff=L(e.cutoff,10,2e4),this.filterNode.frequency.exponentialRampToValueAtTime(this.options.cutoff,t)),await new Promise(i=>{setTimeout(()=>{i()},ra((t-this.outputGainNode.context.currentTime)*1e3,0))})}};T(Xn,"typename",Qn);var ea="DynamicsCompressorInsert",Yn=class{constructor(e,t){T(this,"typename",ea),T(this,"id",ea),T(this,"options"),T(this,"automator",new qt(["threshold","ratio","attack","release","knee"])),T(this,"node"),T(this,"context"),this.context=e,this.id=t.id,this.options=Js({},t),this.node=e.createDynamicsCompressor(),this.automator.add("threshold",this.threshold),this.automator.add("ratio",this.ratio),this.automator.add("attack",this.attack),this.automator.add("release",this.release),this.automator.add("knee",this.knee),this.modify(t,0)}get attack(){return this.node.attack}get knee(){return this.node.knee}get ratio(){return this.node.ratio}get release(){return this.node.release}get threshold(){return this.node.threshold}get input(){return this.node}get output(){return this.node}get getOptions(){return this.options}async modify(e,t){typeof e.attack=="number"&&(this.attack.cancelScheduledValues(0),this.attack.linearRampToValueAtTime(L(e.attack,0,1),t)),typeof e.knee=="number"&&(this.knee.cancelScheduledValues(0),this.knee.linearRampToValueAtTime(L(e.knee,0,40),t)),typeof e.ratio=="number"&&(this.ratio.cancelScheduledValues(0),this.ratio.linearRampToValueAtTime(L(e.ratio,1,20),t)),typeof e.release=="number"&&(this.release.cancelScheduledValues(0),this.release.exponentialRampToValueAtTime(L(e.release,0,1),t)),typeof e.threshold=="number"&&(this.threshold.cancelScheduledValues(0),this.threshold.linearRampToValueAtTime(L(e.threshold,-100,0),t)),await new Promise(i=>{setTimeout(()=>{i()},ra((t-this.context.currentTime)*1e3,0))})}};T(Yn,"typename",ea);var is="PingPongDelayInsert",Kn=class{constructor(e,t={id:is}){T(this,"typename",is),T(this,"id",is),T(this,"automator",new qt(["dry-gain","wet-gain","delay-time-left","delay-time-right","feedback"])),T(this,"options"),T(this,"inputGainNode"),T(this,"outputGainNode"),T(this,"dryGainNode"),T(this,"wetGainNode"),T(this,"feedbackGainNode"),T(this,"delayNodeLeft"),T(this,"delayNodeRight"),T(this,"channelMerger"),this.options=Object.assign({feedback:.5,mix:.5,delayTime:.3,maxDelayTime:1},t),this.maxDelayTime=t.maxDelayTime!==void 0?t.maxDelayTime:1,this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.feedbackGainNode=e.createGain(),this.delayNodeLeft=e.createDelay(this.maxDelayTime),this.delayNodeRight=e.createDelay(this.maxDelayTime),this.channelMerger=e.createChannelMerger(2),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.delayNodeLeft.connect(this.channelMerger,0,0),this.delayNodeRight.connect(this.channelMerger,0,1),this.delayNodeLeft.connect(this.delayNodeRight),this.feedbackGainNode.connect(this.delayNodeLeft),this.delayNodeRight.connect(this.feedbackGainNode),this.inputGainNode.connect(this.feedbackGainNode),this.channelMerger.connect(this.wetGainNode),this.wetGainNode.connect(this.outputGainNode),this.id=t.id,this.automator.add("delay-time-left",this.delayNodeLeft.delayTime),this.automator.add("delay-time-right",this.delayNodeRight.delayTime),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain),this.automator.add("feedback",this.feedbackGainNode.gain)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}async modify(){await Promise.resolve(void 0)}get getOptions(){return this.options}get mix(){return this.options.mix}set mix(e){this.options.mix=e,this.dryGainNode.gain.value=Wu(this.mix),this.wetGainNode.gain.value=Hu(this.mix)}get feedback(){return this.options.feedback}set feedback(e){e<0||e>1||(this.options.feedback=e,this.feedbackGainNode.gain.value=this.feedback)}get delayTime(){return this.options.delayTime}set delayTime(e){e<0||e>this.maxDelayTime||(this.options.delayTime=e,this.delayNodeLeft.delayTime.value=this.delayTime,this.delayNodeRight.delayTime.value=this.delayTime)}get maxDelayTime(){return this.options.maxDelayTime}set maxDelayTime(e){this.options.maxDelayTime=e}getPingPongDelayNodes(e){return e==="feedback"?this.feedbackGainNode:[this.delayNodeLeft,this.delayNodeRight]}getGeneratedGraph(){return{leftNode:this.inputGainNode,rightNode:this.outputGainNode}}};T(Kn,"typename",is);var Lf={[Fn.typename]:"reverbAlgorithmic",[qn.typename]:"reverbConvolver",[Yn.typename]:"compressor",[Xn.typename]:"delay",[Kn.typename]:"pingPongDelay",[zn.typename]:"filter"};function gn(e){return typeof e=="string"}var Zu,ed,td;ed=Symbol.toStringTag,td=Symbol.iterator,Zu=new WeakMap;function ss(e){if(!gn(e))return!1;let t=/^\d{1,2}\.\d{1,2}\.\d{1,3}$/;return(gn(e)?e.match(t):null)!==null}var id="master",sd=32;function ad(e,t,i){if(!t||!t.tempo)return K().warn("[ecas] unable to convert bar.beat.tick to time, since no tempo is configured."),0;t.timeSignature=t.timeSignature||{meter:4,unit:4},t.triggerQuantize=t.triggerQuantize||1;let s=e.split("."),a=parseInt(s[0],10),n=parseInt(s[1],10),r=parseInt(s[2],10),u=1/t.timeSignature.unit*4,d,h=60/(t.tempo/u),p=h*t.timeSignature.meter,v=h/sd;t.triggerQuantize>=1?d=h*(t.timeSignature.meter*t.triggerQuantize):d=h/(1/t.timeSignature.unit)*t.triggerQuantize;let E=d-(i%d||d),x=a*p,_=n*h,ie=r*v;return x+_+ie+E}var ne=class{static pitchToPlaybackRate(e){return(e<-4800||e>4800)&&(K().info(`[ecas] pitch outside allowed range (-4800 to 4800), was: ${e}, clamping.`),e=Math.min(4800,Math.max(-4800,e))),Math.pow(2,e/1200)}static stringFractionToNumber(e){if(js(e)||!e)return this.defaultNumber(e,0);if(Ei(e)){let t=e.split("/").map(i=>parseInt(i,10));if(!t||t.length!==2)throw new Error("[ecas] can only convert fraction in format 'n/n'. Got:"+e);return t[0]/t[1]}return 0}static defaultNumber(e,t=0,i,s=0){if(Nt(e))return e;if(hn(e)){let a=this.randomizeValues(e);return typeof a=="number"?a:(K().warn(`[ecas] provided value is an array: ${e}, but ECAS is unable to get a randomised value from it, returning ${t} instead.`),t)}return ss(e)?i?ad(e,i,s):(K().warn("[ecas] you need to provide tempo information for conversion of bar.beat.tick notation to time."),t):Rn(e)?parseFloat(e.toString()):(K().log("[ecas] unable to set default number value, returning 0. val was:",e),t)}static defaultValue(e,t){return(e==null||Ei(e)&&e==="")&&(e=t),e}static randomizeValues(e){if(Nt(e))return e;let t=!0,i=/^-?\d*\.?\d+,-?\d*\.?\d+$/,s=/^-?\d*\.?\d+$/,a,n;if(!Nt(e)&&Array.isArray(e))if(e.length>0){if(n=e.map(r=>{if(s.test(r))return r;if(hn(r))return this._getRandomValue(parseFloat(r[0]),parseFloat(r[1]));if(i.test(r)){let u=r.split(",");return this._getRandomValue(parseFloat(u[0]),parseFloat(u[1]))}else t=!1,K().warn("[ecas] invalid random value format: "+e);return null}),t)return a=this.randomShuffle(n)[0],parseFloat(a)}else K().warn("[ecas] invalid random value: empty array");else return a=e,a;throw new Error("[ecas] randomize values should not reach this line")}static randomShuffle(e){let t=e.map(i=>[Math.random(),i]);return t.sort(),t.map(i=>i[1])}static sumVolume(e=1,t=1){let i=this.defaultNumber(e,1),s=this.defaultNumber(t,1);return i*s}static sumPan(e,t){let i=Math.max(-1,Math.min(this.defaultNumber(e),1)),s=Math.max(-1,Math.min(this.defaultNumber(t),1));return s+(1-Math.abs(s))*i}static sumPitch(e,t){let i=this.defaultNumber(e),s=this.defaultNumber(t);return i+s}static sumPos(e,t){let i=this.defaultNumber(e),s=this.defaultNumber(t);return i+s}static filterUnique(e,t){if(e==null)return null;let i=[],s=[];return e.forEach(a=>{let n="";t.forEach(r=>{au(a,r)&&(n+=a[r])}),s.indexOf(n)===-1&&i.push(a),s.push(n)}),i}static getWetMixValue(e){return!js(e)||e>1||e<0?0:e>=.5?1:1-(.5-e)*2}static getDryMixValue(e){return!js(e)||e>1||e<0?0:e<=.5?1:1-(e-.5)*2}static generateUniqueId(e){let t=new Date().getTime(),i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{let a=(t+crypto.getRandomValues(new Uint32Array(1))[0]/10+Math.random()*16)%16|0;return(s==="x"?a:a&3|8).toString(16)});return e&&e!==""&&typeof e=="string"?e+"_"+i:i}static _getRandomValue(e,t){return(Math.random()*(t-e)+e).toFixed(3)}};var ua={Ready:"ecas-ready",Mute:"ecas-mute",Unmute:"ecas-unmute",Pause:"ecas-pause",Resume:"ecas-resume",Timer:{Pause:"ecas-timer-pause",Resume:"ecas-timer-resume"},Context:{Pause:"ecas-context-pause",Resume:"ecas-context-resume",Suspended:"ecas-context-suspended",Running:"ecas-context-running",Closed:"ecas-context-closed",Interrupted:"ecas-context-interrupted"},Preload:{Start:"ecas-preload-start",Done:"ecas-preload-done",Progress:"ecas-preload-progress"},Sound:{LoadStart:"ecas-sound-load-start",Loading:"ecas-sound-load-loading",LoadDone:"ecas-sound-load-done",LoadError:"ecas-sound-load-error",Abort:"ecas-sound-abort",CanPlay:"ecas-sound-canplay",Play:"ecas-sound-play",Stop:"ecas-sound-stop",Ended:"ecas-sound-ended",Pause:"ecas-sound-pause",FadeOutStart:"ecas-sound-fade-out-start",FadeOutEnd:"ecas-sound-fade-out-end",PlaybackStart:"ecas-sound-playback-start",PlaybackEnd:"ecas-sound-playback-end",PlaybackError:"ecas-sound-playback-error"},Events:{LoadStart:"ecas-events-load-start",LoadDone:"ecas-events-load-done"},Envelope:{Play:"ecas-envelope-play",Start:"ecas-envelope-start",Ended:"ecas-envelope-ended"}};function nd(e){return oa(e.src.copyToChannel)?od(e):rd(e)}function od(e){let{src:t,trg:i}=e;for(let s=0;s<t.numberOfChannels;s++)i.copyToChannel(t.getChannelData(s),s,0);return i}function rd(e){let{src:t,trg:i}=e;for(let s=0;s<t.numberOfChannels;s++){let a=i.getChannelData(s),n=t.getChannelData(s);for(let r=0;r<a.length;r++)a[r]=n[r]||0}return i}function ud(e,t){return t.createBuffer(e.numberOfChannels,e.length,e.sampleRate)}function dd(e){for(let t=0;t<e.numberOfChannels;t++){let i=e.getChannelData(t).reverse();e.copyToChannel(i,t)}return e}function ld(e,t){let i=ud(e,t),s=nd({src:e,trg:i});return dd(s)}var vn,hd,cd,yn,pd,md,fd,gd;vn=new WeakMap,hd=new WeakMap,cd=new WeakMap,yn=new WeakMap,pd=new WeakMap,md=new WeakMap,fd=new WeakSet,gd=async function(e){let t=await this.getAudioBuffer(e),i=ld(t,g(this,vn));g(this,yn).set(e,i)};var vd,yd,bn,bd,wd,Td;vd=new WeakMap,yd=new WeakMap,bn=new WeakMap,bd=new WeakMap,wd=new WeakSet,Td=function(e){let t=e.eventConfig;for(let{id:s,actions:a}of t)g(this,bn).set(s,i(a));return;function i(s){let a=[];for(let n of s)n.type==="playSound"&&a.push(n.args[0].toString());return a}};var Ie={DEFAULT_STOP:"default_stop",POOL_STOP:"pool_stop",POOL_PLAY:"pool_play",POOL_PAUSE:"pool_pause",POOL_RESUME:"pool_resume",SOUND_START:"sound_start",SOUND_STOP:"sound_stop",SOUND_PAUSE:"sound_pause",SOUND_RESUME:"sound_resume",SOUND_COMPLETE:"sound_completed",PATTERN_PLAY:"pattern_play",PATTERN_STOP:"pattern_stop",PATTERN_RESUME:"pattern_resume",PATTERN_PAUSE:"pattern_pause",PATTERN:"pattern",STOP:"stop",MIXER_PLAY_SOUND:"mixer_playSound",ENVELOPE_SCHEDULED:"envelope_scheduled",SCHEDULED:"scheduled",SCHEDULED_REGEX:"scheduled_(.)+",DISCONNECT:"disconnect",VOLUME:"volume",CROSSFADE:"crossfade",PLAY:"play"},Jn="EnvelopeContext",Sd=class{constructor(e={}){this.type="sound",this.parentId="",this.startTime=0,this.onEnded=Xe,this.onplay=Xe,this.willStopSoundOnEnded=!1,this.isPaused=!1,this.isAFadeIn=!1,this.curveType="linear",this.envelopePoints=[],this.param="volume",Object.assign(this,e)}get typename(){return Jn}};Sd.typename=Jn;var Nd;Nd=new WeakMap;var Zn="PlayEnvelopeArgs",da=class{constructor(e){if(this.startTime=0,this.type="sound",this.curveType="linear",this.onEnded=Xe,this.onplay=Xe,this.willStopSoundOnEnded=!1,this.envelopePoints=[],Object.assign(this,e),Nt(e.startTime)){this.startTime=e.startTime/1e3;return}this.startTime=0}get typename(){return Zn}};da.typename=Zn;function Pd(e){return e.typename===da.typename}function Ed(e){return new da(e)}function Se(...e){return e.join("::")}function Ad(e){let t=Se(e.targetId,e.parentId,e.param);return e.willStopSoundOnEnded?Se(t,Ie.STOP):t}var Ni=class{static setTimeout(e,t,i="",...s){if(i===""){window.setTimeout(e,t*1e3,s);return}let a=this.dateProvider()(),n=[],r=this._map[i];r&&(n=n.concat(r.callbacks),window.clearTimeout(r.id)),n.push({args:s,callback:e});let u=window.setTimeout(()=>this.onDone(i),t*1e3);this._map[i]={id:u,remaining:t,start:a,callbacks:n,caller:i}}static renameTimeout(e,t,i){let s=this._map[t];if(s){let a=i||s.remaining;window.clearTimeout(s.id),Ni.clearTimeout(t);let n=window.setTimeout(()=>this.onDone(e),a*1e3);this._map[e]=Jr(Kr({},s),{id:n,remaining:a,caller:e})}}static pause(e){if(this._map[e]){let t=this._map[e],i=this.dateProvider()();window.clearTimeout(t.id),t.remaining-=i-t.start}}static pauseMatching(e){Object.keys(this._map).forEach(t=>{let i=t.match(e);i&&i.forEach(s=>{s===t&&Ni.pause(s)})})}static resume(e){if(this._map[e]){let t=this._map[e],i=this.dateProvider()();t.start=i;let s=window.setTimeout(this.onDone.bind(this,e,t.callbacks),t.remaining*1e3);t.id=s}}static resumeMatching(e){Object.keys(this._map).forEach(t=>{let i=t.match(e);i&&i.forEach(s=>{s===t&&Ni.resume(s)})})}static clearTimeout(e){this._map[e]&&(window.clearTimeout(this._map[e].id),delete this._map[e])}static clearMatching(e){Object.keys(this._map).forEach(t=>{let i=t.match(e);i&&i.forEach(s=>{s===t&&Ni.clearTimeout(s)})})}static hasTimeout(e){return oa(this._map[e])}static onDone(e){if(this._map[e]){let t=this._map[e];delete this._map[e],t.callbacks.forEach(i=>{i.callback.call(i.args)}),window.clearTimeout(t.id)}}},Z=Ni;Z._map={},Z.dateProvider=()=>()=>Date.now()/1e3;var xd=Object.defineProperty,wn=Object.getOwnPropertySymbols,kd=Object.prototype.hasOwnProperty,Gd=Object.prototype.propertyIsEnumerable,ta=(e,t,i)=>t in e?xd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,ia=(e,t)=>{for(var i in t||(t={}))kd.call(t,i)&&ta(e,i,t[i]);if(wn)for(var i of wn(t))Gd.call(t,i)&&ta(e,i,t[i]);return e},S=(e,t,i)=>(ta(e,typeof t!="symbol"?t+"":t,i),i);function gt(){}var Md={typename:"none",debug:gt,log:gt,info:gt,warn:gt,error:gt,table:gt,trace:gt},us=Od;function Od(){return Md}var Cd=Object.defineProperty,_d=(e,t,i)=>t in e?Cd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Id=(e,t,i)=>(_d(e,typeof t!="symbol"?t+"":t,i),i);function la(e,t){return Math.max(e,t)}function H(e,t,i){return Math.min(Math.max(e,t),i)}var Tn=class extends Error{constructor(){super(...arguments),Id(this,"name","AssertionError")}};function eo(e,t){if(!e)throw to(t)?new Tn(t):(t==null?void 0:t.Err)!==void 0?new t.Err(t.msg):new Tn(t==null?void 0:t.msg)}function Rd(e,t){eo(Hd(e),{msg:t!=null?t:"thing is undefined"})}function Dd(e,t){eo(!jd(e),{msg:t!=null?t:"thing is null"})}function Vd(e,t){Rd(e,t),Dd(e,t)}function Ld(e,t){return Vd(e,t),e}function Hd(e){return!Wd(e)}function Wd(e){return e===void 0}function jd(e){return e===null}function Ud(e){return typeof e=="number"&&!isNaN(e)}function to(e){return typeof e=="string"}function io(e){return Ud(e)?!0:to(e)?Fd(e):!1}function Fd(e){return!isNaN(parseFloat(e))}var $d,Bd,zd;Bd=Symbol.toStringTag,zd=Symbol.iterator,$d=new WeakMap;function qd(e){return!io(e)||e>1||e<0?0:e>=.5?1:1-(.5-e)*2}function Qd(e){return!io(e)||e>1||e<0?0:e<=.5?1:1-(e-.5)*2}var Xd=["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"],Yd=Object.defineProperty,Kd=(e,t,i)=>t in e?Yd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Pi=(e,t,i)=>(Kd(e,typeof t!="symbol"?t+"":t,i),i);function vt(){}var Jd={typename:"none",debug:vt,log:vt,info:vt,warn:vt,error:vt,table:vt,trace:vt},qi=Zd;function Zd(){return Jd}var el=Object.defineProperty,tl=(e,t,i)=>t in e?el(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,sa=(e,t,i)=>(tl(e,typeof t!="symbol"?t+"":t,i),i),il=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},Te=(e,t,i)=>(il(e,t,"read from private field"),i?i.call(e):t.get(e)),sl=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)};function al(e=navigator.userAgent){return e.includes("Firefox")}var nl=class extends Error{constructor(){super(...arguments),sa(this,"name","StrictMapError")}},ae,so,ao,Sn=class{constructor(){sl(this,ae,new Map),sa(this,so,"StrictMap"),sa(this,ao,Te(this,ae).entries())}get(e){if(!Te(this,ae).has(e))throw new nl(`Key: '${e}' does not exist.`);return Te(this,ae).get(e)}set(e,t){return Te(this,ae).set(e,t),this}forEach(e,t){Te(this,ae).forEach(e,t)}clear(){Te(this,ae).clear()}delete(e){return Te(this,ae).delete(e)}entries(){return Te(this,ae).entries()}has(e){return Te(this,ae).has(e)}keys(){return Te(this,ae).keys()}size(){return Te(this,ae).size}values(){return Te(this,ae).values()}};so=Symbol.toStringTag,ao=Symbol.iterator,ae=new WeakMap;function Fs(e){return(...t)=>{try{return[null,e(...t)]}catch(i){return[i,null]}}}var ol=class extends Error{constructor(){super(...arguments),Pi(this,"name","AutomatorError")}},Qt=class{constructor(e){Pi(this,"AutomatableParameters"),Pi(this,"audioParams",new Sn),Pi(this,"defaults",new Sn),Pi(this,"firefoxHacks",new Map),this.AutomatableParameters=e}automate({paramId:e,valueCurve:t,when:i,duration:s}){qi().debug("[ecas] automate",{paramId:e,valueCurve:t,when:i,duration:s});let a=this.audioParams.get(e);if(a.cancelAndHoldAtTime(0),al()){this.firefoxHack({paramId:e,valueCurve:t,when:i,duration:s,audioParam:a});return}let[n]=Fs(()=>a.setValueCurveAtTime(t,i,s))();if(n===null)return;qi().log("[ecas]: failed to override scheduled valueCurve. Using a linear ramp to the end value instead.",n),a.cancelAndHoldAtTime(0);let r=t.at(-1);if(r!==void 0){let[u]=Fs(()=>a.linearRampToValueAtTime(r,i+s))();u!==null&&qi().log("[ecas]: failed to schedule linearRampToValueAtTime that was used as a fallback when the valueCurve failed.",u)}}firefoxHack({paramId:e,audioParam:t,valueCurve:i,when:s,duration:a}){var n;let r=(n=this.firefoxHacks.get(e))!=null?n:[],u=[],d=i.length,h=a/d;for(let p of r)window.clearTimeout(p);this.firefoxHacks.set(e,u);for(let[p,v]of i.entries()){let E=p*h,x=E*1e3;u.push(window.setTimeout(()=>{t.cancelAndHoldAtTime(0);let[_]=Fs(()=>t.linearRampToValueAtTime(v,s+E-.3))();_!==null&&qi().log("[ecas]: (automator) failed to set linearRamp",_)},x))}}add(e,t,i){if(this.audioParams.has(e))throw new ol(`AudioParam with id ${e} has already been added.`);this.set(e,t),i!=null?this.setDefault(e,i):this.setDefault(e,t.value)}cancel({paramId:e,when:t}){this.audioParams.get(e).cancelScheduledValues(t)}get(e){return this.audioParams.get(e)}set(e,t){this.audioParams.set(e,t)}current(e){return this.audioParams.get(e).value}getDefault(e){return this.defaults.get(e)}setDefault(e,t){this.defaults.set(e,t)}dispose(){this.audioParams.clear()}},as="AlgorithmicReverbInsert",rl=class{constructor(e,t={id:as}){S(this,"typename",as),S(this,"id",as),S(this,"automator",new Qt(["dry-gain","wet-gain"])),S(this,"options"),S(this,"inputGainNode"),S(this,"outputGainNode"),S(this,"dryGainNode"),S(this,"wetGainNode"),S(this,"reverbNode"),S(this,"audioContext"),this.options={id:t.id,mix:1,time:.2,decay:.2,reverse:!1},this.audioContext=e,this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.reverbNode=e.createConvolver(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.inputGainNode.connect(this.reverbNode),this.reverbNode.connect(this.wetGainNode),this.wetGainNode.connect(this.outputGainNode),this.modify(ia(ia({},this.options),t)).catch(us().error),this.automator.add("dry-gain",this.dryGainNode.gain,t.mix),this.automator.add("wet-gain",this.wetGainNode.gain)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}async modify(e,t=0){let i=!1;e.id!==void 0&&(this.options.id=this.id=e.id),e.mix!==void 0&&(this.options.mix=H(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(H(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(H(this.options.mix,1e-4,1),t)),e.reverse!==void 0&&this.options.reverse!==e.reverse&&(this.options.reverse=e.reverse,i=!0),e.time!==void 0&&this.options.time!==e.time&&(this.options.time=H(e.time,1e-4,10),i=!0),e.decay!==void 0&&this.options.decay!==e.decay&&(i=!0,this.options.decay=Math.min(Math.max(e.decay,1e-4),this.options.time)),i&&this.buildImpulse()}buildImpulse(){let e=this.audioContext.sampleRate*this.options.time,t=this.audioContext.createBuffer(2,e,this.audioContext.sampleRate),i=t.getChannelData(0),s=t.getChannelData(1),a,n;for(n=0;n<e;n++)a=this.options.reverse?e-n:n,i[n]=(Math.random()*2-1)*Math.pow(1-a/e,this.options.decay),s[n]=(Math.random()*2-1)*Math.pow(1-a/e,this.options.decay);this.reverbNode.buffer!=null&&(this.inputGainNode.disconnect(this.reverbNode),this.reverbNode.disconnect(this.wetGainNode),this.reverbNode=this.audioContext.createConvolver(),this.inputGainNode.connect(this.reverbNode),this.reverbNode.connect(this.wetGainNode)),this.reverbNode.buffer=t}};S(rl,"typename",as);var no="BiquadFilterInsert",oo=class{constructor(e,t){S(this,"typename",oo.typename),S(this,"id",no),S(this,"automator",new Qt(["frequency","detune","Q","gain"])),S(this,"options"),S(this,"node"),this.node=e.createBiquadFilter(),this.id=t.id,this.options=Object.assign({id:t.id,detune:0,frequency:e.sampleRate/2,gain:0,Q:1,type:"lowpass"},t),this.node.Q.value=this.options.Q,this.node.detune.value=this.options.detune,this.node.frequency.value=this.options.frequency,this.node.gain.value=this.options.gain,this.node.type=this.options.type,this.automator.add("Q",this.node.Q),this.automator.add("detune",this.node.detune),this.automator.add("frequency",this.node.frequency),this.automator.add("gain",this.node.gain)}get input(){return this.node}get output(){return this.node}get getOptions(){return this.options}async modify(e,t,i){if(typeof e.Q=="number"&&(this.options.Q=H(e.Q,1e-4,1e3),this.node.Q.cancelScheduledValues(0),this.node.Q.linearRampToValueAtTime(this.options.Q,t)),typeof e.detune=="number"){let s=34028234663852886e22,a=-34028234663852886e22;this.options.detune=H(e.detune,a,s),this.node.detune.cancelScheduledValues(0),this.node.detune.linearRampToValueAtTime(this.options.detune,t)}if(typeof e.frequency=="number"){let s=i/2;this.options.frequency=H(e.frequency,10,s),this.node.frequency.cancelScheduledValues(0),this.node.frequency.exponentialRampToValueAtTime(this.options.frequency,t)}typeof e.gain=="number"&&(this.options.gain=H(e.gain,-40,40),this.node.gain.cancelScheduledValues(0),this.node.gain.linearRampToValueAtTime(this.options.gain,t)),e.type!==void 0&&e.type!==null&&Xd.includes(e.type)&&(this.node.type=this.options.type=e.type),await new Promise(s=>{setTimeout(()=>{s()},la((t-this.node.context.currentTime)*1e3,0))})}},ul=oo;S(ul,"typename",no);var ns="ReverbConvolverInsert",dl=class{constructor(e,t,i){if(S(this,"typename",ns),S(this,"id",ns),S(this,"automator",new Qt(["dry-gain","wet-gain"])),S(this,"soundHandler"),S(this,"options",{id:ns,normalize:!1,reverse:!1,impulseResponse:"none",mix:1}),S(this,"inputGainNode"),S(this,"outputGainNode"),S(this,"dryGainNode"),S(this,"wetGainNode"),S(this,"convolverNode"),this.soundHandler=i,this.inputGainNode=e.createGain(),this.convolverNode=e.createConvolver(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.inputGainNode.connect(this.convolverNode),this.convolverNode.connect(this.wetGainNode),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.wetGainNode.connect(this.outputGainNode),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain),this.id=t.id,t.impulseResponse===void 0){us().warn("[ecas] convolver reverb impulse file should be specified.");return}this.modify(t).catch(us().error)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}get audioParams(){return{dryGain:this.dryGainNode.gain,wetGain:this.wetGainNode.gain}}async modify(e,t=0){let i=!1;e.id!==void 0&&(this.options.id=this.id=e.id),e.mix!==void 0&&(this.options.mix=H(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(H(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(H(this.options.mix,1e-4,1),t)),e.normalize!==void 0&&this.options.normalize!==e.normalize&&(this.options.normalize=e.normalize,this.convolverNode.normalize=this.options.normalize,i=!0),e.reverse!==void 0&&this.options.reverse!==e.reverse&&(this.options.reverse=e.reverse,i=!0),e.impulseResponse!==void 0&&this.options.impulseResponse!==e.impulseResponse&&(i=!0,this.options.impulseResponse=e.impulseResponse),i&&await this.updateBuffer()}async updateBuffer(){let e=this.options.reverse?this.soundHandler.getAudioBufferReversed(this.options.impulseResponse):this.soundHandler.getAudioBuffer(this.options.impulseResponse);this.convolverNode.buffer=Ld(await e)}};S(dl,"typename",ns);var ro="DelayInsert",ll=class{constructor(e,t={id:"delay"}){S(this,"typename",ro),S(this,"automator",new Qt(["delayTime","feedback","dry-gain","wet-gain","cutoff"])),S(this,"options"),S(this,"inputGainNode"),S(this,"outputGainNode"),S(this,"dryGainNode"),S(this,"wetGainNode"),S(this,"feedbackGainNode"),S(this,"delayNode"),S(this,"filterNode"),this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.feedbackGainNode=e.createGain(),this.filterNode=e.createBiquadFilter(),this.filterNode.type="lowpass",this.delayNode=e.createDelay(t.maxDelayTime!==void 0?t.maxDelayTime:1),this.inputGainNode.connect(this.dryGainNode).connect(this.outputGainNode),this.inputGainNode.connect(this.delayNode).connect(this.wetGainNode).connect(this.outputGainNode),this.delayNode.connect(this.feedbackGainNode).connect(this.filterNode).connect(this.delayNode),this.options={id:t.id,feedback:.1,mix:1,delayTime:.3,maxDelayTime:1,cutoff:2e4},this.modify(Object.assign(this.options,t)).catch(us().error),this.automator.add("cutoff",this.filterNode.frequency),this.automator.add("delayTime",this.delayNode.delayTime),this.automator.add("feedback",this.feedbackGainNode.gain),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain)}get id(){return this.options.id}set id(e){this.options.id=e}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}async modify(e,t=0){e.delayTime!==void 0&&(this.options.delayTime=H(e.delayTime,0,this.options.maxDelayTime),this.delayNode.delayTime.cancelScheduledValues(0),this.delayNode.delayTime.linearRampToValueAtTime(this.options.delayTime,t)),e.feedback!==void 0&&(this.options.feedback=H(e.feedback,1e-4,1),this.feedbackGainNode.gain.cancelScheduledValues(0),this.feedbackGainNode.gain.exponentialRampToValueAtTime(this.options.feedback,t)),e.maxDelayTime!==void 0&&(this.options.maxDelayTime=H(e.maxDelayTime,0,10)),e.mix!==void 0&&(this.options.mix=H(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(H(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(this.options.mix,t)),e.id!==void 0&&(this.options.id=e.id),e.cutoff!==void 0&&(this.options.cutoff=H(e.cutoff,10,2e4),this.filterNode.frequency.exponentialRampToValueAtTime(this.options.cutoff,t)),await new Promise(i=>{setTimeout(()=>{i()},la((t-this.outputGainNode.context.currentTime)*1e3,0))})}};S(ll,"typename",ro);var aa="DynamicsCompressorInsert",hl=class{constructor(e,t){S(this,"typename",aa),S(this,"id",aa),S(this,"options"),S(this,"automator",new Qt(["threshold","ratio","attack","release","knee"])),S(this,"node"),S(this,"context"),this.context=e,this.id=t.id,this.options=ia({},t),this.node=e.createDynamicsCompressor(),this.automator.add("threshold",this.threshold),this.automator.add("ratio",this.ratio),this.automator.add("attack",this.attack),this.automator.add("release",this.release),this.automator.add("knee",this.knee),this.modify(t,0)}get attack(){return this.node.attack}get knee(){return this.node.knee}get ratio(){return this.node.ratio}get release(){return this.node.release}get threshold(){return this.node.threshold}get input(){return this.node}get output(){return this.node}get getOptions(){return this.options}async modify(e,t){typeof e.attack=="number"&&(this.attack.cancelScheduledValues(0),this.attack.linearRampToValueAtTime(H(e.attack,0,1),t)),typeof e.knee=="number"&&(this.knee.cancelScheduledValues(0),this.knee.linearRampToValueAtTime(H(e.knee,0,40),t)),typeof e.ratio=="number"&&(this.ratio.cancelScheduledValues(0),this.ratio.linearRampToValueAtTime(H(e.ratio,1,20),t)),typeof e.release=="number"&&(this.release.cancelScheduledValues(0),this.release.exponentialRampToValueAtTime(H(e.release,0,1),t)),typeof e.threshold=="number"&&(this.threshold.cancelScheduledValues(0),this.threshold.linearRampToValueAtTime(H(e.threshold,-100,0),t)),await new Promise(i=>{setTimeout(()=>{i()},la((t-this.context.currentTime)*1e3,0))})}};S(hl,"typename",aa);var os="PingPongDelayInsert",cl=class{constructor(e,t={id:os}){S(this,"typename",os),S(this,"id",os),S(this,"automator",new Qt(["dry-gain","wet-gain","delay-time-left","delay-time-right","feedback"])),S(this,"options"),S(this,"inputGainNode"),S(this,"outputGainNode"),S(this,"dryGainNode"),S(this,"wetGainNode"),S(this,"feedbackGainNode"),S(this,"delayNodeLeft"),S(this,"delayNodeRight"),S(this,"channelMerger"),this.options=Object.assign({feedback:.5,mix:.5,delayTime:.3,maxDelayTime:1},t),this.maxDelayTime=t.maxDelayTime!==void 0?t.maxDelayTime:1,this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.feedbackGainNode=e.createGain(),this.delayNodeLeft=e.createDelay(this.maxDelayTime),this.delayNodeRight=e.createDelay(this.maxDelayTime),this.channelMerger=e.createChannelMerger(2),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.delayNodeLeft.connect(this.channelMerger,0,0),this.delayNodeRight.connect(this.channelMerger,0,1),this.delayNodeLeft.connect(this.delayNodeRight),this.feedbackGainNode.connect(this.delayNodeLeft),this.delayNodeRight.connect(this.feedbackGainNode),this.inputGainNode.connect(this.feedbackGainNode),this.channelMerger.connect(this.wetGainNode),this.wetGainNode.connect(this.outputGainNode),this.id=t.id,this.automator.add("delay-time-left",this.delayNodeLeft.delayTime),this.automator.add("delay-time-right",this.delayNodeRight.delayTime),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain),this.automator.add("feedback",this.feedbackGainNode.gain)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}async modify(){await Promise.resolve(void 0)}get getOptions(){return this.options}get mix(){return this.options.mix}set mix(e){this.options.mix=e,this.dryGainNode.gain.value=Qd(this.mix),this.wetGainNode.gain.value=qd(this.mix)}get feedback(){return this.options.feedback}set feedback(e){e<0||e>1||(this.options.feedback=e,this.feedbackGainNode.gain.value=this.feedback)}get delayTime(){return this.options.delayTime}set delayTime(e){e<0||e>this.maxDelayTime||(this.options.delayTime=e,this.delayNodeLeft.delayTime.value=this.delayTime,this.delayNodeRight.delayTime.value=this.delayTime)}get maxDelayTime(){return this.options.maxDelayTime}set maxDelayTime(e){this.options.maxDelayTime=e}getPingPongDelayNodes(e){return e==="feedback"?this.feedbackGainNode:[this.delayNodeLeft,this.delayNodeRight]}getGeneratedGraph(){return{leftNode:this.inputGainNode,rightNode:this.outputGainNode}}};S(cl,"typename",os);var pl,ml,fl,gl,vl,yl;pl=new WeakMap,ml=new WeakMap,fl=new WeakMap,gl=new WeakMap,vl=new WeakMap,yl=new WeakMap;var bl,wl,Tl,Sl,Nl;bl=new WeakMap,wl=new WeakMap,Tl=new WeakMap,Sl=new WeakMap,Nl=new WeakMap;function Pl(e,t){if(In(e)){e();return}if(Ei(e)){t.triggerOnEndedEvent(e);return}K().warn("[ecas] invalid parameter type specified in onEnded.")}var El,$s,Al,xl,Qi,kl,Bs,Gl,Ml,Ol,Nn,Pn,En,An,Cl,_l;El=new WeakMap,$s=new WeakMap,Al=new WeakMap,xl=new WeakMap,Qi=new WeakMap,kl=new WeakMap,Bs=new WeakMap,Gl=new WeakMap,Ml=new WeakSet,Ol=function(e,t,i){let s=Se(t.id,t.parentId);St(this,Nn,Pn).call(this,e,t.parentId,t.soundSource,t.bussId,i),Z.clearTimeout(s),t.isLoop||(Z.clearTimeout(Se(s,Ie.STOP)),Z.clearTimeout(Se(s,Ie.DEFAULT_STOP))),g(this,Qi)[e]=g(this,Qi)[e].filter(a=>a.parentId!==t.parentId),Z.setTimeout(()=>{t.onEnded&&(g(this,Bs).triggerAudioEvent(ua.Sound.Ended,e),Pl(t.onEnded,g(this,Bs)))},i-this.now(),Se(s,Ie.SOUND_COMPLETE))},Nn=new WeakSet,Pn=function(e,t,i,s,a=0){let n=Se(e,t),r=g(this,$s)[n],u=i.source,d=i&&u&&u.buffer&&u.stop,h=p=>{St(this,En,An).call(this,p,e,t,i,s)};if(d)try{u.stop(a),r&&r.forEach(h),delete g(this,$s)[n]}catch(p){K().error(p)}},En=new WeakSet,An=function(e,t,i,s,a){this.removeSound(t,i,s,a),e.pannerNode.disconnect(),e.gainNode.disconnect(),e.sourceNode.disconnect(),e.audioEffectNodes&&e.audioEffectNodes.forEach(n=>{n.node.disconnect()})},Cl=new WeakSet,_l=function(e,t){let i=g(this,Qi)[e];return i?i.filter(s=>s.parentId===t):null};var Il=class{constructor(e){this.volume=1,this.pitch=0,this.pan=0,this.startTime=0,this.duration=0,this.startPos=0,this.loop=!1,this.args=[],this.onended=Xe,this.onplay=Xe,this.fadeIn=0,this.fadeOut=0,this.reverse=!1;var t,i,s;Object.assign(this,e),this.volume=(t=ne.randomizeValues(e.volume))!=null?t:1,this.pitch=(i=ne.randomizeValues(this.pitch))!=null?i:0,this.pan=(s=ne.randomizeValues(this.pan))!=null?s:0,ss(this.startTime)||(this.startTime=ne.defaultNumber(this.startTime)/1e3),ss(this.duration)||(this.duration=ne.defaultNumber(this.duration)/1e3),ss(this.startPos)||(this.startPos=ne.defaultNumber(this.startPos)/1e3)}},Rl=class{constructor(e={}){this.delay=0,this.fadeOut=1,Nt(e.fadeOut)&&(this.fadeOut=e.fadeOut),Nt(e.delay)&&(this.delay=e.delay/1e3),this.fadeOut=Math.max(this.fadeOut,1),this.onEnded=e.onEnded}};var xn,Dl,Xi,yt,bt,qe,He,Qe,Ti,Vl,Ll,kn,zs,Hl,Wl,Gn,qs,Yi,Ki,jl,Ul,wt,Mn,Tt,On,Fl,$l,Bl,zl,ql,Ql,Xl,Yl,Kl,Jl,Qs,Xs,Ys,Zl,eh,th,ih,sh,ah,Ji,Zi,nh,oh,rh,uh,dh,lh,hh,ch,ph,mh;xn=new WeakMap,Dl=new WeakMap,Xi=new WeakMap,yt=new WeakMap,bt=new WeakMap,qe=new WeakMap,He=new WeakMap,Qe=new WeakMap,Ti=new WeakMap,Vl=new WeakMap,Ll=new WeakMap,kn=new WeakMap,zs=new WeakMap,Hl=new WeakMap,Wl=new WeakMap,Gn=new WeakMap,qs=new WeakMap,Yi=new WeakMap,Ki=new WeakMap,jl=new WeakMap,Ul=new WeakMap,wt=new WeakMap,Mn=new WeakMap,Tt=new WeakMap,On=new WeakMap,Fl=new WeakSet,$l=function(e,t){let i=[Se(e,t,Ie.STOP),Se(e,Ie.VOLUME,t,Ie.STOP)];for(let s of i)Z.hasTimeout(s)&&(Z.clearTimeout(s),this.stopSound(e,new Rl,t))},Bl=new WeakSet,zl=function(e,t){let i=e.group,s=g(this,Tt).getGroup(i);if(s.limit>0&&g(this,He)[i]){let a=g(this,He)[i],n=g(this,Qe)[t];if(a.length>=s.limit){let r=a[0];if(r.soundSource.source){if(a.shift(),n.shift(),Z.clearTimeout(Ad({targetId:t,param:"volume",parentId:t,willStopSoundOnEnded:!0})),r.isFadingOut)return;r.soundSource.source.onended=Xe,r.soundSource.source.stop();return}}else if(g(this,Qe)&&g(this,Qe)[t]&&g(this,Qe)[t].length>=s.limit){let r=n[0];a.shift(),n.shift(),r.soundSource.source.onended=Xe,r.soundSource.source.stop()}}},ql=new WeakSet,Ql=function(e,t,i,s=[Xe]){g(this,qs)[t.id+t.parentId]=null;let a=t.id,n=t.group,r=n.id,u=ne.defaultNumber(t.delaySeconds);if(n.triggerLimit){let d=g(this,Yi)[r]?g(this,Yi)[r]:0,h=g(this,wt).now()-d,p=n.triggerLimit/1e3-h;if(h<0||p>0){K().debug("[ecas] group triggerLimit reached","triggerLimitElapsed",h,"triggerLimitRemain",p);return}g(this,Yi)[r]=i+u}if(e.triggerLimit){let d=g(this,Ki)[a]?g(this,Ki)[a]:0,h=i-d,p=e.triggerLimit/1e3-h;if(h<0||p>0){K().debug("[ecas] sound triggerLimit reached");return}g(this,Ki)[a]=i+u}n.limit&&n.limit>0&&(g(this,Qe)[a]==null&&(g(this,Qe)[a]=[]),g(this,He)[r]==null&&(g(this,He)[r]=[]),g(this,Qe)[a].push(t),g(this,He)[r].push(t)),_n(n.crossfade)&&(n.crossfade=10),Z.setTimeout(()=>{g(this,wt).playSound(a,t);for(let d of s)d()},t.startTimeSeconds-g(this,wt).now(),Ie.MIXER_PLAY_SOUND)},Xl=new WeakSet,Yl=function(e,t,i,s){e.onItemEnded&&St(this,Ji,Zi).call(this,e.onItemEnded),g(this,Qs).call(this,t.target,i,s)},Kl=new WeakSet,Jl=function(e,t,i,s,a={}){let n=g(this,Tt).getPool(e),r=ne.sumVolume(s.volume,ne.defaultNumber(a.volume,1)),u=ne.sumPan(s.pan,a.pan),d=ne.sumPitch(s.pitch,a.pitch),h=new Il({volume:r,pan:u,loop:s.loop||a.loop,pitch:d,onended:()=>{g(this,qe)[e+t]&&(g(this,qe)[e+t].counter--,g(this,qe)[e+t].counter===0&&(g(this,qe)[e+t].poolItems.forEach(v=>{v.onEnded&&St(this,Ji,Zi).call(this,v.onEnded)}),g(this,qe)[e+t].poolItems=[])),Z.clearTimeout(s.target+"_"+e),a.onItemEnded&&St(this,Ji,Zi).call(this,a.onItemEnded),g(this,Qs).call(this,s.target,e,t)},startTime:i.itemDelay,startPos:i.itemStartPos,duration:i.itemDuration}),p=g(this,Ti)[e];if(p||(p=[]),p.length>=n.limit){let v=p.shift();this.stopSound(v,null,e)}p.push(s.target),g(this,qe)[e+t].counter++,g(this,qe)[e+t].poolItems.push(a),this.playSound(s.target,h,e),g(this,Ti)[e]=p},Qs=new WeakMap,Xs=new WeakSet,Ys=function(e,t,i,s){let a=Ed({type:"sound",param:"volume",startTime:0,envelopePoints:[{pos:0,val:"current"},{pos:e.fadeOut,val:0}],curveType:"logarithmic",onEnded:()=>{let n=g(this,Tt).soundHandler.getSound(t);g(this,wt).stopSound(t,i,s+e.fadeOut/1e3,e.onEnded),g(this,Qe)[t]=[],g(this,He)[n.group]=g(this,He)[n.group].filter(r=>r.id!==n.id)},willStopSoundOnEnded:!0});this.playEnvelope(t,a,i)},Zl=new WeakSet,eh=function(e,t,i,s,a,n){let r=Se(i,s,Ie.STOP),u=e-.03,d=Se(i,s,Ie.DEFAULT_STOP);a||(Z.hasTimeout(d)?Z.clearTimeout(d):d=r),Z.setTimeout(()=>St(this,Xs,Ys).call(this,t,i,s,n),u,d)},th=new WeakSet,ih=function(e,t,i,s){let a=g(this,qs)[t+i];if(oa(a)){g(this,xn).cancelScheduledSound(a);return}St(this,Xs,Ys).call(this,e,t,i,s)},sh=new WeakSet,ah=function(e,t,i){if(g(this,zs)[t+i]){e.forEach(a=>{switch(a.type){case"pattern":this.resumePattern(a.target,0,t);break;case"pool":this.resumePool(a.target,0,t);break;case"sound":this.resumeSound(a.target,0,t);break;default:K().warn("[ecas] Sequencer._resumePausePoolItems; item.type not set");break}}),delete g(this,zs)[t+i];let s=g(this,kn)[t+i];for(let a=0;a<s;a++)Z.resume(Se(t,Ie.POOL_PLAY,a.toString()));return}this.stopPool(t),this.playPool(t,g(this,Gn)[t+i])},Ji=new WeakSet,Zi=function(e){if(In(e)){e();return}if(Ei(e)){g(this,Mn).triggerOnEndedEvent(e);return}K().debug("[ecas] invalid parameter type specified in onEnded.")},nh=new WeakSet,oh=function(e,t){K().debug("[ecas] purge sound",e,t);let i=g(this,Tt).soundHandler.getSound(e),s=g(this,He)[i.group];if(s){let a=s.filter(n=>!(n.id===e&&n.parentId===t));g(this,He)[i.group]=a,g(this,Ti)[t]&&g(this,Ti)[t].pop()}},rh=new WeakSet,uh=function(e,t){if(!g(this,Tt).hasPool(e))return K().warn("[ecas] unable to play pool with id '"+e+"'."),null;let i=g(this,yt)[e].length,s=g(this,Tt).getPool(e).type;(t||g(this,bt)[e]>=i)&&(g(this,bt)[e]=0,s==="random"&&(g(this,yt)[e]=ne.randomShuffle(g(this,yt)[e])));let a=g(this,yt)[e][g(this,bt)[e]];return g(this,bt)[e]++,a.pan=a.pan||0,a},dh=new WeakSet,lh=function(e){Bi(this,yt,{}),Bi(this,bt,{}),Bi(this,qe,{});for(let t of e){let i=[];t.items.forEach((s,a)=>{if(t.priority){let n=t.priority[a];for(let r=0;r<n;r++)i.push(s)}else i.push(s)}),g(this,yt)[t.id]=t.type==="random"?ne.randomShuffle(i):i,g(this,bt)[t.id]=0}},hh=new WeakSet,ch=function(e,t,i,s=0){let a=null,n=null,r=g(this,wt).now();if(t=t||e.parentId,e.sound)a=e.sound,n=d=>{i.startTime=d,this.playSound(a,i,t,!1,s>0)};else if(e.pattern)a=e.pattern,n=d=>{i.startTime=d,this.playPattern(a,i,e.parentId)};else if(e.pool)a=e.pool,n=d=>{i.startTime=d,this.playPool(a,i,e.parentId)};else if(e.envelope&&Pd(i)){a=e.envelope;let d=e.bussId||e.soundId;n=h=>{i.startTime=h,this.playEnvelope(d,i,t)}}else{K().warn("[ecas] attempting to schedule unknown pattern item type. Item: ",e);return}let u=ne.defaultNumber(i.startTime,0,g(this,On),r);if(u===0)n(u);else{let d={eventMethod:n,loopLength:s,startTime:u,id:a,parentId:t};g(this,Xi).push(d)}},ph=new WeakSet,mh=function(){let e=g(this,wt).now(),t=[];Bi(this,Xi,g(this,Xi).filter(i=>{let s=i.loopLength>0,a=e+.03;return i.startTime<=a?(t.push({method:i.eventMethod,startTime:i.startTime}),s&&(i.startTime+=i.loopLength),s):!0})),t.forEach(i=>i.method(i.startTime))};var fh,Cn,gh,vh,yh,bh,wh,Th,Sh;fh=new WeakMap,Cn=new WeakMap,gh=new WeakMap,vh=new WeakMap,yh=new WeakMap,bh=new WeakMap,wh=new WeakMap,Th=new WeakSet,Sh=function(e=0){return g(this,Cn).currentTime+.03+Math.max(e,0)};var Nh=Object.defineProperty,Ph=(e,t,i)=>t in e?Nh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Pt=(e,t,i)=>(Ph(e,typeof t!="symbol"?t+"":t,i),i),Eh=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},Ai=(e,t,i)=>(Eh(e,t,"read from private field"),i?i.call(e):t.get(e)),Ah=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)},xh=Object.defineProperty,kh=Object.defineProperties,Gh=Object.getOwnPropertyDescriptors,Os=Object.getOwnPropertySymbols,Io=Object.prototype.hasOwnProperty,Ro=Object.prototype.propertyIsEnumerable,uo=(e,t,i)=>t in e?xh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,C=(e,t)=>{for(var i in t||(t={}))Io.call(t,i)&&uo(e,i,t[i]);if(Os)for(var i of Os(t))Ro.call(t,i)&&uo(e,i,t[i]);return e},Re=(e,t)=>kh(e,Gh(t)),Xt=(e,t)=>{var i={};for(var s in e)Io.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(e!=null&&Os)for(var s of Os(e))t.indexOf(s)<0&&Ro.call(e,s)&&(i[s]=e[s]);return i},en=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},o=(e,t,i)=>(en(e,t,"read from private field"),i?i.call(e):t.get(e)),f=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)},P=(e,t,i,s)=>(en(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),M=(e,t,i)=>(en(e,t,"access private method"),i),Mh=Object.defineProperty,Oh=(e,t,i)=>t in e?Mh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,ki=(e,t,i)=>(Oh(e,typeof t!="symbol"?t+"":t,i),i);function Et(){}var Ch={typename:"none",debug:Et,log:Et,info:Et,warn:Et,error:Et,table:Et,trace:Et},ds=_h;function _h(){return Ch}var Ih=Object.defineProperty,Rh=(e,t,i)=>t in e?Ih(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,ga=(e,t,i)=>(Rh(e,typeof t!="symbol"?t+"":t,i),i),Dh=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},Ne=(e,t,i)=>(Dh(e,t,"read from private field"),i?i.call(e):t.get(e)),Vh=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)};function Lh(e=navigator.userAgent){return e.includes("Firefox")}var Hh=class extends Error{constructor(){super(...arguments),ga(this,"name","StrictMapError")}},oe,Do,Vo,lo=class{constructor(){Vh(this,oe,new Map),ga(this,Do,"StrictMap"),ga(this,Vo,Ne(this,oe).entries())}get(e){if(!Ne(this,oe).has(e))throw new Hh(`Key: '${e}' does not exist.`);return Ne(this,oe).get(e)}set(e,t){return Ne(this,oe).set(e,t),this}forEach(e,t){Ne(this,oe).forEach(e,t)}clear(){Ne(this,oe).clear()}delete(e){return Ne(this,oe).delete(e)}entries(){return Ne(this,oe).entries()}has(e){return Ne(this,oe).has(e)}keys(){return Ne(this,oe).keys()}size(){return Ne(this,oe).size}values(){return Ne(this,oe).values()}};Do=Symbol.toStringTag,Vo=Symbol.iterator,oe=new WeakMap;function ha(e){return(...t)=>{try{return[null,e(...t)]}catch(i){return[i,null]}}}var Wh=class extends Error{constructor(){super(...arguments),ki(this,"name","AutomatorError")}},jh=class{constructor(e){ki(this,"AutomatableParameters"),ki(this,"audioParams",new lo),ki(this,"defaults",new lo),ki(this,"firefoxHacks",new Map),this.AutomatableParameters=e}automate({paramId:e,valueCurve:t,when:i,duration:s}){ds().debug("[ecas] automate",{paramId:e,valueCurve:t,when:i,duration:s});let a=this.audioParams.get(e);if(a.cancelAndHoldAtTime(0),Lh()){this.firefoxHack({paramId:e,valueCurve:t,when:i,duration:s,audioParam:a});return}let[n]=ha(()=>a.setValueCurveAtTime(t,i,s))();if(n===null)return;ds().log("[ecas]: failed to override scheduled valueCurve. Using a linear ramp to the end value instead.",n),a.cancelAndHoldAtTime(0);let r=t.at(-1);if(r!==void 0){let[u]=ha(()=>a.linearRampToValueAtTime(r,i+s))();u!==null&&ds().log("[ecas]: failed to schedule linearRampToValueAtTime that was used as a fallback when the valueCurve failed.",u)}}firefoxHack({paramId:e,audioParam:t,valueCurve:i,when:s,duration:a}){var n;let r=(n=this.firefoxHacks.get(e))!=null?n:[],u=[],d=i.length,h=a/d;for(let p of r)window.clearTimeout(p);this.firefoxHacks.set(e,u);for(let[p,v]of i.entries()){let E=p*h,x=E*1e3;u.push(window.setTimeout(()=>{t.cancelAndHoldAtTime(0);let[_]=ha(()=>t.linearRampToValueAtTime(v,s+E-.3))();_!==null&&ds().log("[ecas]: (automator) failed to set linearRamp",_)},x))}}add(e,t,i){if(this.audioParams.has(e))throw new Wh(`AudioParam with id ${e} has already been added.`);this.set(e,t),i!=null?this.setDefault(e,i):this.setDefault(e,t.value)}cancel({paramId:e,when:t}){this.audioParams.get(e).cancelScheduledValues(t)}get(e){return this.audioParams.get(e)}set(e,t){this.audioParams.set(e,t)}current(e){return this.audioParams.get(e).value}getDefault(e){return this.defaults.get(e)}setDefault(e,t){this.defaults.set(e,t)}dispose(){this.audioParams.clear()}};function Lo(e){let t=0;for(let i of e)t+=i;return t}function ho(e=1,t=10,i=10){let s=d=>d>0?Math.log10(d):Math.log10(1e-5),a=s(e),n=(s(t)-a)/(i-1),r=new Float32Array(i),u=a;r[0]=e;for(let d=1;d<i-1;d++)u+=n,r[d]=Math.pow(10,u);return r[i-1]=t,r}function Uh(e=1,t=10,i=10){let s=(t-e)/(i-1),a=new Float32Array(i),n=e;for(let r=0;r<i;r++)a[r]=n,n+=s;return a[0]=e,a[a.length-1]=t,a}function Fh(e=1,t=0,i=10){let s=Math.PI/2,a=new Float32Array(i);for(let r=0;r<i;r++){let u=Math.PI*r/(i-1)-s;a[r]=Math.sin(u)/2+.5}let n=t-e;for(let r=0;r<i;r++){let u=a[r];u!==void 0&&(a[r]=u*n+e)}return a}function $h(e,t,i){let s=Lo(t),a=new Float32Array(s),n=e[0],r=0;for(let u=0;u<e.length;u++){let d=t[u],h=e[u];if(n!==void 0&&d!==void 0&&h!==void 0){let p=i(n,h,d);a.set(p,r),r+=d,n=e[u]}}return a}function Bh(e){return{linear:Uh,exponential:ho,logarithmic:ho,"s-curve":Fh}[e]}function zh(e){let{values:t,positions:i,curveType:s}=e,a=qh(i),n=Bh(s);return $h(t,a,n)}function qh(e){return e.map(t=>Math.floor(Math.max(t*.25,2)))}var Qh={linear(e){return ls("linear",e)},logarithmic(e){return ls("logarithmic",e)},exponential(e){return ls("exponential",e)},"s-curve"(e){return ls("s-curve",e)}};function ls(e,[t,i]){return[zh({curveType:e,values:t,positions:i}),Lo(i)/1e3]}var Xh=Object.defineProperty,co=Object.getOwnPropertySymbols,Yh=Object.prototype.hasOwnProperty,Kh=Object.prototype.propertyIsEnumerable,va=(e,t,i)=>t in e?Xh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Jh=(e,t)=>{for(var i in t||(t={}))Yh.call(t,i)&&va(e,i,t[i]);if(co)for(var i of co(t))Kh.call(t,i)&&va(e,i,t[i]);return e},Pe=(e,t,i)=>(va(e,typeof t!="symbol"?t+"":t,i),i);function he(){}var tn={typename:"none",debug:he,log:he,info:he,warn:he,error:he,table:he,trace:he},l=Zh;function Zh(){return tn}function ec(e){tn=e}function ya(e){tn=tc(e)}function tc(e){switch(e){case"console":return nc();case"timestamp":return oc();case"none":default:return rc()}}function ic(){var e;ya((e=Ho())!=null?e:"none")}function Ho(){let e=new URLSearchParams(window.location.search),t=sc(e);return Wo(t)?t:null}function sc(e){var t;return(t=e.get("ecas-logger"))!=null?t:e.get("ecasLogger")}function Wo(e){return e==="none"||e==="console"||e==="timestamp"}function ac(){return Wo(Ho())}function nc(){return Jh({typename:"console"},console)}function oc(){return new class{constructor(){Pe(this,"typename","timestamp"),Pe(this,"start",performance.now()),Pe(this,"now",()=>performance.now()-this.start),Pe(this,"seconds",()=>this.now()/1e3),Pe(this,"format",(...e)=>[`Time: ${this.seconds().toFixed(2)}`,...e]),Pe(this,"debug",(...e)=>{console.debug(...this.format(...e))}),Pe(this,"log",(...e)=>{console.log(...this.format(...e))}),Pe(this,"info",(...e)=>{console.log(...this.format(...e))}),Pe(this,"warn",(...e)=>{console.warn(...this.format(...e))}),Pe(this,"error",(...e)=>{console.error(...this.format(...e))}),Pe(this,"table",(...e)=>{console.table(...this.format(...e))}),Pe(this,"trace",(...e)=>{console.trace(...this.format(...e))})}}}function rc(){return{typename:"none",debug:he,log:he,info:he,warn:he,error:he,table:he,trace:he}}var uc=Object.defineProperty,dc=(e,t,i)=>t in e?uc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Cs=(e,t,i)=>(dc(e,typeof t!="symbol"?t+"":t,i),i),lc=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},Ee=(e,t,i)=>(lc(e,t,"read from private field"),i?i.call(e):t.get(e)),hc=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)};function cc(e){return[...new Set(e)]}function jo(e){let t=0;for(let i of e)t+=i;return t}var pc=Object.keys;function Y(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function F(e,t,i){Object.defineProperty(e,t,i)}function mc(e,t){return Object.getOwnPropertyDescriptor(e,t)}function fc(e){return Object.getOwnPropertyNames(e)}function Lt(e,t,i){return Math.min(Math.max(e,t),i)}var po=class extends Error{constructor(){super(...arguments),Cs(this,"name","AssertionError")}};function Je(e,t){if(!e)throw X(t)?new po(t):(t==null?void 0:t.Err)!==void 0?new t.Err(t.msg):new po(t==null?void 0:t.msg)}function gc(e,t){Je(ye(e),{msg:t!=null?t:`thing typeof ${typeof e} is not typeof number.`})}function vc(e,t){Je(Ze(e),{msg:t!=null?t:"thing is undefined"})}function yc(e,t){Je(!Ws(e),{msg:t!=null?t:"thing is null"})}function Uo(e,t){vc(e,t),yc(e,t)}function bc(e,t){Je(!wc(e),{msg:t!=null?t:"thing is empty."})}function q(e,t){return Uo(e,t),e}function Ze(e){return!mi(e)}function mi(e){return e===void 0}function wc(e){return Object.keys(e).length===0}function Tc(e){return!Ws(e)}function ut(e){return Ze(e)&&Tc(e)}function Ws(e){return e===null}function jt(e){return typeof e=="object"&&!Ws(e)}function Ut(e){return Array.isArray(e)}function Sc(e){return e===!0}function Fo(e){return e.length===0}function Nc(e){return!Fo(e)}function $o(e){return Array.isArray(e)&&e.length>0}function ye(e){return typeof e=="number"&&!isNaN(e)}function sn(e){return typeof e=="function"}function X(e){return typeof e=="string"}function Q(e){return ye(e)?!0:X(e)?Bo(e):!1}function Bo(e){return!isNaN(parseFloat(e))}function ba(e){return Ut(e)?e.map(t=>ba(t)):e instanceof Date?new Date(e.getTime()):jt(e)?fc(e).reduce((t,i)=>{let s=mc(e,i);return F(t,i,s),t[i]=ba(e[i]),t},Object.create(Object.getPrototypeOf(e))):e}function wa(e){return ba(e)}function Pc(e){return Object.values(e)}function At(...e){return e}function mo(e,...t){if(t.length===0)return e;let i=e.endsWith("/")?e.slice(0,-1):e;return i.startsWith("http")?[i,t.map(s=>s.replace(/\/+/g,"")).join("/")].join("/"):[i,...t].join("/").replace(/\/+/g,"/")}function ce(){}var Ec=class extends Error{constructor(){super(...arguments),Cs(this,"name","StrictMapError")}},re,zo,qo,Ac=class{constructor(){hc(this,re,new Map),Cs(this,zo,"StrictMap"),Cs(this,qo,Ee(this,re).entries())}get(e){if(!Ee(this,re).has(e))throw new Ec(`Key: '${e}' does not exist.`);return Ee(this,re).get(e)}set(e,t){return Ee(this,re).set(e,t),this}forEach(e,t){Ee(this,re).forEach(e,t)}clear(){Ee(this,re).clear()}delete(e){return Ee(this,re).delete(e)}entries(){return Ee(this,re).entries()}has(e){return Ee(this,re).has(e)}keys(){return Ee(this,re).keys()}size(){return Ee(this,re).size}values(){return Ee(this,re).values()}};zo=Symbol.toStringTag,qo=Symbol.iterator,re=new WeakMap;function Ta(e){return async(...t)=>{try{return[null,await e(...t)]}catch(i){return[i,null]}}}function Qo(e){return(...t)=>{try{return[null,e(...t)]}catch(i){return[i,null]}}}var xc="2.1.2",kc=()=>typeof navigator!="undefined",Gc=e=>(e!=null?e:kc())&&/chrome|firefox/i.test(navigator==null?void 0:navigator.userAgent.toLowerCase()),Mc=(e,t)=>{let i=`\u{1F3B5} ECAS: v${e} \u{1F3B5}`;if(t)return[`
%c${i}%c

`,"color: #FFFFFF; background: #ff7373; padding:10px","padding:0"];{let s=i.split("").map(()=>".").join("");return[`${s}
${i}
${s}`]}},Oc=e=>{e(...Mc(xc,Gc()))},We,Cc=class{constructor(){f(this,We,new Ac)}on(e,t){o(this,We).has(e)?o(this,We).get(e).push(t):o(this,We).set(e,[t])}off(e,t){if(!o(this,We).has(e))return l().error(`[ecas] cannot remove event: ${e} since it does not exist`),!1;let i=o(this,We).get(e),s=i.filter(a=>a!==t);return s.length!==i.length?(o(this,We).set(e,s),!0):!1}emit(e,...t){if(o(this,We).has(e))for(let i of o(this,We).get(e))i(...t)}};We=new WeakMap;var hs="genesis",_c=class{constructor(e,t){this._states=new Map,this._activeStateName=this.getInitialStateName(t);let i=hs,s=(n,r="",u="",d="::")=>{let h=n.children;i=r?`${i}${d}${r}`:i,this.addState(i,n,u);for(let p in h){let v=q(h[p],`StateHandler.constructor.iter(); child state with name ${p} does not exist in children.`);s(v,p,i)}i=i.slice(0,i.length-r.length-d.length)},a=q(e[hs],`StateHandler.constructor(); state_config[${hs}] does not exist in audio-states.`);s(a),this._activeState=q(this._states.get(this._activeStateName),`activeStateName: ${this._activeStateName} does not exist in strarr([...this._states.keys()])}`),this.saveStateToLocalStorage(this._activeStateName),l().table("[ecas] states:"),l().table([...this._states.keys()])}dispose(){this.states.clear()}get states(){return this._states}getInitialStateName(e){let t=this.readStateNameFromLocalStorage();return t!==null&&this._states.has(t)?t:e.initState?e.initState:hs}readStateNameFromLocalStorage(){let e=localStorage.getItem("ECAS_AUDIO_STATE");return l().debug(`[ecas] read state ${e} from localStorage`),e}saveStateToLocalStorage(e){l().debug("[ecas] save state to localstorate",e);let t="ECAS_AUDIO_STATE";localStorage.setItem(t,e)}addState(e,t,i=""){let s=Re(C({},t),{parent:i});if(Je(!this._states.has(e),"[ecas] cannot add the state since it already exist on the same level.. E.g Another state with the same name and iheritance was already added."),i){let a=q(this._states.get(i),`[ecas] state.parent = ${i} does not exist on name: ${e}. Existing states are: ${[...this._states.keys()]}}`);Uo(a.children,`[ecas] parent_state.children does not exist in: ${a}`),bc(a.children,`[ecas] parent_state.children is empty in ${a}`),s.events=C(C({},this.getState(i).events),s.events)}this._states.set(e,s)}triggerStateChange(e,...t){l().debug("[ecas] trigger state change",e,...t),this._shouldChangeState(this._activeState.deactivatesOn,e,t)&&this.changeState(this._activeState.parent);for(let i in this._activeState.children){let s=q(this._activeState.children[i],`[ecas] child: ${i} does not exist in states.`);if(this._shouldChangeState(s.activatesOn,e,t)){this.changeState(`${this._activeStateName}::${i}`);break}}}changeState(e){l().info(`[ecas] moving from state: ${this._activeStateName} to ${e}`),this._activeState=q(this._states.get(e),`[ecas] could not find state: ${e}`),this._activeStateName=e,this.saveStateToLocalStorage(this._activeStateName)}get activeStateName(){return this._activeStateName}_shouldChangeState(e,t,i=[]){return e.filter(s=>{if(jt(s)){let a=s.event===t,n=s.values.every(r=>i.includes(r));return a&&n}return s===t}).length>0}get activeState(){return q(this._states.get(this._activeStateName),`[ecas] supposedly active state: ${this._activeStateName} not found in states.`)}getState(e){return q(this._states.get(e),`[ecas] state ${e} does not exist`)}get state(){return this._activeStateName}},Ic=Object.defineProperty,Rc=(e,t,i)=>t in e?Ic(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,m=(e,t,i)=>(Rc(e,typeof t!="symbol"?t+"":t,i),i),ot={min:"min",max:"max",in:"in",out:"out",param:"param"},J=(e=>(e.CAF=".caf",e.WEBM=".webm",e.MP4=".mp4",e.OGG=".ogg",e.MP3=".mp3",e.WAV=".wav",e))(J||{}),Dc="BusConfig",Xo=class{constructor(e={}){m(this,"typename",Xo.typename),m(this,"id","mainBus"),m(this,"volume",1),m(this,"pan",0),m(this,"destination",Lp),Object.assign(this,e)}},_s=Xo;m(_s,"typename",Dc);var Vc=_s,Lc=class{constructor(e={}){m(this,"id","mainGroup"),m(this,"format","mainFormat"),m(this,"bus","master"),m(this,"limit",Number.MAX_SAFE_INTEGER),m(this,"crossfade",10),m(this,"triggerLimit",0),Object.assign(this,e)}},Hc=Lc,Wc=class{constructor(e={}){m(this,"pos",0),m(this,"val","current"),Object.assign(this,e)}},jc=class{constructor(e={}){m(this,"id",""),m(this,"param","volume"),m(this,"data",[]),m(this,"busId"),Object.assign(this,e),e.data!=null&&(this.data=e.data.map(t=>new Wc(t)))}},Uc=class{constructor(e={}){m(this,"sound"),m(this,"sequence"),m(this,"parentId"),m(this,"loop",!1),m(this,"volume",1),m(this,"args",[]),m(this,"pan",0),m(this,"pitch",0),m(this,"startPos",0),m(this,"delay",0),m(this,"duration"),m(this,"envelope"),m(this,"bussId"),m(this,"soundId"),m(this,"pattern"),m(this,"pool"),Object.assign(this,e);function t(i){return i!==void 0&&typeof i!="string"}t(e.envelope)&&(this.envelope=new jc(e.envelope))}},Fc=class{constructor(e={}){m(this,"id",""),m(this,"sync"),m(this,"pattern",[]),m(this,"tempo"),m(this,"triggerQuantize",1),m(this,"timeSignature"),Object.assign(this,e),e.pattern!==void 0&&e.pattern!==null&&(this.pattern=e.pattern.map(t=>new Uc(t)))}},$c=Fc,Bc=class{constructor(e={}){m(this,"target",""),m(this,"type","sound"),m(this,"loop",!1),m(this,"volume",1),m(this,"pan",0),m(this,"pitch",0),m(this,"delay",0),m(this,"startPos",0),m(this,"duration"),Object.assign(this,e)}},zc=class{constructor(e={}){m(this,"id",""),m(this,"items",[]),m(this,"type","sequential"),m(this,"priority"),m(this,"limit",100),Object.assign(this,e),e.items!=null&&(this.items=e.items.map(t=>new Bc(t)))}},qc=zc,Qc=class{constructor(e={}){m(this,"format","webm"),m(this,"bitrate",128),m(this,"channels",2),Object.assign(this,e)}},Xc=class{constructor(e={}){m(this,"id",""),m(this,"formats",[]),Object.assign(this,e),e.formats!=null&&(this.formats=e.formats.map(t=>new Qc(t)))}},Sa=class{constructor(e={}){m(this,"package","default"),m(this,"presets",[]),Object.assign(this,e),e.presets!=null&&(this.presets=e.presets.map(t=>new Xc(t)))}},Yc=class{constructor(e={}){m(this,"sourcePaths",[]),m(this,"targetPath","sounds"),m(this,"loadPath","sounds"),m(this,"formatPresets"),m(this,"tempo",120),m(this,"triggerQuantize",1),m(this,"patternQuantize",1),m(this,"timeSignature","4/4"),Object.assign(this,e),e.formatPresets!=null?this.formatPresets=e.formatPresets.map(t=>new Sa(t)):this.formatPresets=Kc()}};function Kc(){return[new Sa({package:"desktop",presets:[{id:"mainFormat",formats:[{format:"webm",bitrate:112,channels:2},{format:"mp4",bitrate:112,channels:2}]},{id:"effectsFormat",formats:[{format:"webm",bitrate:112,channels:2},{format:"mp4",bitrate:112,channels:2}]}]}),new Sa({package:"mobile",presets:[{id:"mainFormat",formats:[{format:"webm",bitrate:64,channels:1},{format:"mp4",bitrate:64,channels:1}]},{id:"effectsFormat",formats:[{format:"webm",bitrate:64,channels:1},{format:"mp4",bitrate:64,channels:1}]}]})]}var fo=Yc,Jc=class{constructor(e={}){m(this,"speed",1),m(this,"pitch",1),Object.assign(this,e)}},go=Jc,Yo="sound",Ko=class{constructor(e={}){m(this,"typename",Yo),m(this,"id",""),m(this,"group","mainGroup"),m(this,"type","buffer"),m(this,"triggerLimit",0),m(this,"pitch",0),m(this,"pan",0),m(this,"volume",1),m(this,"encoding",new go),Object.assign(this,e),e.encoding!=null&&(this.encoding=new go(e.encoding))}};m(Ko,"typename",Yo);var Zc=Ko,vo=class{constructor(e={}){m(this,"settings",new fo),m(this,"buses",[]),m(this,"groups",[]),m(this,"sounds",[]),m(this,"patterns",[]),m(this,"pools",[]);var t,i,s,a,n,r,u,d,h,p;this.settings=new fo(e.settings),this.buses=(i=(t=e.buses)==null?void 0:t.map(v=>new Vc(v)))!=null?i:[],this.groups=(a=(s=e.groups)==null?void 0:s.map(v=>new Hc(v)))!=null?a:[],this.sounds=(r=(n=e.sounds)==null?void 0:n.map(v=>new Zc(v)))!=null?r:[],this.patterns=(d=(u=e.patterns)==null?void 0:u.map(v=>new $c(v)))!=null?d:[],this.pools=(p=(h=e.pools)==null?void 0:h.map(v=>new qc(v)))!=null?p:[]}},ep=Object.defineProperty,yo=Object.getOwnPropertySymbols,tp=Object.prototype.hasOwnProperty,ip=Object.prototype.propertyIsEnumerable,Na=(e,t,i)=>t in e?ep(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Pa=(e,t)=>{for(var i in t||(t={}))tp.call(t,i)&&Na(e,i,t[i]);if(yo)for(var i of yo(t))ip.call(t,i)&&Na(e,i,t[i]);return e},N=(e,t,i)=>(Na(e,typeof t!="symbol"?t+"":t,i),i);function xt(){}var sp={typename:"none",debug:xt,log:xt,info:xt,warn:xt,error:xt,table:xt,trace:xt},Is=ap;function ap(){return sp}var np=Object.defineProperty,op=(e,t,i)=>t in e?np(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,rp=(e,t,i)=>(op(e,typeof t!="symbol"?t+"":t,i),i);function an(e,t){return Math.max(e,t)}function W(e,t,i){return Math.min(Math.max(e,t),i)}var bo=class extends Error{constructor(){super(...arguments),rp(this,"name","AssertionError")}};function Jo(e,t){if(!e)throw Zo(t)?new bo(t):(t==null?void 0:t.Err)!==void 0?new t.Err(t.msg):new bo(t==null?void 0:t.msg)}function up(e,t){Jo(cp(e),{msg:t!=null?t:"thing is undefined"})}function dp(e,t){Jo(!mp(e),{msg:t!=null?t:"thing is null"})}function lp(e,t){up(e,t),dp(e,t)}function hp(e,t){return lp(e,t),e}function cp(e){return!pp(e)}function pp(e){return e===void 0}function mp(e){return e===null}function fp(e){return typeof e=="number"&&!isNaN(e)}function Zo(e){return typeof e=="string"}function er(e){return fp(e)?!0:Zo(e)?gp(e):!1}function gp(e){return!isNaN(parseFloat(e))}var vp,yp,bp;yp=Symbol.toStringTag,bp=Symbol.iterator,vp=new WeakMap;function wp(e){return!er(e)||e>1||e<0?0:e>=.5?1:1-(.5-e)*2}function Tp(e){return!er(e)||e>1||e<0?0:e<=.5?1:1-(e-.5)*2}var Sp=["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"],Np=Object.defineProperty,Pp=(e,t,i)=>t in e?Np(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Gi=(e,t,i)=>(Pp(e,typeof t!="symbol"?t+"":t,i),i);function kt(){}var Ep={typename:"none",debug:kt,log:kt,info:kt,warn:kt,error:kt,table:kt,trace:kt},cs=Ap;function Ap(){return Ep}var xp=Object.defineProperty,kp=(e,t,i)=>t in e?xp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ea=(e,t,i)=>(kp(e,typeof t!="symbol"?t+"":t,i),i),Gp=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},Ae=(e,t,i)=>(Gp(e,t,"read from private field"),i?i.call(e):t.get(e)),Mp=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)};function Op(e=navigator.userAgent){return e.includes("Firefox")}var Cp=class extends Error{constructor(){super(...arguments),Ea(this,"name","StrictMapError")}},ue,tr,ir,wo=class{constructor(){Mp(this,ue,new Map),Ea(this,tr,"StrictMap"),Ea(this,ir,Ae(this,ue).entries())}get(e){if(!Ae(this,ue).has(e))throw new Cp(`Key: '${e}' does not exist.`);return Ae(this,ue).get(e)}set(e,t){return Ae(this,ue).set(e,t),this}forEach(e,t){Ae(this,ue).forEach(e,t)}clear(){Ae(this,ue).clear()}delete(e){return Ae(this,ue).delete(e)}entries(){return Ae(this,ue).entries()}has(e){return Ae(this,ue).has(e)}keys(){return Ae(this,ue).keys()}size(){return Ae(this,ue).size}values(){return Ae(this,ue).values()}};tr=Symbol.toStringTag,ir=Symbol.iterator,ue=new WeakMap;function ca(e){return(...t)=>{try{return[null,e(...t)]}catch(i){return[i,null]}}}var _p=class extends Error{constructor(){super(...arguments),Gi(this,"name","AutomatorError")}},fi=class{constructor(e){Gi(this,"AutomatableParameters"),Gi(this,"audioParams",new wo),Gi(this,"defaults",new wo),Gi(this,"firefoxHacks",new Map),this.AutomatableParameters=e}automate({paramId:e,valueCurve:t,when:i,duration:s}){cs().debug("[ecas] automate",{paramId:e,valueCurve:t,when:i,duration:s});let a=this.audioParams.get(e);if(a.cancelAndHoldAtTime(0),Op()){this.firefoxHack({paramId:e,valueCurve:t,when:i,duration:s,audioParam:a});return}let[n]=ca(()=>a.setValueCurveAtTime(t,i,s))();if(n===null)return;cs().log("[ecas]: failed to override scheduled valueCurve. Using a linear ramp to the end value instead.",n),a.cancelAndHoldAtTime(0);let r=t.at(-1);if(r!==void 0){let[u]=ca(()=>a.linearRampToValueAtTime(r,i+s))();u!==null&&cs().log("[ecas]: failed to schedule linearRampToValueAtTime that was used as a fallback when the valueCurve failed.",u)}}firefoxHack({paramId:e,audioParam:t,valueCurve:i,when:s,duration:a}){var n;let r=(n=this.firefoxHacks.get(e))!=null?n:[],u=[],d=i.length,h=a/d;for(let p of r)window.clearTimeout(p);this.firefoxHacks.set(e,u);for(let[p,v]of i.entries()){let E=p*h,x=E*1e3;u.push(window.setTimeout(()=>{t.cancelAndHoldAtTime(0);let[_]=ca(()=>t.linearRampToValueAtTime(v,s+E-.3))();_!==null&&cs().log("[ecas]: (automator) failed to set linearRamp",_)},x))}}add(e,t,i){if(this.audioParams.has(e))throw new _p(`AudioParam with id ${e} has already been added.`);this.set(e,t),i!=null?this.setDefault(e,i):this.setDefault(e,t.value)}cancel({paramId:e,when:t}){this.audioParams.get(e).cancelScheduledValues(t)}get(e){return this.audioParams.get(e)}set(e,t){this.audioParams.set(e,t)}current(e){return this.audioParams.get(e).value}getDefault(e){return this.defaults.get(e)}setDefault(e,t){this.defaults.set(e,t)}dispose(){this.audioParams.clear()}},ms="AlgorithmicReverbInsert",sr=class{constructor(e,t={id:ms}){N(this,"typename",ms),N(this,"id",ms),N(this,"automator",new fi(["dry-gain","wet-gain"])),N(this,"options"),N(this,"inputGainNode"),N(this,"outputGainNode"),N(this,"dryGainNode"),N(this,"wetGainNode"),N(this,"reverbNode"),N(this,"audioContext"),this.options={id:t.id,mix:1,time:.2,decay:.2,reverse:!1},this.audioContext=e,this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.reverbNode=e.createConvolver(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.inputGainNode.connect(this.reverbNode),this.reverbNode.connect(this.wetGainNode),this.wetGainNode.connect(this.outputGainNode),this.modify(Pa(Pa({},this.options),t)).catch(Is().error),this.automator.add("dry-gain",this.dryGainNode.gain,t.mix),this.automator.add("wet-gain",this.wetGainNode.gain)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}async modify(e,t=0){let i=!1;e.id!==void 0&&(this.options.id=this.id=e.id),e.mix!==void 0&&(this.options.mix=W(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(W(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(W(this.options.mix,1e-4,1),t)),e.reverse!==void 0&&this.options.reverse!==e.reverse&&(this.options.reverse=e.reverse,i=!0),e.time!==void 0&&this.options.time!==e.time&&(this.options.time=W(e.time,1e-4,10),i=!0),e.decay!==void 0&&this.options.decay!==e.decay&&(i=!0,this.options.decay=Math.min(Math.max(e.decay,1e-4),this.options.time)),i&&this.buildImpulse()}buildImpulse(){let e=this.audioContext.sampleRate*this.options.time,t=this.audioContext.createBuffer(2,e,this.audioContext.sampleRate),i=t.getChannelData(0),s=t.getChannelData(1),a,n;for(n=0;n<e;n++)a=this.options.reverse?e-n:n,i[n]=(Math.random()*2-1)*Math.pow(1-a/e,this.options.decay),s[n]=(Math.random()*2-1)*Math.pow(1-a/e,this.options.decay);this.reverbNode.buffer!=null&&(this.inputGainNode.disconnect(this.reverbNode),this.reverbNode.disconnect(this.wetGainNode),this.reverbNode=this.audioContext.createConvolver(),this.inputGainNode.connect(this.reverbNode),this.reverbNode.connect(this.wetGainNode)),this.reverbNode.buffer=t}};N(sr,"typename",ms);var ar="BiquadFilterInsert",nr=class{constructor(e,t){N(this,"typename",nr.typename),N(this,"id",ar),N(this,"automator",new fi(["frequency","detune","Q","gain"])),N(this,"options"),N(this,"node"),this.node=e.createBiquadFilter(),this.id=t.id,this.options=Object.assign({id:t.id,detune:0,frequency:e.sampleRate/2,gain:0,Q:1,type:"lowpass"},t),this.node.Q.value=this.options.Q,this.node.detune.value=this.options.detune,this.node.frequency.value=this.options.frequency,this.node.gain.value=this.options.gain,this.node.type=this.options.type,this.automator.add("Q",this.node.Q),this.automator.add("detune",this.node.detune),this.automator.add("frequency",this.node.frequency),this.automator.add("gain",this.node.gain)}get input(){return this.node}get output(){return this.node}get getOptions(){return this.options}async modify(e,t,i){if(typeof e.Q=="number"&&(this.options.Q=W(e.Q,1e-4,1e3),this.node.Q.cancelScheduledValues(0),this.node.Q.linearRampToValueAtTime(this.options.Q,t)),typeof e.detune=="number"){let s=34028234663852886e22,a=-34028234663852886e22;this.options.detune=W(e.detune,a,s),this.node.detune.cancelScheduledValues(0),this.node.detune.linearRampToValueAtTime(this.options.detune,t)}if(typeof e.frequency=="number"){let s=i/2;this.options.frequency=W(e.frequency,10,s),this.node.frequency.cancelScheduledValues(0),this.node.frequency.exponentialRampToValueAtTime(this.options.frequency,t)}typeof e.gain=="number"&&(this.options.gain=W(e.gain,-40,40),this.node.gain.cancelScheduledValues(0),this.node.gain.linearRampToValueAtTime(this.options.gain,t)),e.type!==void 0&&e.type!==null&&Sp.includes(e.type)&&(this.node.type=this.options.type=e.type),await new Promise(s=>{setTimeout(()=>{s()},an((t-this.node.context.currentTime)*1e3,0))})}},or=nr;N(or,"typename",ar);var fs="ReverbConvolverInsert",rr=class{constructor(e,t,i){if(N(this,"typename",fs),N(this,"id",fs),N(this,"automator",new fi(["dry-gain","wet-gain"])),N(this,"soundHandler"),N(this,"options",{id:fs,normalize:!1,reverse:!1,impulseResponse:"none",mix:1}),N(this,"inputGainNode"),N(this,"outputGainNode"),N(this,"dryGainNode"),N(this,"wetGainNode"),N(this,"convolverNode"),this.soundHandler=i,this.inputGainNode=e.createGain(),this.convolverNode=e.createConvolver(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.inputGainNode.connect(this.convolverNode),this.convolverNode.connect(this.wetGainNode),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.wetGainNode.connect(this.outputGainNode),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain),this.id=t.id,t.impulseResponse===void 0){Is().warn("[ecas] convolver reverb impulse file should be specified.");return}this.modify(t).catch(Is().error)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}get audioParams(){return{dryGain:this.dryGainNode.gain,wetGain:this.wetGainNode.gain}}async modify(e,t=0){let i=!1;e.id!==void 0&&(this.options.id=this.id=e.id),e.mix!==void 0&&(this.options.mix=W(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(W(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(W(this.options.mix,1e-4,1),t)),e.normalize!==void 0&&this.options.normalize!==e.normalize&&(this.options.normalize=e.normalize,this.convolverNode.normalize=this.options.normalize,i=!0),e.reverse!==void 0&&this.options.reverse!==e.reverse&&(this.options.reverse=e.reverse,i=!0),e.impulseResponse!==void 0&&this.options.impulseResponse!==e.impulseResponse&&(i=!0,this.options.impulseResponse=e.impulseResponse),i&&await this.updateBuffer()}async updateBuffer(){let e=this.options.reverse?this.soundHandler.getAudioBufferReversed(this.options.impulseResponse):this.soundHandler.getAudioBuffer(this.options.impulseResponse);this.convolverNode.buffer=hp(await e)}};N(rr,"typename",fs);var ur="DelayInsert",dr=class{constructor(e,t={id:"delay"}){N(this,"typename",ur),N(this,"automator",new fi(["delayTime","feedback","dry-gain","wet-gain","cutoff"])),N(this,"options"),N(this,"inputGainNode"),N(this,"outputGainNode"),N(this,"dryGainNode"),N(this,"wetGainNode"),N(this,"feedbackGainNode"),N(this,"delayNode"),N(this,"filterNode"),this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.feedbackGainNode=e.createGain(),this.filterNode=e.createBiquadFilter(),this.filterNode.type="lowpass",this.delayNode=e.createDelay(t.maxDelayTime!==void 0?t.maxDelayTime:1),this.inputGainNode.connect(this.dryGainNode).connect(this.outputGainNode),this.inputGainNode.connect(this.delayNode).connect(this.wetGainNode).connect(this.outputGainNode),this.delayNode.connect(this.feedbackGainNode).connect(this.filterNode).connect(this.delayNode),this.options={id:t.id,feedback:.1,mix:1,delayTime:.3,maxDelayTime:1,cutoff:2e4},this.modify(Object.assign(this.options,t)).catch(Is().error),this.automator.add("cutoff",this.filterNode.frequency),this.automator.add("delayTime",this.delayNode.delayTime),this.automator.add("feedback",this.feedbackGainNode.gain),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain)}get id(){return this.options.id}set id(e){this.options.id=e}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}async modify(e,t=0){e.delayTime!==void 0&&(this.options.delayTime=W(e.delayTime,0,this.options.maxDelayTime),this.delayNode.delayTime.cancelScheduledValues(0),this.delayNode.delayTime.linearRampToValueAtTime(this.options.delayTime,t)),e.feedback!==void 0&&(this.options.feedback=W(e.feedback,1e-4,1),this.feedbackGainNode.gain.cancelScheduledValues(0),this.feedbackGainNode.gain.exponentialRampToValueAtTime(this.options.feedback,t)),e.maxDelayTime!==void 0&&(this.options.maxDelayTime=W(e.maxDelayTime,0,10)),e.mix!==void 0&&(this.options.mix=W(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(W(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(this.options.mix,t)),e.id!==void 0&&(this.options.id=e.id),e.cutoff!==void 0&&(this.options.cutoff=W(e.cutoff,10,2e4),this.filterNode.frequency.exponentialRampToValueAtTime(this.options.cutoff,t)),await new Promise(i=>{setTimeout(()=>{i()},an((t-this.outputGainNode.context.currentTime)*1e3,0))})}};N(dr,"typename",ur);var Aa="DynamicsCompressorInsert",lr=class{constructor(e,t){N(this,"typename",Aa),N(this,"id",Aa),N(this,"options"),N(this,"automator",new fi(["threshold","ratio","attack","release","knee"])),N(this,"node"),N(this,"context"),this.context=e,this.id=t.id,this.options=Pa({},t),this.node=e.createDynamicsCompressor(),this.automator.add("threshold",this.threshold),this.automator.add("ratio",this.ratio),this.automator.add("attack",this.attack),this.automator.add("release",this.release),this.automator.add("knee",this.knee),this.modify(t,0)}get attack(){return this.node.attack}get knee(){return this.node.knee}get ratio(){return this.node.ratio}get release(){return this.node.release}get threshold(){return this.node.threshold}get input(){return this.node}get output(){return this.node}get getOptions(){return this.options}async modify(e,t){typeof e.attack=="number"&&(this.attack.cancelScheduledValues(0),this.attack.linearRampToValueAtTime(W(e.attack,0,1),t)),typeof e.knee=="number"&&(this.knee.cancelScheduledValues(0),this.knee.linearRampToValueAtTime(W(e.knee,0,40),t)),typeof e.ratio=="number"&&(this.ratio.cancelScheduledValues(0),this.ratio.linearRampToValueAtTime(W(e.ratio,1,20),t)),typeof e.release=="number"&&(this.release.cancelScheduledValues(0),this.release.exponentialRampToValueAtTime(W(e.release,0,1),t)),typeof e.threshold=="number"&&(this.threshold.cancelScheduledValues(0),this.threshold.linearRampToValueAtTime(W(e.threshold,-100,0),t)),await new Promise(i=>{setTimeout(()=>{i()},an((t-this.context.currentTime)*1e3,0))})}};N(lr,"typename",Aa);var gs="PingPongDelayInsert",hr=class{constructor(e,t={id:gs}){N(this,"typename",gs),N(this,"id",gs),N(this,"automator",new fi(["dry-gain","wet-gain","delay-time-left","delay-time-right","feedback"])),N(this,"options"),N(this,"inputGainNode"),N(this,"outputGainNode"),N(this,"dryGainNode"),N(this,"wetGainNode"),N(this,"feedbackGainNode"),N(this,"delayNodeLeft"),N(this,"delayNodeRight"),N(this,"channelMerger"),this.options=Object.assign({feedback:.5,mix:.5,delayTime:.3,maxDelayTime:1},t),this.maxDelayTime=t.maxDelayTime!==void 0?t.maxDelayTime:1,this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.feedbackGainNode=e.createGain(),this.delayNodeLeft=e.createDelay(this.maxDelayTime),this.delayNodeRight=e.createDelay(this.maxDelayTime),this.channelMerger=e.createChannelMerger(2),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.delayNodeLeft.connect(this.channelMerger,0,0),this.delayNodeRight.connect(this.channelMerger,0,1),this.delayNodeLeft.connect(this.delayNodeRight),this.feedbackGainNode.connect(this.delayNodeLeft),this.delayNodeRight.connect(this.feedbackGainNode),this.inputGainNode.connect(this.feedbackGainNode),this.channelMerger.connect(this.wetGainNode),this.wetGainNode.connect(this.outputGainNode),this.id=t.id,this.automator.add("delay-time-left",this.delayNodeLeft.delayTime),this.automator.add("delay-time-right",this.delayNodeRight.delayTime),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain),this.automator.add("feedback",this.feedbackGainNode.gain)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}async modify(){await Promise.resolve(void 0)}get getOptions(){return this.options}get mix(){return this.options.mix}set mix(e){this.options.mix=e,this.dryGainNode.gain.value=Tp(this.mix),this.wetGainNode.gain.value=wp(this.mix)}get feedback(){return this.options.feedback}set feedback(e){e<0||e>1||(this.options.feedback=e,this.feedbackGainNode.gain.value=this.feedback)}get delayTime(){return this.options.delayTime}set delayTime(e){e<0||e>this.maxDelayTime||(this.options.delayTime=e,this.delayNodeLeft.delayTime.value=this.delayTime,this.delayNodeRight.delayTime.value=this.delayTime)}get maxDelayTime(){return this.options.maxDelayTime}set maxDelayTime(e){this.options.maxDelayTime=e}getPingPongDelayNodes(e){return e==="feedback"?this.feedbackGainNode:[this.delayNodeLeft,this.delayNodeRight]}getGeneratedGraph(){return{leftNode:this.inputGainNode,rightNode:this.outputGainNode}}};N(hr,"typename",gs);var vg={[sr.typename]:"reverbAlgorithmic",[rr.typename]:"reverbConvolver",[lr.typename]:"compressor",[dr.typename]:"delay",[hr.typename]:"pingPongDelay",[or.typename]:"filter"};function To(e){return typeof e=="string"}var Ip,Rp,Dp;Rp=Symbol.toStringTag,Dp=Symbol.iterator,Ip=new WeakMap;function Fe(e){if(!To(e))return!1;let t=/^\d{1,2}\.\d{1,2}\.\d{1,3}$/;return(To(e)?e.match(t):null)!==null}function Vp(e){return/\d\/\d/.test(e)}var So=class extends Error{constructor(){super(...arguments),m(this,"name","BusHandlerError")}},Lp="master",Hp=32;function Wp(e,t,i){if(!t||!t.tempo)return l().warn("[ecas] unable to convert bar.beat.tick to time, since no tempo is configured."),0;t.timeSignature=t.timeSignature||{meter:4,unit:4},t.triggerQuantize=t.triggerQuantize||1;let s=e.split("."),a=parseInt(s[0],10),n=parseInt(s[1],10),r=parseInt(s[2],10),u=1/t.timeSignature.unit*4,d,h=60/(t.tempo/u),p=h*t.timeSignature.meter,v=h/Hp;t.triggerQuantize>=1?d=h*(t.timeSignature.meter*t.triggerQuantize):d=h/(1/t.timeSignature.unit)*t.triggerQuantize;let E=d-(i%d||d),x=a*p,_=n*h,ie=r*v;return x+_+ie+E}function cr(e="4/4"){if(!Vp(e))throw new Error(`[ecas] createTimeSignatureFromString; Invalid time signature '${e}'. Please enter a string such as '4/4', '3/4' or '6/8'.`);let t=e.split("/"),i=parseInt(t[0],10),s=parseInt(t[1],10);return{meter:i,unit:s}}var c=class{static pitchToPlaybackRate(e){return(e<-4800||e>4800)&&(l().info(`[ecas] pitch outside allowed range (-4800 to 4800), was: ${e}, clamping.`),e=Math.min(4800,Math.max(-4800,e))),Math.pow(2,e/1200)}static stringFractionToNumber(e){if(Q(e)||!e)return this.defaultNumber(e,0);if(X(e)){let t=e.split("/").map(i=>parseInt(i,10));if(!t||t.length!==2)throw new Error("[ecas] can only convert fraction in format 'n/n'. Got:"+e);return t[0]/t[1]}return 0}static defaultNumber(e,t=0,i,s=0){if(ye(e))return e;if(Ut(e)){let a=this.randomizeValues(e);return typeof a=="number"?a:(l().warn(`[ecas] provided value is an array: ${e}, but ECAS is unable to get a randomised value from it, returning ${t} instead.`),t)}return Fe(e)?i?Wp(e,i,s):(l().warn("[ecas] you need to provide tempo information for conversion of bar.beat.tick notation to time."),t):Bo(e)?parseFloat(e.toString()):(l().log("[ecas] unable to set default number value, returning 0. val was:",e),t)}static defaultValue(e,t){return(e==null||X(e)&&e==="")&&(e=t),e}static randomizeValues(e){if(ye(e))return e;let t=!0,i=/^-?\d*\.?\d+,-?\d*\.?\d+$/,s=/^-?\d*\.?\d+$/,a,n;if(!ye(e)&&Array.isArray(e))if(e.length>0){if(n=e.map(r=>{if(s.test(r))return r;if(Ut(r))return this._getRandomValue(parseFloat(r[0]),parseFloat(r[1]));if(i.test(r)){let u=r.split(",");return this._getRandomValue(parseFloat(u[0]),parseFloat(u[1]))}else t=!1,l().warn("[ecas] invalid random value format: "+e);return null}),t)return a=this.randomShuffle(n)[0],parseFloat(a)}else l().warn("[ecas] invalid random value: empty array");else return a=e,a;throw new Error("[ecas] randomize values should not reach this line")}static randomShuffle(e){let t=e.map(i=>[Math.random(),i]);return t.sort(),t.map(i=>i[1])}static sumVolume(e=1,t=1){let i=this.defaultNumber(e,1),s=this.defaultNumber(t,1);return i*s}static sumPan(e,t){let i=Math.max(-1,Math.min(this.defaultNumber(e),1)),s=Math.max(-1,Math.min(this.defaultNumber(t),1));return s+(1-Math.abs(s))*i}static sumPitch(e,t){let i=this.defaultNumber(e),s=this.defaultNumber(t);return i+s}static sumPos(e,t){let i=this.defaultNumber(e),s=this.defaultNumber(t);return i+s}static filterUnique(e,t){if(e==null)return null;let i=[],s=[];return e.forEach(a=>{let n="";t.forEach(r=>{Y(a,r)&&(n+=a[r])}),s.indexOf(n)===-1&&i.push(a),s.push(n)}),i}static getWetMixValue(e){return!Q(e)||e>1||e<0?0:e>=.5?1:1-(.5-e)*2}static getDryMixValue(e){return!Q(e)||e>1||e<0?0:e<=.5?1:1-(e-.5)*2}static generateUniqueId(e){let t=new Date().getTime(),i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{let a=(t+crypto.getRandomValues(new Uint32Array(1))[0]/10+Math.random()*16)%16|0;return(s==="x"?a:a&3|8).toString(16)});return e&&e!==""&&typeof e=="string"?e+"_"+i:i}static _getRandomValue(e,t){return(Math.random()*(t-e)+e).toFixed(3)}};function jp(e){class t{constructor(d){this.id=d,this.afters=[]}}let i={},s=[],a={};e.forEach(u=>{let d=u[0],h=d.toString(),p=i[h];p||(p=i[h]=new t(d)),u.forEach(v=>{if(!v||v===d)return;let E=v.toString();i[E]||(i[E]=new t(v)),p.afters.push(v)})});let n=Object.keys(i),r=(u,d)=>{let h=i[u],p=h.id;if(a[u])return;let v=Array.isArray(d)?d:[];v.push(p),a[u]=!0;for(let E of h.afters){if(v.indexOf(E)>=0)throw new Error("Circular chain found: "+p+" must be before "+E+" due to a direct order specification, but "+E+" must be before "+p+" based on other specifications.");r(E.toString(),v.map(x=>x))}s.unshift(p)};return n.forEach(r),s.reverse()}function Rs(e){return Y(e,ot.in)&&Y(e,ot.out)?ye(e[ot.in])&&ye(e[ot.out]):!1}function pr(e){return Y(e,ot.min)&&Y(e,ot.max)&&jt(e.min)&&jt(e.max)?Rs(e.min)&&Rs(e.max):!1}function No(e){return jt(e)&&Y(e,ot.param)?Y(e,ot.param)&&Rs(e)||pr(e):!1}function Up(e,t){let i=c.randomizeValues(e.min.in),s=c.randomizeValues(e.min.out),a=c.randomizeValues(e.max.in)-i,n=c.randomizeValues(e.max.out)-s,r=(t-i)/a;return n*r+s}function Fp(e,t){if(t===e.in)return c.randomizeValues(e.out);throw new Error("translateBasic failed")}function $p(e,t){if(Rs(e))return Fp(e,t);if(pr(e))return Up(e,t);throw new Error("ECAS Translator.translateObject should never reach this line.")}function Po(e,t){Je(t.length>e.param,"translateAction param is out of range. Aborting.");let i=t[e.param];return gc(i,`translate only works for numbers but arg is ${typeof i}, args.length: ${t.length}, eventParam: ${e.param}, args: ${t}`),$p(e,i)}function Bp(e,t){let i=wa(e),s=[...t];for(let a=0;a<i.length;a++){let n=i[a];if(No(n))i[a]=Po(n,s);else if(jt(n)){for(let[r,u]of Object.entries(n))if(No(u)){let d=i[a];ut(d)&&(d[r]=Po(u,s))}}}return i}var zp=class extends Cc{constructor(e,t,i,s){super(),this._eventMap=new Map;for(let a of e)this._eventMap.set(a.id,a.actions);this._gameEvents=this._createListOfGameEvents(Object.values(t)),this._audioEvents=this._createSetOfAudioEvents(e),this.stateMachine=new _c(t,i),this._ecas=s,l().info("[ecas] gameEvents:",this._gameEvents),l().info("[ecas] audioEvents:",this._audioEvents),l().info("[ecas] actions:",this._eventMap)}dispose(){this._gameEvents=[],this._audioEvents=new Set,this._eventMap.clear(),this.stateMachine.dispose()}async triggerGameEvent(e,...t){if(l().info("[ecas] game-event",e,...t),!this._gameEvents.includes(e))return;this.stateMachine.triggerStateChange(e,...t);let i=this.getAudioEventName(e,...t);if(!i)return;let[s]=await Ta(this.triggerAudioEvent.bind(this))(i,...t);s&&l().log("[ecas] error when running event:",i,s)}async triggerAudioEvent(e,...t){l().info("[ecas] audio-event",e,...t);let i=[];if(this.emit(e,...t),e){if(!this._audioEvents.has(e))return Promise.resolve();let s=this._eventMap.get(e);if(Ze(s))for(let a of s)i.push(this.runAction(a,...t))}return Promise.all(i)}triggerOnEndedEvent(e,...t){this.triggerGameEvent(e,...t),this.triggerAudioEvent(e,...t)}async runAction(e,...t){let i=Bp(e.args,t),s=this._ecas[e.type],[a]=await Ta(()=>s.apply(this._ecas,i))();a&&l().log("[ecas] error when running action:",e,a)}getAudioEventName(e,...t){let i=this._getAudioEventConnectionOrName(e);if(!ut(i))return l().debug("[ecas] no audio-event to trigger on game-event:",e,"in state:",this.stateMachine.activeState),"";if(jt(i))return s(i);return i;function s(a){if(Ut(t)){let n=t[0];if(X(n)||ye(n)){let r=a[n];if(X(r))return r}}return""}}get gameEvents(){return this._gameEvents}get audioEvents(){return[...this._audioEvents.keys()]}_getAudioEventConnectionOrName(e,t=this.stateMachine.activeState){let i=t.events[e];if(i)return i;if(t.parent){let s=this.stateMachine.getState(t.parent);return this._getAudioEventConnectionOrName(e,s)}return null}_createListOfGameEvents(e){let t=e.map(i=>[...pc(i.events),...i.activatesOn.map(s=>X(s)?s:s.event),...i.deactivatesOn.map(s=>X(s)?s:s.event),...this._createListOfGameEvents(Object.values(i.children))]).flat();return cc(t)}_createSetOfAudioEvents(e){let t=new Array;for(let i of e)t.push(i.id);return new Set(t)}},O={Ready:"ecas-ready",Mute:"ecas-mute",Unmute:"ecas-unmute",Pause:"ecas-pause",Resume:"ecas-resume",Timer:{Pause:"ecas-timer-pause",Resume:"ecas-timer-resume"},Context:{Pause:"ecas-context-pause",Resume:"ecas-context-resume",Suspended:"ecas-context-suspended",Running:"ecas-context-running",Closed:"ecas-context-closed",Interrupted:"ecas-context-interrupted"},Preload:{Start:"ecas-preload-start",Done:"ecas-preload-done",Progress:"ecas-preload-progress"},Sound:{LoadStart:"ecas-sound-load-start",Loading:"ecas-sound-load-loading",LoadDone:"ecas-sound-load-done",LoadError:"ecas-sound-load-error",Abort:"ecas-sound-abort",CanPlay:"ecas-sound-canplay",Play:"ecas-sound-play",Stop:"ecas-sound-stop",Ended:"ecas-sound-ended",Pause:"ecas-sound-pause",FadeOutStart:"ecas-sound-fade-out-start",FadeOutEnd:"ecas-sound-fade-out-end",PlaybackStart:"ecas-sound-playback-start",PlaybackEnd:"ecas-sound-playback-end",PlaybackError:"ecas-sound-playback-error"},Events:{LoadStart:"ecas-events-load-start",LoadDone:"ecas-events-load-done"},Envelope:{Play:"ecas-envelope-play",Start:"ecas-envelope-start",Ended:"ecas-envelope-ended"}};function qp(e){let{ids:t,mutDetails:i,eventHandler:s}=e,a=[];for(let n of t){if(!i.has(n)){l().error("[ecas] create buffer'",n,"' not found in",i);continue}let r=i.get(n);if(r.isLoaded){l().debug("[ecas] sound",n,"has already been loaded");continue}if(r.isLoading){l().debug("[ecas] sound",n,"is already in the process of being loaded");continue}r.isLoading=!0,s.triggerAudioEvent(O.Sound.LoadStart,n),a.push(Qp(C({id:n,detail:r},e)))}return a}async function Qp(e){let{id:t,detail:i,mutBuffers:s,eventHandler:a}=e,[n,r]=await Ta(()=>Xp(Re(C({},e),{duration:i.duration,url:i.url})))();if(n){l().error(n),i.isLoaded=!1,i.isLoading=!1,a.triggerAudioEvent(O.Sound.LoadError,t);return}s.set(t,r),i.isLoaded=!0,i.isLoading=!1,a.triggerAudioEvent(O.Sound.LoadDone,t)}async function Xp(e){return new Promise((t,i)=>{let s=Yp(e.url);s.addEventListener("abort",()=>{i(`[ecas]rRequest for ${e.url} aborted`)}),s.addEventListener("timeout",()=>{i(`[ecas]rRequest for ${e.url} timed out`)}),s.addEventListener("load",()=>{e.eventHandler.triggerAudioEvent(O.Sound.Loading,e.id);let a=s.response;a.byteLength===0&&i("[ecas] response returned arraybuffer with byteLength 0"),Kp(Re(C({},e),{arrayBuffer:a})).then(n=>t(n),n=>i(n)).catch(n=>i(n))}),s.addEventListener("error",a=>{i(`[ecas] error when requesting: '${e.url}', ${a}`)}),s.send()})}function Yp(e){let t=new XMLHttpRequest;return t.open("GET",e,!0),t.responseType="arraybuffer",t}async function Kp(e){return new Promise((t,i)=>{let{duration:s,arrayBuffer:a,audioContext:n,url:r}=e;n.decodeAudioData(a,u=>{let[d]=Qo(()=>{if(s!==u.duration&&s>0){let h=Jp({audioContext:n,buffer:u,duration:s});t(h)}t(u)})();d&&i(d)},u=>{e.eventHandler.triggerAudioEvent(O.Sound.LoadError,e.id),l().error("[ecas] createBuffer: Failed to decode audio data at url ",r,"Error:",u),i("[ecas] failed to decode audio data")}).then(u=>t(u),u=>i(u)).catch(u=>{i(u)})})}function Jp(e){let{duration:t,buffer:i,audioContext:s}=e,a=Math.floor(t*i.sampleRate),n=s.createBuffer(i.numberOfChannels,a,i.sampleRate);return mr({src:i,trg:n})}function mr(e){return ut(e.src.copyToChannel)?Zp(e):em(e)}function Zp(e){let{src:t,trg:i}=e;for(let s=0;s<t.numberOfChannels;s++)i.copyToChannel(t.getChannelData(s),s,0);return i}function em(e){let{src:t,trg:i}=e;for(let s=0;s<t.numberOfChannels;s++){let a=i.getChannelData(s),n=t.getChannelData(s);for(let r=0;r<a.length;r++)a[r]=n[r]||0}return i}function tm(e,t){return t.createBuffer(e.numberOfChannels,e.length,e.sampleRate)}function im(e){for(let t=0;t<e.numberOfChannels;t++){let i=e.getChannelData(t).reverse();e.copyToChannel(i,t)}return e}function sm(e,t){let i=tm(e,t),s=mr({src:e,trg:i});return im(s)}var pa=class extends Error{constructor(e){super(e),this.name="SoundLoadError"}},am=class extends Error{constructor(e){super(e),this.name="SoundFormatError"}},Li,vs,tt,si,it,Mi,xa,fr,nm=class{constructor(e){f(this,xa),f(this,Li,void 0),f(this,vs,new Map),f(this,tt,new Map),f(this,si,new Map),f(this,it,void 0),f(this,Mi,void 0);let{ecasOptions:t,audioContext:i,eventHandler:s}=e;P(this,Li,i),P(this,Mi,s);let{fileExtToUse:a,soundData:n,packageToUse:r}=t.loadrConfig,u=t.soundConfig.sounds,d=mo(t.soundConfig.settings.loadPath,r);for(let h of u)this.details.set(h.id,{url:mo(d,h.id)+a,duration:n.get(h.id)||0,isLoaded:!1,isLoading:!1});P(this,it,new Map(t.soundConfig.sounds.map(h=>[h.id,h])))}dispose(){o(this,tt).clear(),o(this,si).clear(),o(this,vs).clear(),o(this,it).clear(),o(this,Mi).dispose()}get details(){return o(this,vs)}getSound(e){return Je(o(this,it).has(e),{Err:pa,msg:`[ecas] sound '${e}' does not exist.`}),q(o(this,it).get(e))}getDurationSeconds(e){let t=q(this.details.get(e));return mi(t.duration)&&l().error(`[ecas] sound '${e}' does not have a duration.`),t.duration||this.getAudioBufferSync(e).duration}async getAudioBuffer(e){return Je(this.details.has(e),{Err:pa,msg:`[ecas] sound with id: ${e} cannot be loaded because it does not seem to exist`}),q(this.details.get(e)).isLoaded?q(o(this,tt).get(e)):(l().debug("[ecas] buffer has not been loaded yet, loading now..."),await this.load([e]).catch(()=>{l().log(`[ecas] sound with id: ${e} cannot be loaded`)}),q(o(this,tt).get(e)))}getAudioBufferSync(e){return Je(this.details.has(e),{Err:pa,msg:`[ecas] getBuffer - Sound with id: ${e} cannot be loaded because it does not seem to exist`}),q(this.details.get(e)).isLoaded?q(o(this,tt).get(e)):(l().debug("[ecas] getBuffer; buffer has not been loaded yet. Cannot use the sync version for this, make sure you load the sound before calling this method."),q(o(this,tt).get(e)))}async getAudioBufferReversed(e){return o(this,si).has(e)||await M(this,xa,fr).call(this,e),o(this,si).get(e)}async load(e){l().debug("[ecas] load",e);let t=qp({ids:e,mutDetails:this.details,mutBuffers:o(this,tt),audioContext:o(this,Li),eventHandler:o(this,Mi)});return Promise.all(t)}async loadAll(){l().debug("[ecas] loadAll"),await this.load([...o(this,it).keys()])}getAllSoundIds(){return[...o(this,it).keys()]}isLoaded(e){return this.details.has(e)&&q(this.details.get(e)).isLoaded}};Li=new WeakMap,vs=new WeakMap,tt=new WeakMap,si=new WeakMap,it=new WeakMap,Mi=new WeakMap,xa=new WeakSet,fr=async function(e){let t=await this.getAudioBuffer(e),i=sm(t,o(this,Li));o(this,si).set(e,i)};var Yt,Ot,ai,Ct,ka,gr,om=class{constructor(e){f(this,ka),f(this,Yt,new Map),f(this,Ot,new Map),f(this,ai,new Map),f(this,Ct,new Map),this.soundHandler=new nm(e);for(let t of e.ecasOptions.soundConfig.groups)o(this,Yt).set(t.id,t);for(let t of e.ecasOptions.soundConfig.pools)o(this,Ot).set(t.id,t);M(this,ka,gr).call(this,e.ecasOptions)}dispose(){P(this,Yt,new Map),P(this,Ot,new Map),P(this,ai,new Map),P(this,Ct,new Map),this.soundHandler.dispose()}loadAssetsRelatedToEvents(e){let t=e.map(i=>{let s=o(this,ai).get(i);return $o(s)?this.soundHandler.load(s):(l().debug(`[ecas] asset - found no assets for event '${i}' ${o(this,ai).get(i)}`),Promise.resolve())});return Promise.all(t)}getPool(e){return o(this,Ot).has(e)||l().error("[ecas] asset - pool with id",e,"does not exist"),o(this,Ot).get(e)}hasPool(e){return o(this,Ot).has(e)}getGroup(e){return o(this,Yt).has(e)||l().error("[ecas] asset - group with id",e,"does not exist"),o(this,Yt).get(e)}getPatternContext(e){return o(this,Ct).has(e)||l().error("[ecas] asset - pool with id",e,"does not exist"),o(this,Ct).get(e)}hasPatternContext(e){o(this,Ct).has(e)}setPatternContext(e,t){o(this,Ct).set(e,t)}};Yt=new WeakMap,Ot=new WeakMap,ai=new WeakMap,Ct=new WeakMap,ka=new WeakSet,gr=function(e){let t=e.eventConfig;for(let{id:s,actions:a}of t)o(this,ai).set(s,i(a));return;function i(s){let a=[];for(let n of s)n.type==="playSound"&&a.push(n.args[0].toString());return a}};var xi={caf:"x-caf",webm:"webm",ogg:"ogg",mp4:"mp4",mp3:"mp3"};function rm(e=Pc(J)){let t=um();if(l().debug("[ecas] supported AudioFormats:"),l().table(t),t===null)try{Ze(navigator)}catch(u){return J.WEBM}let i=()=>/Edge/.test(navigator.userAgent),s=()=>/^((?!chrome|android).)*safari/i.test(navigator.userAgent),a=()=>!i()&&!s(),n=()=>Y(window,"safari")&&Ze(window.safari),r=()=>s()&&!n();if(i()&&l().debug("[ecas] Edge Browser detected."),n()&&l().debug("[ecas] Safari on desktop detected."),r()&&l().debug("[ecas] Safari on mobile detected."),t!==null){let u=h=>e.includes(h),d=h=>t[h]&&u(h);if(d(J.WEBM)&&a())return J.WEBM;if(d(J.MP4))return J.MP4;if(d(J.MP3))return J.MP3;if(d(J.CAF))return J.CAF}throw new am("[ecas] no available audio file format found.")}function um(){let e;try{e=new window.Audio}catch(i){return null}if(!sn(e.canPlayType))return null;let t=i=>{let s=e.canPlayType(`audio/${i}`),a;return(n=>(n.Probably="probably",n.Maybe="maybe"))(a||(a={})),s==="probably"||s==="maybe"};return{[J.WEBM]:t(xi.webm),[J.MP4]:t(xi.mp4),[J.CAF]:t(xi.caf),[J.OGG]:t(xi.ogg),[J.MP3]:t(xi.mp3)}}var ys="master",Hi="OUTPUT",k={DEFAULT_STOP:"default_stop",POOL_STOP:"pool_stop",POOL_PLAY:"pool_play",POOL_PAUSE:"pool_pause",POOL_RESUME:"pool_resume",SOUND_START:"sound_start",SOUND_STOP:"sound_stop",SOUND_PAUSE:"sound_pause",SOUND_RESUME:"sound_resume",SOUND_COMPLETE:"sound_completed",PATTERN_PLAY:"pattern_play",PATTERN_STOP:"pattern_stop",PATTERN_RESUME:"pattern_resume",PATTERN_PAUSE:"pattern_pause",PATTERN:"pattern",STOP:"stop",MIXER_PLAY_SOUND:"mixer_playSound",ENVELOPE_SCHEDULED:"envelope_scheduled",SCHEDULED:"scheduled",SCHEDULED_REGEX:"scheduled_(.)+",DISCONNECT:"disconnect",VOLUME:"volume",CROSSFADE:"crossfade",PLAY:"play"},vr="EnvelopeContext",Ds=class{constructor(e={}){this.type="sound",this.parentId="",this.startTime=0,this.onEnded=ce,this.onplay=ce,this.willStopSoundOnEnded=!1,this.isPaused=!1,this.isAFadeIn=!1,this.curveType="linear",this.envelopePoints=[],this.param="volume",Object.assign(this,e)}get typename(){return vr}};Ds.typename=vr;function dm(e={}){return new Ds(e)}var _t,lm=class{constructor(){f(this,_t,new Map)}dispose(){o(this,_t).clear()}getContexts(e){return o(this,_t).has(e)||o(this,_t).set(e,[]),o(this,_t).get(e)}setContexts(e){o(this,_t).set(e.id,e.contexts)}};_t=new WeakMap;var yr="PlayEnvelopeArgs",nn=class{constructor(e){if(this.startTime=0,this.type="sound",this.curveType="linear",this.onEnded=ce,this.onplay=ce,this.willStopSoundOnEnded=!1,this.envelopePoints=[],Object.assign(this,e),ye(e.startTime)){this.startTime=e.startTime/1e3;return}this.startTime=0}get typename(){return yr}};nn.typename=yr;function hm(e){return e.typename===nn.typename}function on(e){return new nn(e)}function Eo(e=1,t=10,i=10){let s=d=>d>0?Math.log10(d):Math.log10(1e-5),a=s(e),n=(s(t)-a)/(i-1),r=new Float32Array(i),u=a;r[0]=e;for(let d=1;d<i-1;d++)u+=n,r[d]=Math.pow(10,u);return r[i-1]=t,r}function cm(e=1,t=10,i=10){let s=(t-e)/(i-1),a=new Float32Array(i),n=e;for(let r=0;r<i;r++)a[r]=n,n+=s;return a[0]=e,a[a.length-1]=t,a}function pm(e=1,t=0,i=10){let s=Math.PI/2,a=new Float32Array(i);for(let r=0;r<i;r++){let u=Math.PI*r/(i-1)-s;a[r]=Math.sin(u)/2+.5}let n=t-e;for(let r=0;r<i;r++)a[r]=a[r]*n+e;return a}function mm(e,t,i){let s=jo(t),a=new Float32Array(s),n=e[0],r=0;for(let u=0;u<e.length;u++){let d=t[u],h=i(n,e[u],t[u]);a.set(h,r),r+=d,n=e[u]}return a}function fm(e){return{linear:cm,exponential:Eo,logarithmic:Eo,"s-curve":pm}[e]}function gm(e){let{values:t,positions:i,curveType:s}=e,a=vm(i),n=fm(s);return mm(t,a,n)}function vm(e){return e.map(t=>Math.floor(Math.max(t*.25,2)))}function ym(e,t){return e.reduce((i,s)=>s.parentId===t?s:i).envelopePoints}function A(...e){return e.join("::")}function Ga(e){let t=A(e.targetId,e.parentId,e.param);return e.willStopSoundOnEnded?A(t,k.STOP):t}var Oi=class{static setTimeout(e,t,i="",...s){if(i===""){window.setTimeout(e,t*1e3,s);return}let a=this.dateProvider()(),n=[],r=this._map[i];r&&(n=n.concat(r.callbacks),window.clearTimeout(r.id)),n.push({args:s,callback:e});let u=window.setTimeout(()=>this.onDone(i),t*1e3);this._map[i]={id:u,remaining:t,start:a,callbacks:n,caller:i}}static renameTimeout(e,t,i){let s=this._map[t];if(s){let a=i||s.remaining;window.clearTimeout(s.id),Oi.clearTimeout(t);let n=window.setTimeout(()=>this.onDone(e),a*1e3);this._map[e]=Re(C({},s),{id:n,remaining:a,caller:e})}}static pause(e){if(this._map[e]){let t=this._map[e],i=this.dateProvider()();window.clearTimeout(t.id),t.remaining-=i-t.start}}static pauseMatching(e){Object.keys(this._map).forEach(t=>{let i=t.match(e);i&&i.forEach(s=>{s===t&&Oi.pause(s)})})}static resume(e){if(this._map[e]){let t=this._map[e],i=this.dateProvider()();t.start=i;let s=window.setTimeout(this.onDone.bind(this,e,t.callbacks),t.remaining*1e3);t.id=s}}static resumeMatching(e){Object.keys(this._map).forEach(t=>{let i=t.match(e);i&&i.forEach(s=>{s===t&&Oi.resume(s)})})}static clearTimeout(e){this._map[e]&&(window.clearTimeout(this._map[e].id),delete this._map[e])}static clearMatching(e){Object.keys(this._map).forEach(t=>{let i=t.match(e);i&&i.forEach(s=>{s===t&&Oi.clearTimeout(s)})})}static hasTimeout(e){return ut(this._map[e])}static onDone(e){if(this._map[e]){let t=this._map[e];delete this._map[e],t.callbacks.forEach(i=>{i.callback.call(i.args)}),window.clearTimeout(t.id)}}},y=Oi;y._map={},y.dateProvider=()=>()=>Date.now()/1e3;function bm(e,t,i){let s=ut(i.soundSource.source)?i.soundSource.source:t.createBufferSource();return s.buffer=e,s.loop=i.isLoop,s}function wm(e,t,i,s,a,n,r){try{let u=Math.max(s.currentTime*s.playbackRate,0);t>0?(y.setTimeout(()=>n.triggerAudioEvent(O.Sound.PlaybackStart,a),i-r.currentTime),e.start(i,u,t)):(t<0&&l().warn("[ecas] duration cannot be negative. was "+t+" when playing sound '"+a+"'."),y.setTimeout(()=>n.triggerAudioEvent(O.Sound.PlaybackStart,a),i-r.currentTime),e.start(i,u)),e.onended=s.onSourceNodeEnded,e.playbackRate.value=s.playbackRate}catch(u){l().error(u)}}var Ma={nextId:0,next(){return Ma.nextId++}},Tm=Object.defineProperty,Ao=Object.getOwnPropertySymbols,Sm=Object.prototype.hasOwnProperty,Nm=Object.prototype.propertyIsEnumerable,Oa=(e,t,i)=>t in e?Tm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ca=(e,t)=>{for(var i in t||(t={}))Sm.call(t,i)&&Oa(e,i,t[i]);if(Ao)for(var i of Ao(t))Nm.call(t,i)&&Oa(e,i,t[i]);return e},b=(e,t,i)=>(Oa(e,typeof t!="symbol"?t+"":t,i),i);function Gt(){}var Pm={typename:"none",debug:Gt,log:Gt,info:Gt,warn:Gt,error:Gt,table:Gt,trace:Gt},Be=Em;function Em(){return Pm}var Am=Object.defineProperty,xm=(e,t,i)=>t in e?Am(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,km=(e,t,i)=>(xm(e,typeof t!="symbol"?t+"":t,i),i);function rn(e,t){return Math.max(e,t)}function j(e,t,i){return Math.min(Math.max(e,t),i)}var xo=class extends Error{constructor(){super(...arguments),km(this,"name","AssertionError")}};function br(e,t){if(!e)throw wr(t)?new xo(t):(t==null?void 0:t.Err)!==void 0?new t.Err(t.msg):new xo(t==null?void 0:t.msg)}function Gm(e,t){br(_m(e),{msg:t!=null?t:"thing is undefined"})}function Mm(e,t){br(!Rm(e),{msg:t!=null?t:"thing is null"})}function Om(e,t){Gm(e,t),Mm(e,t)}function Cm(e,t){return Om(e,t),e}function _m(e){return!Im(e)}function Im(e){return e===void 0}function Rm(e){return e===null}function Dm(e){return e.length===0}function Vm(e){return typeof e=="number"&&!isNaN(e)}function wr(e){return typeof e=="string"}function Tr(e){return Vm(e)?!0:wr(e)?Lm(e):!1}function Lm(e){return!isNaN(parseFloat(e))}var Hm,Wm,jm;Wm=Symbol.toStringTag,jm=Symbol.iterator,Hm=new WeakMap;function Um(e){return!Tr(e)||e>1||e<0?0:e>=.5?1:1-(.5-e)*2}function Fm(e){return!Tr(e)||e>1||e<0?0:e<=.5?1:1-(e-.5)*2}function $m(e){return e.at(-1)}var Sr=class extends Error{constructor(){super(...arguments),b(this,"name","InsertHandlerError")}},Bm=["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"],zm=Object.defineProperty,qm=(e,t,i)=>t in e?zm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ci=(e,t,i)=>(qm(e,typeof t!="symbol"?t+"":t,i),i);function Mt(){}var Qm={typename:"none",debug:Mt,log:Mt,info:Mt,warn:Mt,error:Mt,table:Mt,trace:Mt},ps=Xm;function Xm(){return Qm}var Ym=Object.defineProperty,Km=(e,t,i)=>t in e?Ym(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,_a=(e,t,i)=>(Km(e,typeof t!="symbol"?t+"":t,i),i),Jm=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},xe=(e,t,i)=>(Jm(e,t,"read from private field"),i?i.call(e):t.get(e)),Zm=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)};function ef(e=navigator.userAgent){return e.includes("Firefox")}var tf=class extends Error{constructor(){super(...arguments),_a(this,"name","StrictMapError")}},de,Nr,Pr,ko=class{constructor(){Zm(this,de,new Map),_a(this,Nr,"StrictMap"),_a(this,Pr,xe(this,de).entries())}get(e){if(!xe(this,de).has(e))throw new tf(`Key: '${e}' does not exist.`);return xe(this,de).get(e)}set(e,t){return xe(this,de).set(e,t),this}forEach(e,t){xe(this,de).forEach(e,t)}clear(){xe(this,de).clear()}delete(e){return xe(this,de).delete(e)}entries(){return xe(this,de).entries()}has(e){return xe(this,de).has(e)}keys(){return xe(this,de).keys()}size(){return xe(this,de).size}values(){return xe(this,de).values()}};Nr=Symbol.toStringTag,Pr=Symbol.iterator,de=new WeakMap;function ma(e){return(...t)=>{try{return[null,e(...t)]}catch(i){return[i,null]}}}var sf=class extends Error{constructor(){super(...arguments),Ci(this,"name","AutomatorError")}},gi=class{constructor(e){Ci(this,"AutomatableParameters"),Ci(this,"audioParams",new ko),Ci(this,"defaults",new ko),Ci(this,"firefoxHacks",new Map),this.AutomatableParameters=e}automate({paramId:e,valueCurve:t,when:i,duration:s}){ps().debug("[ecas] automate",{paramId:e,valueCurve:t,when:i,duration:s});let a=this.audioParams.get(e);if(a.cancelAndHoldAtTime(0),ef()){this.firefoxHack({paramId:e,valueCurve:t,when:i,duration:s,audioParam:a});return}let[n]=ma(()=>a.setValueCurveAtTime(t,i,s))();if(n===null)return;ps().log("[ecas]: failed to override scheduled valueCurve. Using a linear ramp to the end value instead.",n),a.cancelAndHoldAtTime(0);let r=t.at(-1);if(r!==void 0){let[u]=ma(()=>a.linearRampToValueAtTime(r,i+s))();u!==null&&ps().log("[ecas]: failed to schedule linearRampToValueAtTime that was used as a fallback when the valueCurve failed.",u)}}firefoxHack({paramId:e,audioParam:t,valueCurve:i,when:s,duration:a}){var n;let r=(n=this.firefoxHacks.get(e))!=null?n:[],u=[],d=i.length,h=a/d;for(let p of r)window.clearTimeout(p);this.firefoxHacks.set(e,u);for(let[p,v]of i.entries()){let E=p*h,x=E*1e3;u.push(window.setTimeout(()=>{t.cancelAndHoldAtTime(0);let[_]=ma(()=>t.linearRampToValueAtTime(v,s+E-.3))();_!==null&&ps().log("[ecas]: (automator) failed to set linearRamp",_)},x))}}add(e,t,i){if(this.audioParams.has(e))throw new sf(`AudioParam with id ${e} has already been added.`);this.set(e,t),i!=null?this.setDefault(e,i):this.setDefault(e,t.value)}cancel({paramId:e,when:t}){this.audioParams.get(e).cancelScheduledValues(t)}get(e){return this.audioParams.get(e)}set(e,t){this.audioParams.set(e,t)}current(e){return this.audioParams.get(e).value}getDefault(e){return this.defaults.get(e)}setDefault(e,t){this.defaults.set(e,t)}dispose(){this.audioParams.clear()}},bs="AlgorithmicReverbInsert",ui=class{constructor(e,t={id:bs}){b(this,"typename",bs),b(this,"id",bs),b(this,"automator",new gi(["dry-gain","wet-gain"])),b(this,"options"),b(this,"inputGainNode"),b(this,"outputGainNode"),b(this,"dryGainNode"),b(this,"wetGainNode"),b(this,"reverbNode"),b(this,"audioContext"),this.options={id:t.id,mix:1,time:.2,decay:.2,reverse:!1},this.audioContext=e,this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.reverbNode=e.createConvolver(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.inputGainNode.connect(this.reverbNode),this.reverbNode.connect(this.wetGainNode),this.wetGainNode.connect(this.outputGainNode),this.modify(Ca(Ca({},this.options),t)).catch(Be().error),this.automator.add("dry-gain",this.dryGainNode.gain,t.mix),this.automator.add("wet-gain",this.wetGainNode.gain)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}async modify(e,t=0){let i=!1;e.id!==void 0&&(this.options.id=this.id=e.id),e.mix!==void 0&&(this.options.mix=j(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(j(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(j(this.options.mix,1e-4,1),t)),e.reverse!==void 0&&this.options.reverse!==e.reverse&&(this.options.reverse=e.reverse,i=!0),e.time!==void 0&&this.options.time!==e.time&&(this.options.time=j(e.time,1e-4,10),i=!0),e.decay!==void 0&&this.options.decay!==e.decay&&(i=!0,this.options.decay=Math.min(Math.max(e.decay,1e-4),this.options.time)),i&&this.buildImpulse()}buildImpulse(){let e=this.audioContext.sampleRate*this.options.time,t=this.audioContext.createBuffer(2,e,this.audioContext.sampleRate),i=t.getChannelData(0),s=t.getChannelData(1),a,n;for(n=0;n<e;n++)a=this.options.reverse?e-n:n,i[n]=(Math.random()*2-1)*Math.pow(1-a/e,this.options.decay),s[n]=(Math.random()*2-1)*Math.pow(1-a/e,this.options.decay);this.reverbNode.buffer!=null&&(this.inputGainNode.disconnect(this.reverbNode),this.reverbNode.disconnect(this.wetGainNode),this.reverbNode=this.audioContext.createConvolver(),this.inputGainNode.connect(this.reverbNode),this.reverbNode.connect(this.wetGainNode)),this.reverbNode.buffer=t}};b(ui,"typename",bs);var Er="BiquadFilterInsert",Ar=class{constructor(e,t){b(this,"typename",Ar.typename),b(this,"id",Er),b(this,"automator",new gi(["frequency","detune","Q","gain"])),b(this,"options"),b(this,"node"),this.node=e.createBiquadFilter(),this.id=t.id,this.options=Object.assign({id:t.id,detune:0,frequency:e.sampleRate/2,gain:0,Q:1,type:"lowpass"},t),this.node.Q.value=this.options.Q,this.node.detune.value=this.options.detune,this.node.frequency.value=this.options.frequency,this.node.gain.value=this.options.gain,this.node.type=this.options.type,this.automator.add("Q",this.node.Q),this.automator.add("detune",this.node.detune),this.automator.add("frequency",this.node.frequency),this.automator.add("gain",this.node.gain)}get input(){return this.node}get output(){return this.node}get getOptions(){return this.options}async modify(e,t,i){if(typeof e.Q=="number"&&(this.options.Q=j(e.Q,1e-4,1e3),this.node.Q.cancelScheduledValues(0),this.node.Q.linearRampToValueAtTime(this.options.Q,t)),typeof e.detune=="number"){let s=34028234663852886e22,a=-34028234663852886e22;this.options.detune=j(e.detune,a,s),this.node.detune.cancelScheduledValues(0),this.node.detune.linearRampToValueAtTime(this.options.detune,t)}if(typeof e.frequency=="number"){let s=i/2;this.options.frequency=j(e.frequency,10,s),this.node.frequency.cancelScheduledValues(0),this.node.frequency.exponentialRampToValueAtTime(this.options.frequency,t)}typeof e.gain=="number"&&(this.options.gain=j(e.gain,-40,40),this.node.gain.cancelScheduledValues(0),this.node.gain.linearRampToValueAtTime(this.options.gain,t)),e.type!==void 0&&e.type!==null&&Bm.includes(e.type)&&(this.node.type=this.options.type=e.type),await new Promise(s=>{setTimeout(()=>{s()},rn((t-this.node.context.currentTime)*1e3,0))})}},di=Ar;b(di,"typename",Er);var ws="ReverbConvolverInsert",li=class{constructor(e,t,i){if(b(this,"typename",ws),b(this,"id",ws),b(this,"automator",new gi(["dry-gain","wet-gain"])),b(this,"soundHandler"),b(this,"options",{id:ws,normalize:!1,reverse:!1,impulseResponse:"none",mix:1}),b(this,"inputGainNode"),b(this,"outputGainNode"),b(this,"dryGainNode"),b(this,"wetGainNode"),b(this,"convolverNode"),this.soundHandler=i,this.inputGainNode=e.createGain(),this.convolverNode=e.createConvolver(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.inputGainNode.connect(this.convolverNode),this.convolverNode.connect(this.wetGainNode),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.wetGainNode.connect(this.outputGainNode),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain),this.id=t.id,t.impulseResponse===void 0){Be().warn("[ecas] convolver reverb impulse file should be specified.");return}this.modify(t).catch(Be().error)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}get audioParams(){return{dryGain:this.dryGainNode.gain,wetGain:this.wetGainNode.gain}}async modify(e,t=0){let i=!1;e.id!==void 0&&(this.options.id=this.id=e.id),e.mix!==void 0&&(this.options.mix=j(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(j(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(j(this.options.mix,1e-4,1),t)),e.normalize!==void 0&&this.options.normalize!==e.normalize&&(this.options.normalize=e.normalize,this.convolverNode.normalize=this.options.normalize,i=!0),e.reverse!==void 0&&this.options.reverse!==e.reverse&&(this.options.reverse=e.reverse,i=!0),e.impulseResponse!==void 0&&this.options.impulseResponse!==e.impulseResponse&&(i=!0,this.options.impulseResponse=e.impulseResponse),i&&await this.updateBuffer()}async updateBuffer(){let e=this.options.reverse?this.soundHandler.getAudioBufferReversed(this.options.impulseResponse):this.soundHandler.getAudioBuffer(this.options.impulseResponse);this.convolverNode.buffer=Cm(await e)}};b(li,"typename",ws);var xr="DelayInsert",hi=class{constructor(e,t={id:"delay"}){b(this,"typename",xr),b(this,"automator",new gi(["delayTime","feedback","dry-gain","wet-gain","cutoff"])),b(this,"options"),b(this,"inputGainNode"),b(this,"outputGainNode"),b(this,"dryGainNode"),b(this,"wetGainNode"),b(this,"feedbackGainNode"),b(this,"delayNode"),b(this,"filterNode"),this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.feedbackGainNode=e.createGain(),this.filterNode=e.createBiquadFilter(),this.filterNode.type="lowpass",this.delayNode=e.createDelay(t.maxDelayTime!==void 0?t.maxDelayTime:1),this.inputGainNode.connect(this.dryGainNode).connect(this.outputGainNode),this.inputGainNode.connect(this.delayNode).connect(this.wetGainNode).connect(this.outputGainNode),this.delayNode.connect(this.feedbackGainNode).connect(this.filterNode).connect(this.delayNode),this.options={id:t.id,feedback:.1,mix:1,delayTime:.3,maxDelayTime:1,cutoff:2e4},this.modify(Object.assign(this.options,t)).catch(Be().error),this.automator.add("cutoff",this.filterNode.frequency),this.automator.add("delayTime",this.delayNode.delayTime),this.automator.add("feedback",this.feedbackGainNode.gain),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain)}get id(){return this.options.id}set id(e){this.options.id=e}get input(){return this.inputGainNode}get output(){return this.outputGainNode}get getOptions(){return this.options}async modify(e,t=0){e.delayTime!==void 0&&(this.options.delayTime=j(e.delayTime,0,this.options.maxDelayTime),this.delayNode.delayTime.cancelScheduledValues(0),this.delayNode.delayTime.linearRampToValueAtTime(this.options.delayTime,t)),e.feedback!==void 0&&(this.options.feedback=j(e.feedback,1e-4,1),this.feedbackGainNode.gain.cancelScheduledValues(0),this.feedbackGainNode.gain.exponentialRampToValueAtTime(this.options.feedback,t)),e.maxDelayTime!==void 0&&(this.options.maxDelayTime=j(e.maxDelayTime,0,10)),e.mix!==void 0&&(this.options.mix=j(e.mix,1e-4,1),this.dryGainNode.gain.cancelScheduledValues(0),this.dryGainNode.gain.linearRampToValueAtTime(j(1-this.options.mix,1e-4,1),t),this.wetGainNode.gain.cancelScheduledValues(0),this.wetGainNode.gain.linearRampToValueAtTime(this.options.mix,t)),e.id!==void 0&&(this.options.id=e.id),e.cutoff!==void 0&&(this.options.cutoff=j(e.cutoff,10,2e4),this.filterNode.frequency.exponentialRampToValueAtTime(this.options.cutoff,t)),await new Promise(i=>{setTimeout(()=>{i()},rn((t-this.outputGainNode.context.currentTime)*1e3,0))})}};b(hi,"typename",xr);var Ia="DynamicsCompressorInsert",ci=class{constructor(e,t){b(this,"typename",Ia),b(this,"id",Ia),b(this,"options"),b(this,"automator",new gi(["threshold","ratio","attack","release","knee"])),b(this,"node"),b(this,"context"),this.context=e,this.id=t.id,this.options=Ca({},t),this.node=e.createDynamicsCompressor(),this.automator.add("threshold",this.threshold),this.automator.add("ratio",this.ratio),this.automator.add("attack",this.attack),this.automator.add("release",this.release),this.automator.add("knee",this.knee),this.modify(t,0)}get attack(){return this.node.attack}get knee(){return this.node.knee}get ratio(){return this.node.ratio}get release(){return this.node.release}get threshold(){return this.node.threshold}get input(){return this.node}get output(){return this.node}get getOptions(){return this.options}async modify(e,t){typeof e.attack=="number"&&(this.attack.cancelScheduledValues(0),this.attack.linearRampToValueAtTime(j(e.attack,0,1),t)),typeof e.knee=="number"&&(this.knee.cancelScheduledValues(0),this.knee.linearRampToValueAtTime(j(e.knee,0,40),t)),typeof e.ratio=="number"&&(this.ratio.cancelScheduledValues(0),this.ratio.linearRampToValueAtTime(j(e.ratio,1,20),t)),typeof e.release=="number"&&(this.release.cancelScheduledValues(0),this.release.exponentialRampToValueAtTime(j(e.release,0,1),t)),typeof e.threshold=="number"&&(this.threshold.cancelScheduledValues(0),this.threshold.linearRampToValueAtTime(j(e.threshold,-100,0),t)),await new Promise(i=>{setTimeout(()=>{i()},rn((t-this.context.currentTime)*1e3,0))})}};b(ci,"typename",Ia);var Ts="PingPongDelayInsert",Ui=class{constructor(e,t={id:Ts}){b(this,"typename",Ts),b(this,"id",Ts),b(this,"automator",new gi(["dry-gain","wet-gain","delay-time-left","delay-time-right","feedback"])),b(this,"options"),b(this,"inputGainNode"),b(this,"outputGainNode"),b(this,"dryGainNode"),b(this,"wetGainNode"),b(this,"feedbackGainNode"),b(this,"delayNodeLeft"),b(this,"delayNodeRight"),b(this,"channelMerger"),this.options=Object.assign({feedback:.5,mix:.5,delayTime:.3,maxDelayTime:1},t),this.maxDelayTime=t.maxDelayTime!==void 0?t.maxDelayTime:1,this.inputGainNode=e.createGain(),this.outputGainNode=e.createGain(),this.dryGainNode=e.createGain(),this.wetGainNode=e.createGain(),this.feedbackGainNode=e.createGain(),this.delayNodeLeft=e.createDelay(this.maxDelayTime),this.delayNodeRight=e.createDelay(this.maxDelayTime),this.channelMerger=e.createChannelMerger(2),this.inputGainNode.connect(this.dryGainNode),this.dryGainNode.connect(this.outputGainNode),this.delayNodeLeft.connect(this.channelMerger,0,0),this.delayNodeRight.connect(this.channelMerger,0,1),this.delayNodeLeft.connect(this.delayNodeRight),this.feedbackGainNode.connect(this.delayNodeLeft),this.delayNodeRight.connect(this.feedbackGainNode),this.inputGainNode.connect(this.feedbackGainNode),this.channelMerger.connect(this.wetGainNode),this.wetGainNode.connect(this.outputGainNode),this.id=t.id,this.automator.add("delay-time-left",this.delayNodeLeft.delayTime),this.automator.add("delay-time-right",this.delayNodeRight.delayTime),this.automator.add("dry-gain",this.dryGainNode.gain),this.automator.add("wet-gain",this.wetGainNode.gain),this.automator.add("feedback",this.feedbackGainNode.gain)}get input(){return this.inputGainNode}get output(){return this.outputGainNode}async modify(){await Promise.resolve(void 0)}get getOptions(){return this.options}get mix(){return this.options.mix}set mix(e){this.options.mix=e,this.dryGainNode.gain.value=Fm(this.mix),this.wetGainNode.gain.value=Um(this.mix)}get feedback(){return this.options.feedback}set feedback(e){e<0||e>1||(this.options.feedback=e,this.feedbackGainNode.gain.value=this.feedback)}get delayTime(){return this.options.delayTime}set delayTime(e){e<0||e>this.maxDelayTime||(this.options.delayTime=e,this.delayNodeLeft.delayTime.value=this.delayTime,this.delayNodeRight.delayTime.value=this.delayTime)}get maxDelayTime(){return this.options.maxDelayTime}set maxDelayTime(e){this.options.maxDelayTime=e}getPingPongDelayNodes(e){return e==="feedback"?this.feedbackGainNode:[this.delayNodeLeft,this.delayNodeRight]}getGeneratedGraph(){return{leftNode:this.inputGainNode,rightNode:this.outputGainNode}}};b(Ui,"typename",Ts);function af(e,t,i,s){switch(Be().debug("createInsert;",i),i){case di.typename:return new di(e,s);case ci.typename:return new ci(e,s);case hi.typename:return new hi(e,s);case ui.typename:return new ui(e,s);case li.typename:return new li(e,s,t);case Ui.typename:return new Ui(e,s);default:throw new Sr(`create insert failed to create any insert for, ${i}`)}}var nf=class{constructor(e,t,i,s){b(this,"insertMap",new Map),b(this,"inserts"),b(this,"audioContext"),b(this,"soundHandler"),b(this,"source"),b(this,"destination"),this.audioContext=e,this.soundHandler=t,this.source=i,this.destination=s,this.inserts=[]}create(e,t){Be().debug("[ecas] insert.create",e);let i=af(this.audioContext,this.soundHandler,e,t);this.add(i)}add(e){Be().debug("[ecas] insert.add");let t=$m(this.inserts);t!=null?(t.output.disconnect(this.destination),t.output.connect(e.input)):(this.source.disconnect(this.destination),this.source.connect(e.input)),e.output.connect(this.destination),this.inserts.push(e),this.insertMap.set(e.id,e)}remove(e){var t,i,s,a;Be().debug("[ecas] insert.remove",e);let n=[];for(let[r,u]of this.inserts.entries())if(u.id===e){let d=(i=(t=this.inserts[r+1])==null?void 0:t.input)!=null?i:this.destination,h=(a=(s=this.inserts[r-1])==null?void 0:s.output)!=null?a:this.source;h.disconnect(),u.output.disconnect(),h.connect(d)}else n.push(u);this.inserts=n,this.insertMap.delete(e)}get(e){if(!this.insertMap.has(e))throw new Sr(`[ecas] cannot get insert: ${e} since it does not exist`);return this.insertMap.get(e)}logInserts(){Be().log(this.inserts)}has(e){return typeof e=="string"?this.insertMap.has(e):Dm(this.inserts)}dispose(){for(let e of this.insertMap.keys())this.insertMap.delete(e);for(;this.inserts.length>0;){let e=this.inserts.pop();e==null||e.input.disconnect(),e==null||e.output.disconnect()}}};function Go(e,t){let i=e.typename===t;return i||Be().warn("[ecas] insert",e==null?void 0:e.typename,"is not of type",t),i}function kr(e,t=0){let i=e.createStereoPanner();return i.pan.value=Lt(t,-1,1),i}function Mo(e,t=1){let i=e.createGain();return i.gain.value=Math.max(t,0),i}function of(e,t){let i=e.createBufferSource();i.buffer=e.createBuffer(2,128,e.sampleRate),i.connect(t),i.loop=!0,i.start()}var It,Ss,Ns,st,je,ke,rf=class{constructor(e,t,i){this.automator=new jh(["gain","pan"]),f(this,It,void 0),f(this,Ss,void 0),f(this,Ns,void 0),f(this,st,void 0),f(this,je,void 0),f(this,ke,void 0),P(this,It,e),P(this,Ss,t),P(this,st,Mo(e,1)),P(this,ke,Mo(e,Lt(i.volume,.001,20))),P(this,je,kr(e,Lt(i.pan,-1,1))),of(o(this,It),o(this,st)),o(this,st).connect(o(this,je)).connect(o(this,ke)),this.setGain(i.volume),this.setPan(i.pan),P(this,Ns,i.id),this.inserts=new nf(o(this,It),o(this,Ss),o(this,st),o(this,je)),this.automator.add("gain",o(this,ke).gain),this.automator.add("pan",o(this,je).pan)}get input(){return o(this,st)}get output(){return o(this,ke)}get id(){return o(this,Ns)}get pannerNode(){return o(this,je)}get gainNode(){return o(this,ke)}get gain(){return o(this,ke).gain}setGain(e,t=0){let i=Lt(e,.001,20);return o(this,ke).gain.cancelScheduledValues(0),o(this,ke).gain.exponentialRampToValueAtTime(i,o(this,It).currentTime+.03+t),new Promise(s=>y.setTimeout(()=>s(),(.03+t)*1e3,String(Ma.next())))}setPan(e,t=0){return o(this,ke).gain.cancelScheduledValues(0),o(this,je).pan.linearRampToValueAtTime(Lt(e,-1,1),o(this,It).currentTime+.03+t),new Promise(i=>y.setTimeout(()=>i(),(.03+t)*1e3,String(Ma.next())))}get pan(){return o(this,je).pan}dispose(){o(this,st).disconnect(),o(this,ke).disconnect(),o(this,je).disconnect()}};It=new WeakMap,Ss=new WeakMap,Ns=new WeakMap,st=new WeakMap,je=new WeakMap,ke=new WeakMap;var Kt,_i,Jt,Ps,Ra,uf=class{constructor(e,t,i){f(this,Kt,new Map),f(this,_i,new Map),f(this,Jt,void 0),f(this,Ps,void 0),f(this,Ra,n=>{let r=new rf(o(this,Jt),o(this,Ps),n);r.id===Hi?r.output.connect(o(this,Jt).destination):r.output.connect(this.get(n.destination).input),o(this,Kt).set(r.id,r),o(this,_i).set(r.id,{inputs:[],outputs:[{index:0,originalDestinationNode:n.destination,node:o(this,Jt).destination,nodeId:r.id+"_0",soundContext:null,isUsed:!0}]})}),P(this,Jt,e),P(this,Ps,t);let s=new _s({id:ys,destination:Hi});i.unshift(s);let a=new _s({id:Hi,destination:null});i.unshift(a),df(i).forEach(o(this,Ra))}get(e){if(!o(this,Kt).has(e))throw new So(`[ecas] cannot get bus: ${e} since it does not exist`);return o(this,Kt).get(e)}getBusConnections(e){if(!o(this,_i).has(e))throw new So(`[ecas] cannot get bus: ${e} since it does not exist`);return o(this,_i).get(e)}purgeConnections(e,t,i,s){let a=this.getBusConnections(s);Fo(a.inputs)||(a.inputs=a.inputs.filter(n=>n.soundContext.id!==e&&n.soundContext.parentId!==t&&n.soundContext.soundSource!==i&&n.soundContext.bussId!==s))}dispose(){for(let e of o(this,Kt).values())e.dispose()}};Kt=new WeakMap,_i=new WeakMap,Jt=new WeakMap,Ps=new WeakMap,Ra=new WeakMap;function df(e){let t=e.map(i=>[i.id,i.destination]);return jp(t).map(i=>e.reduce((s,a)=>s.id===i?s:a))}function lf(e){return e.type==="bus"?hf(e):cf(e)}function hf(e){let{getBuss:t,targetId:i}=e;return Gr(e,[t(i)])}function cf(e){let{targetId:t,parentId:i,getSoundConnections:s}=e,a=s(A(t,i));return Gr(e,a)}function Gr(e,t){let{targetId:i,parentId:s,getSoundContexts:a,param:n}=e,r=new Array;for(let u of t)switch(n){case"volume":r.push(u.gainNode.gain);break;case"pan":r.push(u.pannerNode.pan);break;case"pitch":{let d=a(i,s).pop();if(Ze(d)){let h=d.soundSource;if(Ze(h)){let p=h.source;r.push(p.playbackRate)}}break}default:l().warn('[ecas] createAudioParamArray needs either "volume", "pan" or "pitch" as param type');break}return r}function pf(e){let t=["volume","pan","pitch"];function i(d){return t.includes(d)}let{targetId:s,targetParam:a,targetType:n,soundConfig:r,soundHandler:u}=e;if(n==="sound"){let d=u.getSound(s);i(a)||l().warn("[ecas] targetType is sound, but param is not eligible on sound.",s,a,n);let h=d[a];return Ut(h)?Mr(h):h}return r.buses.filter(d=>d.id===s)[0][a]}function Mr(e){return Ut(e)?Mr(e[0]):e[0]}function Or(e,t){if(sn(e)){e();return}if(X(e)){t.triggerOnEndedEvent(e);return}l().warn("[ecas] invalid parameter type specified in onEnded.")}var Ii,Oe,Es,le,ge,As,fe,Ye,Da,Cr,Vs,Va,La,Oo,Zt,Ri,mf=class{constructor(e,t,i,s,a){f(this,Da),f(this,Vs),f(this,La),f(this,Zt),f(this,Ii,void 0),f(this,Oe,void 0),f(this,Es,void 0),f(this,le,void 0),f(this,ge,void 0),f(this,As,void 0),f(this,fe,void 0),f(this,Ye,void 0),P(this,le,e),P(this,fe,i),P(this,Ye,s),P(this,Ii,a),P(this,As,t),P(this,Oe,{}),P(this,Es,{}),P(this,ge,{}),this.buses=new uf(o(this,le),o(this,Ye).soundHandler,t.soundConfig.buses)}get audioContext(){return o(this,le)}get assetHandler(){return o(this,Ye)}get elementSoundSources(){return o(this,Es)}get soundConnections(){return o(this,Oe)}now(){return o(this,le).currentTime}pauseSound(e,t=e){let i=M(this,Zt,Ri).call(this,e,t),s=A(e,t);if(Ws(i))return null;for(let a of i)if(a&&!a.isPaused){a.startTimeSeconds=c.defaultNumber(a.startTimeSeconds),a.currentTime=c.defaultNumber(a.currentTime);let n=(a.currentTime+(this.now()-a.startTimeSeconds))%(o(this,Ye).soundHandler.getDurationSeconds(e)/a.playbackRate);a.currentTime=n,a.isPaused=!0,a.playing=!1,M(this,Vs,Va).call(this,e,t,a.soundSource,a.bussId),y.clearTimeout(s),a.isLoop||(y.clearTimeout(A(s,k.STOP)),y.clearTimeout(A(s,k.DEFAULT_STOP)))}}resumeSound(e,t=e){let i=M(this,Zt,Ri).call(this,e,t);if(i)for(let s of i)s&&s.isPaused?(s.startTimeSeconds=this.now(),this.connectSound(null,e,s,()=>{this.playSound(e,s)})):l().debug(`[ecas] unable to resume sound with sound id ${e}. sound was not paused`)}playSound(e,t){let i=A(e,t.parentId);o(this,fe).triggerAudioEvent(O.Sound.Play,e,i),mi(t.parentId)&&(t.parentId=e),mi(t.playbackRate)&&(t.playbackRate=1);let s=c.defaultNumber(t.startTimeSeconds),a=t.currentTime||c.defaultNumber(t.startPos),n=c.defaultNumber(t.delaySeconds);t.durationSeconds=c.defaultNumber(t.durationSeconds);let r=t.durationSeconds?t.durationSeconds:Number.POSITIVE_INFINITY,u=o(this,Ye).soundHandler.getDurationSeconds(e)/t.playbackRate-a,d=t.isLoop?void 0:Math.min(r||Number.POSITIVE_INFINITY,u);if(t.currentTime=a,t.delaySeconds=n||0,!t.isLoop&&!t.isScheduled&&r>=u){let h=o(this,le).currentTime+u,p=u-.03;y.setTimeout(this.stopSound.bind(this,e,t.parentId,h),p,A(i,k.DEFAULT_STOP))}t.isPaused=!1,this.createSourceNodeAndStartSource(e,t,d,s)}async createSourceNodeAndStartSource(e,t,i,s){let a=await(async r=>r?this.assetHandler.soundHandler.getAudioBufferReversed(e):this.assetHandler.soundHandler.getAudioBuffer(e))(t.reverse),n=bm(a,o(this,le),t);wm(n,i,s,t,e,o(this,fe),o(this,le))}stopSound(e,t=e,i=0,s){l().debug(`[ecas] stop sound ${e} at ${i} seconds with onEnded ${s}`),o(this,fe).triggerAudioEvent(O.Sound.Stop,e);let a=M(this,Zt,Ri).call(this,e,t);a&&a.forEach(n=>{s!==void 0&&(n.onEnded=()=>o(this,fe).triggerAudioEvent(s)),M(this,Da,Cr).call(this,e,n,i)})}logActiveSounds(){l().log(this.getActiveSounds())}getActiveSounds(){let e=[];for(let t of Object.keys(o(this,ge))){let i=o(this,ge)[t];i&&i.forEach(s=>{e.push(s.id)})}return e}removeSound(e,t,i,s){this.buses.purgeConnections(e,t,i,s),i.source&&(i.source.disconnect(),i.source=null)}buildAudioParamArray(e,t){return t.node?[t.node[t.param]]:lf(Re(C({targetId:e},t),{getSoundContexts:M(this,Zt,Ri).bind(this),getSoundConnections:this.getSoundConnections.bind(this),getBuss:this.buses.get.bind(this.buses)}))}playEnvelope(e,t){o(this,fe).triggerAudioEvent(O.Envelope.Play,e);let i=dm(t);i.parentId=t.parentId||e,i.startTime===0&&(i.startTime=o(this,le).currentTime);let s=this.buildAudioParamArray(e,i),a=n=>{i.audioParam=n;let r=n.value,u=o(this,Ii).getContexts(e);if(u.push(i),Nc(u)){let x=u[0],_=Ga({targetId:e,param:x.param,parentId:x.parentId,willStopSoundOnEnded:x.willStopSoundOnEnded});y.clearTimeout(_),n.cancelScheduledValues(0)}i.isPaused||(i.envelopePoints=ym(u,i.parentId));let d=(()=>i.envelopePoints.map(x=>x.val==="default"?pf({targetId:e,targetType:i.type,targetParam:i.param,soundConfig:o(this,As).soundConfig,soundHandler:o(this,Ye).soundHandler}):x.val==="current"?r:x.val))(),h=i.envelopePoints.map(x=>x.pos);if(i.param==="pitch")for(let x=0;x<d.length;x++)d[x]=c.pitchToPlaybackRate(d[x]);let p=gm({values:d,positions:h,curveType:i.curveType}),v=jo(i.envelopePoints.map(x=>x.pos))/1e3;n.cancelScheduledValues(i.startTime),n.setValueCurveAtTime(p,i.startTime,v);let E=.05;y.setTimeout(()=>{i.onplay&&i.onplay(),o(this,fe).triggerAudioEvent(O.Envelope.Start,e)},i.startTime+E,A(e,k.ENVELOPE_SCHEDULED,"START")),y.setTimeout(()=>{o(this,le).state!=="suspended"&&(i.onEnded&&(o(this,fe).triggerAudioEvent(O.Envelope.Ended,e),Or(i.onEnded,o(this,fe))),o(this,Ii).setContexts({id:e,contexts:u.filter(x=>i.parentId!==x.parentId)}))},v+E,Ga({targetId:e,param:i.param,parentId:i.parentId,willStopSoundOnEnded:t.willStopSoundOnEnded}))};if(t.isAFadeIn)a(s[s.length-1]);else for(let n of s)a(n)}connect(e,t){e.connect(t)}getSoundParam(e,t){return o(this,Ye).soundHandler.getSound(e)[t]}getSoundConnections(e){return ut(o(this,Oe)[e])||l().warn("[ecas] no sound connections found for id",e,"in",o(this,Oe)),o(this,Oe)[e]||[]}stopAll({onEnded:e}={}){Object.values(o(this,ge)).forEach(t=>{t.forEach(i=>{this.stopSound(i.id,i.parentId,0,e)})})}dispose(){this.stopAll(),this.buses.dispose()}connectSound(e,t,i,s=ce){ut(e)||(e=o(this,le).createBufferSource());let a=o(this,le).createGain(),n=Ze(i.pan)?Lt(c.randomizeValues(i.pan),-1,1):0,r=kr(o(this,le),n);e.disconnect(),e.connect(r),r.connect(a),a.connect(this.buses.get(i.bussId).input);let u=this.buses.getBusConnections(i.bussId).inputs,d=u.length,h=c.generateUniqueId(t),p={index:d,node:a,nodeId:h,soundContext:i,isUsed:!0};u.push(p);let v=Ze(i.volume)?Lt(c.randomizeValues(i.volume),.001,20):1;a.gain.value=v;let E=A(t,i.parentId);o(this,Oe)[E]=c.defaultValue(o(this,Oe)[E],[]),o(this,Oe)[E].push({context:i,audioEffectNodes:[],pannerNode:r,gainNode:a,sourceNode:e,nodeId:h}),o(this,ge)[t]=c.defaultValue(o(this,ge)[t],[]),i.parentId=c.defaultValue(i.parentId,t),i.isPaused||o(this,ge)[t].push(i);let x=Object.keys(o(this,ge)).length;i.soundSource={source:e,index:x},s(p)}};Ii=new WeakMap,Oe=new WeakMap,Es=new WeakMap,le=new WeakMap,ge=new WeakMap,As=new WeakMap,fe=new WeakMap,Ye=new WeakMap,Da=new WeakSet,Cr=function(e,t,i){let s=A(t.id,t.parentId);M(this,Vs,Va).call(this,e,t.parentId,t.soundSource,t.bussId,i),y.clearTimeout(s),t.isLoop||(y.clearTimeout(A(s,k.STOP)),y.clearTimeout(A(s,k.DEFAULT_STOP))),o(this,ge)[e]=o(this,ge)[e].filter(a=>a.parentId!==t.parentId),y.setTimeout(()=>{t.onEnded&&(o(this,fe).triggerAudioEvent(O.Sound.Ended,e),Or(t.onEnded,o(this,fe)))},i-this.now(),A(s,k.SOUND_COMPLETE))},Vs=new WeakSet,Va=function(e,t,i,s,a=0){let n=A(e,t),r=o(this,Oe)[n],u=i.source,d=i&&u&&u.buffer&&u.stop,h=p=>{M(this,La,Oo).call(this,p,e,t,i,s)};if(d)try{u.stop(a),r&&r.forEach(h),delete o(this,Oe)[n]}catch(p){l().error(p)}},La=new WeakSet,Oo=function(e,t,i,s,a){this.removeSound(t,i,s,a),e.pannerNode.disconnect(),e.gainNode.disconnect(),e.sourceNode.disconnect(),e.audioEffectNodes&&e.audioEffectNodes.forEach(n=>{n.node.disconnect()})},Zt=new WeakSet,Ri=function(e,t){let i=o(this,ge)[e];return i?i.filter(s=>s.parentId===t):null};function ff(){return typeof navigator!="undefined"&&navigator.userAgent!==void 0&&navigator.userAgent.match(/like Mac OS X/)!==null&&navigator.userAgent.match(/OS 14/)!==null}var gf=class{constructor(e,t={}){this.forceLegacy=!1,this.forcePolyfills={},this.packageToUse="desktop",this.preload=!1,this.soundData=new Map,this.pauseOnInvisible=!0,this.muteOnInvisible=!ff(),this.resumeOnVisible=!0,this.unmuteOnVisible=!0,this.logger="none",this.queue=!0,Object.assign(this,t),this.soundData=new Map(t.soundData);let i=vf(e);this.fileExtToUse=t.fileExtToUse||rm(i),i.includes(this.fileExtToUse)||l().error("[ecas] fileExtToUse:",this.fileExtToUse,"is not available.")}};function vf(e){let t=e.map(i=>i.presets.map(s=>s.formats.map(a=>a.format))).flat().flat().flat().map(i=>yf(i));return[...new Set(t)]}function yf(e){return`.${e}`}var bf=class{constructor(e={soundConfig:new vo,loadrConfig:{packageToUse:"desktop"}}){this.soundConfig=new vo(e.soundConfig),this.eventConfig=e.eventConfig||[],this.stateConfig=e.stateConfig||{genesis:{activatesOn:[],deactivatesOn:[],events:{},children:{}}},this.loadrConfig=new gf(this.soundConfig.settings.formatPresets,e.loadrConfig)}};function wf(e){return new bf(e)}var Ls=class{constructor(e){this.volume=1,this.pitch=0,this.pan=0,this.startTime=0,this.duration=0,this.startPos=0,this.loop=!1,this.args=[],this.onended=ce,this.onplay=ce,this.fadeIn=0,this.fadeOut=0,this.reverse=!1;var t,i,s;Object.assign(this,e),this.volume=(t=c.randomizeValues(e.volume))!=null?t:1,this.pitch=(i=c.randomizeValues(this.pitch))!=null?i:0,this.pan=(s=c.randomizeValues(this.pan))!=null?s:0,Fe(this.startTime)||(this.startTime=c.defaultNumber(this.startTime)/1e3),Fe(this.duration)||(this.duration=c.defaultNumber(this.duration)/1e3),Fe(this.startPos)||(this.startPos=c.defaultNumber(this.startPos)/1e3)}},Wi=class{constructor(e={}){this.delay=0,this.fadeOut=1,ye(e.fadeOut)&&(this.fadeOut=e.fadeOut),ye(e.delay)&&(this.delay=e.delay/1e3),this.fadeOut=Math.max(this.fadeOut,1),this.onEnded=e.onEnded}},Tf=class{constructor(e="time",t=-100,i=-30,s=2048,a=.8){this.mode=e,this.minDb=t,this.maxDb=i,this.fftSize=s,this.smoothingTimeConstant=a}},Sf=class{constructor(e=.6,t=ce){this._volumes=[],this._overInfos=[],this._averaging=.95,this._overLevel=.71,this._overLag=750,this._callback=t,this._averaging=e,this._init()}create(e){return this._processor=e.createScriptProcessor(512),this._processor.onaudioprocess=this._volumeAudioProcess.bind(this),this._processor.connect(e.destination),this._processor}destroy(){this._processor!==null&&(this._processor.disconnect(),this._processor.onaudioprocess=null,this._processor=null),this._volumes=[],this._overInfos=[]}_init(){this._volumes=[0,0],this._overInfos=[{over:!1,lastOver:0},{over:!1,lastOver:0}]}_volumeAudioProcess(e){let t=this._volumes[0],i=this._volumes[1];this._volumes[0]=0,this._volumes[1]=0;let s=(r,u)=>{let d=r.getChannelData(u),h=d.length;this._overInfos[u].lastOver+this._overLag<window.performance.now()&&(this._overInfos[u].over=!1);let p=d.reduce((E,x)=>E+x*x),v=Math.sqrt(p/h);v>=this._overLevel&&(this._overInfos[u].over=!0,this._overInfos[u].lastOver=window.performance.now()),this._volumes[u]=this._averaging>0?Math.max(v,this._volumes[u]*this._averaging):v};s(e.inputBuffer,0),s(e.inputBuffer,1);let a=this._volumes[0],n=this._volumes[1];(t!==a||i!==n)&&a>=0&&n>=0&&this._callback({volume:{left:a,right:n},clipping:{left:this._overInfos[0].over,right:this._overInfos[1].over}})}};function Nf(e){let t=e.AudioParam.prototype;!Y(t,"cancelAndHoldAtTime")&&Y(t,"cancelScheduledValues")&&(l().debug("[polyfill]: (AudioParam) installing cancelAndHoldAtTime"),F(t,"cancelAndHoldAtTime",{value:t.cancelScheduledValues})),Y(t,"automationRate")||(l().debug("[polyfill]: (AudioParam) installing automationRate"),F(t,"automationRate",{value:"a-rate"}))}function Pf(e=window){let t=e.AudioContext.prototype;class i{constructor(r,u={pan:0}){this.channelCount=2,this.channelCountMode="clamped-max",this.channelInterpretation="speakers",this.numberOfInputs=1,this.numberOfOutputs=1,this.addEventListener=()=>{},this.dispatchEvent=()=>{},this.removeEventListener=()=>{},this.isStereoPannerNode=!0,this.context=r,this._input=this.context.createGain(),this._output=this.context.createGain();let d=u.pan,h=this.context.createChannelSplitter(2),p=this.context.createGain(),v=this.context.createGain(),E=this.context.createGain(),x=this.context.createGain(),_=this.context.createChannelMerger(2),ie=this.context.createChannelMerger(2),De=this.context.createChannelMerger(2);this._input.connect(h),h.connect(p,0),h.connect(v,0),h.connect(E,1),h.connect(x,1),p.connect(_,0,0),x.connect(_,0,0),E.connect(ie,0,1),v.connect(ie,0,1),_.connect(De,0,0),ie.connect(De,0,1),De.connect(this._output),this.pan={get value(){return d},set value(I){p.gain.value=1-Math.max(I,0),x.gain.value=-Math.min(I,0),E.gain.value=1+Math.min(I,0),v.gain.value=Math.max(I,0),d=I},get automationRate(){return"a-rate"},get defaultValue(){return 0},get maxValue(){return 1},get minValue(){return 0},cancelAndHoldAtTime:I=>(At(I),this.pan),cancelScheduledValues:I=>(At(I),this.pan),exponentialRampToValueAtTime:(I,$)=>(At($),this.pan.value=I,this.pan),linearRampToValueAtTime:(I,$)=>(At($),this.pan.value=I,this.pan),setTargetAtTime:(I,$,_e)=>(At($,_e),this.pan.value=I,this.pan),setValueAtTime:(I,$)=>(At($),this.pan.value=I,this.pan),setValueCurveAtTime:(I,$,_e)=>(At($,_e),this.pan.value=Number(I[0]),this.pan)},this.pan.value=d}connect(...r){return this._output.connect.apply(this._output,r)}disconnect(...r){return this._output.disconnect.apply(this._output,r)}toString(){return"StereoPannerNode"}}function s(n,r){return new i(n,r)}F(t,"createStereoPanner",{value:function(n){return s(this,n)}});let a=e.AudioNode.prototype.connect;F(e.AudioNode.prototype,"connect",{value:function(n,r,u){function d(h){return Y(h,"isStereoPannerNode")&&h.isStereoPannerNode===!0}return d(n)&&(n=n._input),a.call(this,n,r||0,u||0)}})}function Ef(e){if(!e.webkitAudioContext)throw Error("[polyfill]: cannot install webkitAudioContext polyfill since webkitAudioContext does not exist on global.");function t(s){!s||s.setTargetAtTime||F(s,"setTargetAtTime",{value:s.setTargetValueAtTime})}let i=e.webkitAudioContext.prototype;Y(i,"createScriptProcessor")||F(i,"createScriptProcessor",{value:i.createJavaScriptNode}),Y(i,"createPeriodicWave")||F(i,"createPeriodicWave",{value:i.createWaveTable}),Y(i,"createGain")||F(i,"createGain",{value:function(){let s=this.createGainNode();return t(s.gain),s}}),Y(i,"createDelay")||F(i,"createDelay",{value:function(s){let a=this.createDelayNode(s);return t(a.delayTime),a}}),F(i,"internal_createBufferSource",{value:i.createBufferSource}),i.createBufferSource=function(){let s=this.internal_createBufferSource();return s.start?(F(s,"internal_start",{value:s.start}),s.start=function(a,n,r){s.internal_start(a||0,n||0,r)}):s.start=function(a,n,r){n||r?this.noteGrainOn(a||0,n,r):this.noteOn(a||0)},s.stop?(F(s,"internal_stop",{value:s.stop}),s.stop=function(a){s.internal_stop(a||0)}):s.stop=function(a){this.noteOff(a||0)},t(s.playbackRate),s},F(i,"internal_createDynamicsCompressor",{value:i.createDynamicsCompressor}),i.createDynamicsCompressor=function(){let s=this.internal_createDynamicsCompressor();return t(s.threshold),t(s.knee),t(s.ratio),t(s.reduction),t(s.attack),t(s.release),s},F(i,"internal_createBiquadFilter",{value:i.createBiquadFilter}),i.createBiquadFilter=function(){let s=this.internal_createBiquadFilter();return t(s.frequency),t(s.detune),t(s.Q),t(s.gain),s},Y(i,"createOscillator")&&(F(i,"internal_createOscillator",{value:i.createOscillator}),i.createOscillator=function(){let s=this.internal_createOscillator();return s.start?(F(s,"internal_start",{value:s.start}),s.start=function(a){s.internal_start(a||0)}):s.start=function(a){this.noteOn(a||0)},s.stop?(F(s,"internal_stop",{value:s.stop}),s.stop=function(a){s.internal_stop(a||0)}):s.stop=function(a){this.noteOff(a||0)},s.setPeriodicWave||(s.setPeriodicWave=s.setWaveTable),t(s.frequency),t(s.detune),s}),F(i,"internal_decodeAudioData",{value:i.decodeAudioData}),i.decodeAudioData=function(s,a,n){return new Promise((r,u)=>{this.internal_decodeAudioData(s,d=>{a&&a(d),r(d)},d=>{n&&n(d),u(d)})})},F(e,"AudioContext",{value:e.webkitAudioContext})}function Af(e,t=window){let i={AudioParam:"AudioParam"in t,AudioContext:"AudioContext"in t,OfflineAudioContext:"OfflineAudioContext"in t,webkitAudioContext:"webkitAudioContext"in t,webkitOfflineAudioContext:"webkitOfflineAudioContext"in t,createStereoPanner:"AudioContext"in t&&"createStereoPanner"in t.AudioContext.prototype||"webkitAudioContext"in t&&"createStereoPanner"in t.webkitAudioContext},s={AudioParam:e.AudioParam||i.AudioParam,webkitAudioContext:e.webkitAudioContext||i.webkitAudioContext&&!i.AudioContext,webkitOfflineAudioContext:e.webkitOfflineAudioContext||i.webkitOfflineAudioContext&&!i.OfflineAudioContext,createStereoPanner:e.createStereoPanner||!i.createStereoPanner};l().debug("[polyfill]:",i);let a=n=>{let[r]=Qo(n)(t);return r&&l().error(r),!r};return{AudioParam:s.AudioParam&&a(()=>{l().debug("[polyfill]: installing AudioParam"),Nf(t)}),webkitAudioContext:s.webkitAudioContext&&a(()=>{l().debug("[polyfill]: installing webkitAudioContext"),Ef(t)}),webkitOfflineAudioContext:s.webkitOfflineAudioContext&&a(()=>{l().debug("[polyfill]: installing webkitOfflineAudioContext"),F(t,"OfflineAudioContext",{value:t.webkitOfflineAudioContext})}),createStereoPanner:s.createStereoPanner&&a(()=>{l().debug("[polyfill]: installing createStereoPanner"),Pf(t)})}}function xf(e={}){return Af(e)}var kf=class{constructor(e,t=.03){this._scheduled=[],this._timeProvider=e,this._interval=t,this._intervalId=window.setInterval(this._update.bind(this),t*1e3)}get intervalId(){return this._intervalId}scheduleSound(e,t){this._scheduled.push({context:e,callback:t}),this._update()}cancelScheduledSound(e){this._scheduled=this._scheduled.filter(t=>!(t.context.id===e.id&&t.context.parentId===e.parentId))}_update(){let e=this._timeProvider();this._scheduled=this._scheduled.filter(t=>{let i=t.context;return i.startTimeSeconds=ye(i.startTimeSeconds)?i.startTimeSeconds:0,i.startTimeSeconds-e<=this._interval?(t.callback(i.id,i),!1):!0})}};function Gf(e){return 60/(e.tempo/(1/e.timeSignature.unit*4))}var ji,ei,$e,Ke,Ue,ve,te,Ce,Vt,pe,Ge,Me,Ht,ti,ii,ni,pi,oi,ri,me,Di,G,Hs,V,R,Ha,_r,Wa,Ir,ja,Rr,xs,Ua,Fa,Dr,ks,Gs,fa,$a,Vr,Ba,Lr,Ms,za,rt,Wt,qa,Hr,Qa,Wr,Xa,jr,at,Rt,Ya,Ur,Mf=class{constructor(e,t,i,s){f(this,Ha),f(this,Wa),f(this,ja),f(this,xs),f(this,Fa),f(this,Gs),f(this,$a),f(this,Ba),f(this,Ms),f(this,rt),f(this,qa),f(this,Qa),f(this,Xa),f(this,at),f(this,Ya),f(this,ji,void 0),f(this,ei,void 0),f(this,$e,void 0),f(this,Ke,void 0),f(this,Ue,void 0),f(this,ve,void 0),f(this,te,void 0),f(this,Ce,void 0),f(this,Vt,void 0),f(this,pe,void 0),f(this,Ge,void 0),f(this,Me,void 0),f(this,Ht,void 0),f(this,ti,void 0),f(this,ii,void 0),f(this,ni,void 0),f(this,pi,void 0),f(this,oi,void 0),f(this,ri,void 0),f(this,me,new Map),f(this,Di,void 0),f(this,G,void 0),f(this,Hs,void 0),f(this,V,void 0),f(this,R,{timeSignature:{meter:4,unit:4},triggerQuantize:1}),f(this,ks,(a,n,r)=>{o(this,pe)[n+r]&&(o(this,pe)[n+r]=o(this,pe)[n+r].filter(u=>u.target!==a)),o(this,Me)[n+r]--}),P(this,G,t),P(this,Hs,i),P(this,V,s),P(this,ei,{}),P(this,$e,[]),P(this,te,{}),P(this,Ce,{}),P(this,Vt,{}),P(this,pe,{}),P(this,Ge,{}),P(this,Me,{}),P(this,Ht,{}),P(this,ti,{}),P(this,ii,{}),P(this,ni,{}),P(this,oi,{}),P(this,pi,{}),P(this,ri,{}),P(this,Di,e),P(this,R,{triggerQuantize:e.soundConfig.settings.triggerQuantize,timeSignature:{meter:4,unit:4}}),P(this,ji,new kf(o(this,G).now.bind(o(this,G)),.03)),M(this,Xa,jr).call(this,o(this,Di).soundConfig.pools),setInterval(M(this,Ya,Ur).bind(this),.03)}setTempo(e){o(this,R).tempo=e}setTimeSignature(e){o(this,R).timeSignature=e}setTriggerQuantize(e){o(this,R).triggerQuantize=e}playSound(e,t,i=e,s=!0,a=!1){l().debug("[ecas] play sound","id:",e,"args:",t,"parent:",i,"relativeTime:",s,"isScheduled:",a);let n=o(this,G).now(),{volume:r,pan:u,loop:d,pitch:h,reverse:p,duration:v,startPos:E,startTime:x,args:_}=t,ie=s?x+n:x,De=Math.max(ie-n,0);if(De>=.03){o(this,me).has(e)||o(this,me).set(e,0),o(this,me).set(e,o(this,me).get(e)+1),y.setTimeout(()=>{t.startTime=ie;let Ve=!1;this.playSound(e,t,i,Ve)},De-.03,A(e,k.SOUND_START,o(this,me).get(e).toString()));return}let I=o(this,V).soundHandler.getSound(e),$=I.group,_e=I.type,vi=o(this,V).getGroup($).bus,Ft=c.pitchToPlaybackRate(h),yi=(o(this,V).soundHandler.getDurationSeconds(e)-E)/Ft,ze=A(e,"",k.STOP),w=yi;v>0&&(w=v),y.hasTimeout(ze)&&y.clearTimeout(ze),M(this,Ha,_r).call(this,e,i);let $t={id:e,bussId:vi,volume:r,pan:u,isPaused:!1,isLoop:d,type:_e,startTimeSeconds:ie,durationSeconds:w,startPos:E,currentTime:0,parentId:i,group:o(this,V).getGroup($),onEnded:()=>M(this,rt,Wt).call(this,t.onended),onSourceNodeEnded:()=>{let Ve=o(this,te)[$],dt=Ve.map(lt=>lt.id).indexOf(e);Ve.splice(dt,1),o(this,Ce)[e].shift()},delaySeconds:De,pitch:h,playbackRate:Ft,reverse:p,args:_,fadeIn:t.fadeIn,fadeOut:t.fadeOut,isScheduled:a};M(this,Wa,Ir).call(this,I,e),o(this,G).connectSound(null,e,$t),o(this,pi)[e+i]=$t,o(this,ji).scheduleSound($t,()=>{let Ve=[t.onplay];if(t.fadeIn>0){let dt=new Ds({curveType:"s-curve",startTime:n,isAFadeIn:!0,param:"volume",type:"sound",envelopePoints:[{pos:0,val:0},{pos:t.fadeIn,val:t.volume}]}),lt=()=>{o(this,G).playEnvelope(e,dt)};Ve.push(lt)}if(w<yi&&!d){let dt=()=>{this.stopSound(e,new Wi({delay:w*1e3-t.fadeOut,fadeOut:t.fadeOut}),i,!0)};Ve.push(dt)}M(this,ja,Rr).call(this,I,$t,n,Ve)})}playPool(e,t={},i=e){let s=o(this,G).now(),a=c.defaultNumber(t.startTime,0,o(this,R),s),n=t.startItem;if(o(this,Me)[e+i]===void 0&&(o(this,Me)[e+i]=0),o(this,Me)[e+i]++,a>0){y.setTimeout(()=>{t.startTime=0,this.playPool(e,t,i)},a,A(e,i,k.POOL_PLAY,Number(o(this,Me)[e+i]).toString()));return}if(o(this,ve)[e+i]=c.defaultValue(o(this,ve)[e+i],{counter:0,poolItems:[]}),ye(n)&&!this.setPoolIndex(e,n))return;let r=M(this,Qa,Wr).call(this,e,t.reset);if(!r){l().warn("[ecas] unable to play pool '"+e+"'.");return}r.type=c.defaultValue(r.type,"sound");let u={startPos:c.defaultNumber(t.startPos,0,o(this,R),0),argsDur:c.defaultNumber(t.duration,0,o(this,R),0),itemDuration:Q(r.duration)?r.duration/1e3:c.defaultNumber(r.duration,0,o(this,R),0),itemDelay:Q(r.delay)?r.delay/1e3:c.defaultNumber(r.delay,0,o(this,R),s),itemStartPos:Q(r.startPos)?r.startPos/1e3:c.defaultNumber(r.startPos,0,o(this,R),0),itemVolume:c.sumVolume(r.volume,c.defaultNumber(t.volume,1)),itemPan:c.sumPan(r.pan,t.pan),itemPitch:c.sumPitch(r.pitch,t.pitch)},d=Math.min(u.argsDur||Number.MAX_VALUE,u.itemDuration||Number.MAX_VALUE);if(d=d===Number.MAX_VALUE?0:d,d+=a,u.itemDelay=c.sumPos(u.itemDelay,a),u.itemStartPos=c.sumPos(u.itemStartPos,u.startPos),u.itemDuration=d?Math.min(d,u.itemDuration):u.itemDuration,d){let h=e+i+k.POOL_STOP;y.setTimeout(()=>this.stopPool(e),d,h)}switch(r.type){case"sound":M(this,Fa,Dr).call(this,e,i,u,r,t);break;case"pool":{let h={volume:u.itemVolume,pan:u.itemPan,loop:r.loop||t.loop,startTime:u.itemDelay,startPos:u.itemStartPos,pitch:u.itemPitch,onEnded:()=>M(this,xs,Ua).call(this,t,r,e,i),duration:u.itemDuration};this.playPool(r.target,h,e);break}case"pattern":{let h={startTime:u.itemDelay,startPos:u.itemStartPos,onEnded:()=>M(this,xs,Ua).call(this,t,r,e,i),duration:u.itemDuration};this.playPattern(r.target,h,e);break}default:break}o(this,pe)[e+i]=c.defaultValue(o(this,pe)[e+i],[]),o(this,pe)[e+i].push(r),o(this,ni)[e+i]=t}resetPool(e){if(!o(this,V).hasPool(e)){l().warn("[ecas] unable to reset pool with id '"+e+"'.");return}o(this,Ue)[e]=0}playEnvelope(e,t,i){let s=o(this,G).now(),a=c.defaultNumber(t.startTime,0,o(this,R),s),n=a>s+.03,r=()=>{let d=A(i,k.ENVELOPE_SCHEDULED,e);y.setTimeout(()=>{this.playEnvelope(e,t,i)},a-(s+.03),d)};if(n){r();return}let u=new Ds({startTime:a,param:t.param,curveType:t.curveType,type:t.type,onEnded:t.onEnded,onplay:t.onplay,willStopSoundOnEnded:t.willStopSoundOnEnded,envelopePoints:t.envelopePoints,parentId:i});t.type==="sound"&&o(this,G).playEnvelope(e,u)}stopSound(e,t,i,s){if(l().debug("[ecas] stopping sound: ",e),o(this,V).soundHandler.getSound(e),t.delay){let u=o(this,te)[o(this,V).soundHandler.getSound(e).group];u==null||u.forEach(d=>{d.isStoppingSoon=!0})}else if(t.fadeOut){let u=o(this,te)[o(this,V).soundHandler.getSound(e).group];u==null||u.forEach(d=>{d.isFadingOut=!0})}let a=c.defaultNumber(t.delay,0,o(this,R),o(this,G).now()),n=o(this,G).now()+a,r=o(this,me).get(e);if(r){for(let u=1;u<=r;u++){let d=A(e,k.SOUND_START,u.toString());y.clearTimeout(d),y.hasTimeout(d)&&!a&&y.resume(d)}o(this,me).set(e,0)}a>0?M(this,$a,Vr).call(this,a,t,e,i,s,n):M(this,Ba,Lr).call(this,t,e,i,n),M(this,qa,Hr).call(this,e,i)}stopPool(e,t=0,i=e){let s=o(this,G).now(),a=o(this,pe)[e+i],n=c.defaultNumber(t,0,o(this,R),s);if(n>=.03){y.setTimeout(()=>{let r=o(this,G).now()-s,u=n-r;this.stopPool(e,u,i)},n-.03,A(e,k.POOL_STOP));return}if(delete o(this,ve)[e+i],a!==void 0){if(n){y.setTimeout(()=>this._stopAndDeletePoolItems(a,e,i),n);return}this._stopAndDeletePoolItems(a,e,i)}}_stopAndDeletePoolItems(e,t,i){for(let n of e)n.type==="sound"||!n.type?this.stopSound(n.target,new Wi,t):n.type==="pool"?this.stopPool(n.target,0,t):n.type==="pattern"&&this.stopPattern(n.target,0,t);delete o(this,pe)[t+i],delete o(this,ni)[t+i];let s=o(this,Me)[t+i],a=A(t,k.POOL_PLAY);for(let n=0;n<s;n++)y.clearTimeout(A(a,n.toString()));o(this,Me)[t+i]=0,y.clearTimeout(a)}pauseSound(e,t,i=e){let s=o(this,G).now();t=c.defaultNumber(t,0,o(this,R),s);let a=o(this,me).get(e);if(a){for(let n=1;n<=a;n++)y.pause(A(e,k.SOUND_START,n.toString()));o(this,me).set(e,0)}if(t>=.03){y.setTimeout(()=>{let n=o(this,G).now()-s,r=t-n;this.pauseSound(e,r,i)},t-.03,A(e,k.SOUND_PAUSE));return}P(this,$e,o(this,$e).filter(n=>n.id!==e&&n.parentId!==i)),t?y.setTimeout(()=>{o(this,G).pauseSound(e,i)},t,e):o(this,G).pauseSound(e,i)}pausePool(e,t,i){i=i||e;let s=o(this,pe)[e+i];if(!s){l().warn("[ecas] unable to pause pool:",e);return}let a=o(this,G).now();if(t=c.defaultNumber(t,0,o(this,R),a),t>=.03){y.setTimeout(()=>{let u=o(this,G).now()-a,d=t-u;this.pausePool(e,d,i)},t-.03,e+k.POOL_PAUSE);return}let n=u=>{switch(u.type){case"pattern":this.pausePattern(u.target,0,i);break;case"pool":this.pausePool(u.target,0,i);break;case"sound":this.pauseSound(u.target,0,e);break;default:l().warn("[ecas] Sequencer.pausePool; item.type not set");break}},r=o(this,Me)[e+i];for(let u=0;u<r;u++)y.pause(A(e,i,k.POOL_PLAY,u.toString()));t?y.setTimeout(()=>{s.forEach(n),o(this,Ht)[e+i]=!0},t):(s.forEach(n),o(this,Ht)[e+i]=!0)}resumeSound(e,t,i=e){let s=o(this,G).now(),a=c.defaultNumber(t,0,o(this,R),s);if(a>=.03){y.setTimeout(()=>{let r=o(this,G).now()-s,u=a-r;this.resumeSound(e,u,i)},a-.03,A(e,k.SOUND_RESUME));return}let n=o(this,me).get(e);if(n){for(let r=1;r<=n;r++){let u=A(e,k.SOUND_START,r.toString());y.hasTimeout(u)&&!a&&y.resume(u)}o(this,me)[e]=0}if(a>0){y.setTimeout(()=>o(this,G).resumeSound(e,i),a);return}o(this,G).resumeSound(e,i)}resumePool(e,t=0,i=e){let s=o(this,G).now(),a=c.defaultNumber(t,0,o(this,R),s);if(a>=.03){y.setTimeout(()=>{let r=o(this,G).now()-s,u=a-r;this.resumePool(e,u,i)},a-.03,A(e,k.POOL_RESUME));return}let n=c.filterUnique(o(this,pe)[e+i],["target","type"]);if(a>0){y.setTimeout(()=>M(this,Ms,za).call(this,n,e,i),a);return}M(this,Ms,za).call(this,n,e,i)}playPattern(e,t={},i,s=!0){i=i||e,t=c.defaultValue(t,{});let a=o(this,G).now(),n=wa(o(this,R)),r=o(this,Di).soundConfig.patterns.filter(w=>w.id===e)[0];if(o(this,ei)[e+i]=0,!r)return l().warn("[ecas] unable to play pattern with id '"+e+"'."),null;n.tempo=r.tempo||n.tempo,mi(n.triggerQuantize)&&(n.triggerQuantize=1),n.timeSignature=cr(r.timeSignature)||n.timeSignature;let u=Gf(n),d=c.defaultNumber(t.startTime,0,n,a);s&&(d+=a);let h=d-a,p=a+.03;if(d>=p){y.setTimeout(()=>{t.startTime=d,this.playPattern(e,t,i,!1)},d-p,A(e,k.PATTERN_PLAY));return}let v=c.defaultNumber(t.startPos,0,n,0)/1e3,E=Math.max(c.defaultNumber(t.duration,0,n,0)/1e3,0),x=r.pattern.length,_=n.triggerQuantize*(n.triggerQuantize>=1?n.timeSignature.meter:1),ie=u*_,De=a;r.pattern.sort(w=>w.sound?-1:1);let I=r.pattern,$=()=>{let w=o(this,ei)[e+i];w||(w=0),w++,o(this,ei)[e+i]=w,w===x&&t.onEnded&&M(this,rt,Wt).call(this,t.onEnded)},_e=0,vi=0,Ft=!1,yi=!0;for(let w of I){w.parentId=i,o(this,Ge)[e+i]=c.defaultValue(o(this,Ge)[e+i],[]),o(this,Ge)[e+i].push(w);let $t=Q(w.startPos)?w.startPos/1e3:w.startPos,Ve=Q(w.duration)?w.duration/1e3:w.duration,dt=Q(w.delay)?w.delay/1e3:w.delay,lt=o(this,V).soundHandler.getDurationSeconds(w.sound),ht=c.defaultNumber(Ve,0,n,0),et=ht;et===0&&w.sound&&(et=lt);let Br=Math.round(Math.max(et/ie,1)),bi=w.loop&&r.sync?Br*ie:lt;vi=Math.max(vi,w.loop&&r.sync?bi:0);let Le=c.sumPos(c.defaultNumber($t,0,n,0),v);Le===bi&&(Le=0),Le>=lt&&bi&&w.loop&&(Le=Le%bi);let Bt=c.sumPos(c.defaultNumber(dt,0,n,a),h);if(ht=Math.max(ht,0),et=w.loop&&!r.sync?ht:et+Bt-Le,_e=Math.max(_e,et),w.sound)if(w.loop?Ft=!0:yi=!1,r.sync){let be=new Ls({startTime:Bt+a,volume:w.volume,pan:w.pan,loop:!1,startPos:Le,duration:ht,pitch:w.pitch,args:w.args,onended:et===Number.MAX_VALUE||w.loop?null:$});M(this,at,Rt).call(this,w,e,be,bi)}else{let be=new Ls({startTime:Bt+a,volume:w.volume,pan:w.pan,loop:w.loop,startPos:Le,duration:ht,pitch:w.pitch,args:w.args,onended:et===Number.MAX_VALUE||w.loop?null:$});be.startTime<=a?this.playSound(w.sound,be,e,!1):M(this,at,Rt).call(this,w,e,be)}else if(w.envelope){let be=w.envelope,ct=on({startTime:Bt+a,param:be.param,envelopePoints:be.data,onEnded:$});if(ct.type=w.soundId?"sound":"bus",w.bussId||w.soundId)if(ct.startTime<=a){let zt=w.bussId||w.soundId;this.playEnvelope(zt,ct)}else M(this,at,Rt).call(this,w,e,ct);else{let zt=!1;r.pattern.forEach($i=>{if($i.sound){let wi=wa(ct);wi.onEnded=zt?null:$,wi.type="sound",w.soundId=$i.sound,M(this,at,Rt).call(this,w,e,wi),zt=!0}})}}else if(w.pattern){let be={startTime:Bt,onEnded:$,startPos:Le,duration:ht};M(this,at,Rt).call(this,w,e,be)}else if(w.pool){let be=c.defaultNumber(w.duration)/1e3,{volume:ct,pan:zt,loop:$i}=w,wi={volume:ct,pan:zt,loop:$i,startTime:Bt,duration:be,startPos:Le,onEnded:$};M(this,at,Rt).call(this,w,e,wi)}}let ze=Math.min(_e>0?_e:Number.MAX_VALUE,E||Number.MAX_VALUE);!yi&&Ft&&(ze=E>0?E:0),Ft&&E>_e&&(ze=E),(vi===0||E>0)&&(De+=ze+h,o(this,V).setPatternContext(e+i,{pattern:r,endTime:De,onEnded:t.onEnded}),o(this,ii)[e+i]=t,ze>0&&ze!==Number.MAX_VALUE&&y.setTimeout(()=>this.stopPattern(e,0,i),ze+h,A(e,k.SCHEDULED,i,k.PATTERN)))}pausePattern(e,t=0,i=null){i=i||e;let s=o(this,G).now();if(t=c.defaultNumber(t,0,o(this,R),s),t>=.03){y.setTimeout(()=>{let n=o(this,G).now()-s,r=t-n;this.pausePattern(e,r,i)},t-.03,A(e,k.PATTERN_PAUSE));return}let a=()=>{if(y.pause(A(e,k.PATTERN_PLAY)),!o(this,Ge)[e+i])return l().warn("[ecas] unable to pause pattern with id '"+e+"' and parentId '"+i+"'."),null;y.pause(A(e,i,k.PATTERN)),y.pauseMatching(new RegExp(A(e,k.SCHEDULED_REGEX))),o(this,Ge)[e+i].forEach(n=>{n.sound?this.pauseSound(n.sound,0,e):n.pattern?this.pausePattern(n.pattern,0,e):n.pool?this.pausePool(n.pool,0,e):n.envelope}),o(this,ti)[e+i]=!0};t=c.randomizeValues(t),t?y.setTimeout(a,t,A(e,i,k.PATTERN_PAUSE)):a()}resumePattern(e,t=0,i=e){let s=o(this,G).now(),a=c.defaultNumber(t,0,o(this,R),s);if(a>=.03){y.setTimeout(()=>{let r=o(this,G).now()-s,u=a-r;this.resumePattern(e,u,i)},a-.03,A(e,k.PATTERN_RESUME));return}let n="[ecas] unable to resume pattern with id '"+e+"'.";if(o(this,ti)[e+i]){let r=o(this,V).getPatternContext(e+i);if(!r||!r.pattern||!o(this,Ge)[e+i])return l().warn(n),null;y.resume(A(e,i,k.PATTERN)),y.resume(A(e,k.PATTERN_PLAY)),y.resumeMatching(new RegExp(A(e,k.SCHEDULED_REGEX))),o(this,Ge)[e+i].forEach(u=>{u.sound?this.resumeSound(u.sound,a,e):u.pool?this.resumePool(u.pool,a,e):u.pattern&&this.resumePattern(u.pattern,a,e)}),delete o(this,ti)[e+i];return}else if(o(this,V).getPatternContext(e+i)){let r=o(this,ii)[e+i];this.stopPattern(e),r.startTime=a,this.playPattern(e,r);return}l().warn(n)}stopPattern(e,t=0,i){i=i||e;let s=o(this,G).now();if(t=c.defaultNumber(t,0,o(this,R),s),t>=.03){y.setTimeout(()=>{let u=o(this,G).now()-s,d=t-u;this.stopPattern(e,d,i)},t-.03,A(e,k.PATTERN_STOP));return}let a=o(this,V).getPatternContext(e+i),n=o(this,Ge)[e+i];if(!n)return l().warn("[ecas] unable to stop pattern with id '"+e+"' and parentId '"+i+"'."),null;y.clearTimeout(A(e,i,k.PATTERN)),y.clearTimeout(A(e,k.PATTERN_PLAY)),y.clearMatching(new RegExp(A(e,k.SCHEDULED_REGEX))),n.forEach(u=>{let d;u.sound?(d=u.sound,this.stopSound(u.sound,new Wi({delay:t}),e)):u.pattern?(d=u.pattern,this.stopPattern(u.pattern,t,e)):u.pool&&(d=u.pool,this.stopPool(u.pool,t,e)),P(this,$e,o(this,$e).filter(h=>h.parentId!==e&&h.id!==d))});let r=a?a.onEnded:null;r&&M(this,rt,Wt).call(this,r),o(this,V).setPatternContext(e+i,null),delete o(this,Ge)[e+i],delete o(this,ii)[e+i]}stopAll(e={}){o(this,G).stopAll(e)}setPoolIndex(e,t){let i=t-1,s=o(this,Ke)[e].length;return t>s||t<1?(l().warn(`[ecas] sound item outbound exception with pool id '${e}'`),!1):(o(this,Ue)[e]=i,!0)}};ji=new WeakMap,ei=new WeakMap,$e=new WeakMap,Ke=new WeakMap,Ue=new WeakMap,ve=new WeakMap,te=new WeakMap,Ce=new WeakMap,Vt=new WeakMap,pe=new WeakMap,Ge=new WeakMap,Me=new WeakMap,Ht=new WeakMap,ti=new WeakMap,ii=new WeakMap,ni=new WeakMap,pi=new WeakMap,oi=new WeakMap,ri=new WeakMap,me=new WeakMap,Di=new WeakMap,G=new WeakMap,Hs=new WeakMap,V=new WeakMap,R=new WeakMap,Ha=new WeakSet,_r=function(e,t){let i=[A(e,t,k.STOP),A(e,k.VOLUME,t,k.STOP)];for(let s of i)y.hasTimeout(s)&&(y.clearTimeout(s),this.stopSound(e,new Wi,t))},Wa=new WeakSet,Ir=function(e,t){let i=e.group,s=o(this,V).getGroup(i);if(s.limit>0&&o(this,te)[i]){let a=o(this,te)[i],n=o(this,Ce)[t];if(a.length>=s.limit){let r=a[0];if(r.soundSource.source){if(a.shift(),n.shift(),y.clearTimeout(Ga({targetId:t,param:"volume",parentId:t,willStopSoundOnEnded:!0})),r.isFadingOut)return;r.soundSource.source.onended=ce,r.soundSource.source.stop();return}}else if(o(this,Ce)&&o(this,Ce)[t]&&o(this,Ce)[t].length>=s.limit){let r=n[0];a.shift(),n.shift(),r.soundSource.source.onended=ce,r.soundSource.source.stop()}}},ja=new WeakSet,Rr=function(e,t,i,s=[ce]){o(this,pi)[t.id+t.parentId]=null;let a=t.id,n=t.group,r=n.id,u=c.defaultNumber(t.delaySeconds);if(n.triggerLimit){let d=o(this,oi)[r]?o(this,oi)[r]:0,h=o(this,G).now()-d,p=n.triggerLimit/1e3-h;if(h<0||p>0){l().debug("[ecas] group triggerLimit reached","triggerLimitElapsed",h,"triggerLimitRemain",p);return}o(this,oi)[r]=i+u}if(e.triggerLimit){let d=o(this,ri)[a]?o(this,ri)[a]:0,h=i-d,p=e.triggerLimit/1e3-h;if(h<0||p>0){l().debug("[ecas] sound triggerLimit reached");return}o(this,ri)[a]=i+u}n.limit&&n.limit>0&&(o(this,Ce)[a]==null&&(o(this,Ce)[a]=[]),o(this,te)[r]==null&&(o(this,te)[r]=[]),o(this,Ce)[a].push(t),o(this,te)[r].push(t)),mi(n.crossfade)&&(n.crossfade=10),y.setTimeout(()=>{o(this,G).playSound(a,t);for(let d of s)d()},t.startTimeSeconds-o(this,G).now(),k.MIXER_PLAY_SOUND)},xs=new WeakSet,Ua=function(e,t,i,s){e.onItemEnded&&M(this,rt,Wt).call(this,e.onItemEnded),o(this,ks).call(this,t.target,i,s)},Fa=new WeakSet,Dr=function(e,t,i,s,a={}){let n=o(this,V).getPool(e),r=c.sumVolume(s.volume,c.defaultNumber(a.volume,1)),u=c.sumPan(s.pan,a.pan),d=c.sumPitch(s.pitch,a.pitch),h=new Ls({volume:r,pan:u,loop:s.loop||a.loop,pitch:d,onended:()=>{o(this,ve)[e+t]&&(o(this,ve)[e+t].counter--,o(this,ve)[e+t].counter===0&&(o(this,ve)[e+t].poolItems.forEach(v=>{v.onEnded&&M(this,rt,Wt).call(this,v.onEnded)}),o(this,ve)[e+t].poolItems=[])),y.clearTimeout(s.target+"_"+e),a.onItemEnded&&M(this,rt,Wt).call(this,a.onItemEnded),o(this,ks).call(this,s.target,e,t)},startTime:i.itemDelay,startPos:i.itemStartPos,duration:i.itemDuration}),p=o(this,Vt)[e];if(p||(p=[]),p.length>=n.limit){let v=p.shift();this.stopSound(v,null,e)}p.push(s.target),o(this,ve)[e+t].counter++,o(this,ve)[e+t].poolItems.push(a),this.playSound(s.target,h,e),o(this,Vt)[e]=p},ks=new WeakMap,Gs=new WeakSet,fa=function(e,t,i,s){let a=on({type:"sound",param:"volume",startTime:0,envelopePoints:[{pos:0,val:"current"},{pos:e.fadeOut,val:0}],curveType:"logarithmic",onEnded:()=>{let n=o(this,V).soundHandler.getSound(t);o(this,G).stopSound(t,i,s+e.fadeOut/1e3,e.onEnded),o(this,Ce)[t]=[],o(this,te)[n.group]=o(this,te)[n.group].filter(r=>r.id!==n.id)},willStopSoundOnEnded:!0});this.playEnvelope(t,a,i)},$a=new WeakSet,Vr=function(e,t,i,s,a,n){let r=A(i,s,k.STOP),u=e-.03,d=A(i,s,k.DEFAULT_STOP);a||(y.hasTimeout(d)?y.clearTimeout(d):d=r),y.setTimeout(()=>M(this,Gs,fa).call(this,t,i,s,n),u,d)},Ba=new WeakSet,Lr=function(e,t,i,s){let a=o(this,pi)[t+i];if(ut(a)){o(this,ji).cancelScheduledSound(a);return}M(this,Gs,fa).call(this,e,t,i,s)},Ms=new WeakSet,za=function(e,t,i){if(o(this,Ht)[t+i]){e.forEach(a=>{switch(a.type){case"pattern":this.resumePattern(a.target,0,t);break;case"pool":this.resumePool(a.target,0,t);break;case"sound":this.resumeSound(a.target,0,t);break;default:l().warn("[ecas] Sequencer._resumePausePoolItems; item.type not set");break}}),delete o(this,Ht)[t+i];let s=o(this,Me)[t+i];for(let a=0;a<s;a++)y.resume(A(t,k.POOL_PLAY,a.toString()));return}this.stopPool(t),this.playPool(t,o(this,ni)[t+i])},rt=new WeakSet,Wt=function(e){if(sn(e)){e();return}if(X(e)){o(this,Hs).triggerOnEndedEvent(e);return}l().debug("[ecas] invalid parameter type specified in onEnded.")},qa=new WeakSet,Hr=function(e,t){l().debug("[ecas] purge sound",e,t);let i=o(this,V).soundHandler.getSound(e),s=o(this,te)[i.group];if(s){let a=s.filter(n=>!(n.id===e&&n.parentId===t));o(this,te)[i.group]=a,o(this,Vt)[t]&&o(this,Vt)[t].pop()}},Qa=new WeakSet,Wr=function(e,t){if(!o(this,V).hasPool(e))return l().warn("[ecas] unable to play pool with id '"+e+"'."),null;let i=o(this,Ke)[e].length,s=o(this,V).getPool(e).type;(t||o(this,Ue)[e]>=i)&&(o(this,Ue)[e]=0,s==="random"&&(o(this,Ke)[e]=c.randomShuffle(o(this,Ke)[e])));let a=o(this,Ke)[e][o(this,Ue)[e]];return o(this,Ue)[e]++,a.pan=a.pan||0,a},Xa=new WeakSet,jr=function(e){P(this,Ke,{}),P(this,Ue,{}),P(this,ve,{});for(let t of e){let i=[];t.items.forEach((s,a)=>{if(t.priority){let n=t.priority[a];for(let r=0;r<n;r++)i.push(s)}else i.push(s)}),o(this,Ke)[t.id]=t.type==="random"?c.randomShuffle(i):i,o(this,Ue)[t.id]=0}},at=new WeakSet,Rt=function(e,t,i,s=0){let a=null,n=null,r=o(this,G).now();if(t=t||e.parentId,e.sound)a=e.sound,n=d=>{i.startTime=d,this.playSound(a,i,t,!1,s>0)};else if(e.pattern)a=e.pattern,n=d=>{i.startTime=d,this.playPattern(a,i,e.parentId)};else if(e.pool)a=e.pool,n=d=>{i.startTime=d,this.playPool(a,i,e.parentId)};else if(e.envelope&&hm(i)){a=e.envelope;let d=e.bussId||e.soundId;n=h=>{i.startTime=h,this.playEnvelope(d,i,t)}}else{l().warn("[ecas] attempting to schedule unknown pattern item type. Item: ",e);return}let u=c.defaultNumber(i.startTime,0,o(this,R),r);if(u===0)n(u);else{let d={eventMethod:n,loopLength:s,startTime:u,id:a,parentId:t};o(this,$e).push(d)}},Ya=new WeakSet,Ur=function(){let e=o(this,G).now(),t=[];P(this,$e,o(this,$e).filter(i=>{let s=i.loopLength>0,a=e+.03;return i.startTime<=a?(t.push({method:i.eventMethod,startTime:i.startTime}),s&&(i.startTime+=i.loopLength),s):!0})),t.forEach(i=>i.method(i.startTime))};var Co=/.*/;function _o(e,t){return new Promise(i=>{let s=e.createConstantSource();s.onended=()=>i(),s.start(0),s.stop(t)})}var B,D,Vi,U,nt,ee,Ka,Ja,Fr,Za=class{constructor(e,t){f(this,Ja),f(this,B,void 0),f(this,D,void 0),f(this,Vi,void 0),f(this,U,void 0),f(this,nt,void 0),f(this,ee,void 0),this.isMuted=!1,f(this,Ka,(r,u,d)=>{l().debug("[ecas] preload onprogress",{sucess:r,count:u,numberOfSoundsToPreload:d})}),Oc(l().log),P(this,ee,wf(e));let{soundConfig:i,eventConfig:s,stateConfig:a,loadrConfig:n}=o(this,ee);l().debug("[ecas] config:",e),l().debug("[ecas] options:",o(this,ee)),l().info("[ecas] file extension:",n.fileExtToUse),P(this,D,t!=null?t:new AudioContext),this.audioContext.addEventListener("statechange",()=>{let r=this.audioContext.state;switch(r){case"running":this.eventHandler.triggerAudioEvent(O.Context.Running);break;case"closed":this.eventHandler.triggerAudioEvent(O.Context.Closed);break;case"suspended":this.eventHandler.triggerAudioEvent(O.Context.Suspended);break;case"interrupted":this.eventHandler.triggerAudioEvent(O.Context.Interrupted);break;default:l().error("[ecas] AudioContext statechange event triggered with unknown state:",r);break}}),this.eventHandler=new zp(s,a,n,this),this.assetHandler=new om({ecasOptions:o(this,ee),audioContext:o(this,D),eventHandler:this.eventHandler}),P(this,Vi,new lm),P(this,B,new mf(o(this,D),o(this,ee),this.eventHandler,this.assetHandler,o(this,Vi))),y.dateProvider=()=>o(this,B).now.bind(o(this,B)),P(this,U,new Mf(o(this,ee),o(this,B),this.eventHandler,this.assetHandler)),this.setTempo(i.settings.tempo),this.setTriggerQuantize(i.settings.triggerQuantize),this.setTimeSignature(i.settings.timeSignature),this.eventHandler.triggerAudioEvent(O.Ready),this.shouldPauseOnInvisible=n.pauseOnInvisible,this.shouldMuteOnInvisible=n.muteOnInvisible,this.shouldResumeOnVisible=n.resumeOnVisible}set shouldMuteOnInvisible(e){let t=!this.isMuted,i=s=>{let a=s.target.visibilityState;a==="hidden"?(t=!this.isMuted,this.mute()):a==="visible"&&t&&this.unmute()};e?addEventListener("visibilitychange",i):removeEventListener("visibilitychange",i)}set shouldPauseOnInvisible(e){let t=null,i={is:!1,get:()=>i.is,set:a=>{i.is=a}},s=a=>{let n=a.target.visibilityState;l().debug("[ecas] visibility",n),n==="hidden"?(i.set(!0),t=window.setTimeout(()=>{i.get()&&this.pause().catch(l().error)},1e3)):n==="visible"&&(i.set(!1),window.clearTimeout(t),t=null)};e?addEventListener("visibilitychange",s):removeEventListener("visibilitychange",s)}set shouldResumeOnVisible(e){let t=i=>{i.target.visibilityState==="visible"&&(async()=>{await this.resume().catch(()=>!1)||l().debug("[ecas] failed to resume audio context using resume on visible")})().catch(l().error)};e?addEventListener("visibilitychange",t):removeEventListener("visibilitychange",t)}get options(){return o(this,ee)}static async create(e){ac()?ic():ya(e.loadrConfig.logger),l().debug("[ecas] create",e),xf(e.loadrConfig.forcePolyfills);let t=new AudioContext;return new Promise(i=>{if((t==null?void 0:t.state)==="running"){i(new Za(e,t));return}l().log("[ecas] waiting for user interaction so we can start audio context...");let s=()=>{let a=new AudioContext;i(new Za(e,a)),removeEventListener("click",s),removeEventListener("keypress",s),removeEventListener("touchstart",s)};window.addEventListener("click",s,{once:!0}),window.addEventListener("keypress",s,{once:!0}),window.addEventListener("touchstart",s,{once:!0})})}setLogger(e){ya(e)}setCustomLogger(e){ec(e)}get soundHandler(){return o(this,B).assetHandler.soundHandler}async preload(e=o(this,Ka)){if(l().debug("[ecas] preload"),!(Sc(o(this,ee).loadrConfig.preload)||$o(o(this,ee).loadrConfig.preload)))return;let t=Ut(o(this,ee).loadrConfig.preload)?o(this,ee).loadrConfig.preload:this.assetHandler.soundHandler.getAllSoundIds(),i=t.length;this.eventHandler.on(O.Preload.Progress,e);let s=0,a=()=>{s+=1;let n=!0;this.eventHandler.triggerAudioEvent(O.Preload.Progress,n,s,i)};this.eventHandler.on(O.Sound.LoadDone,a),this.eventHandler.triggerAudioEvent(O.Preload.Start),l().debug("[ecas] preloading these sounds:",t),await this.assetHandler.soundHandler.load(t),this.eventHandler.triggerAudioEvent(O.Preload.Done),this.eventHandler.off(O.Sound.LoadDone,a)}get audioContext(){return o(this,D)}async pause(){this.eventHandler.triggerAudioEvent(O.Pause),await this.pauseContext().catch(l().error),this.eventHandler.triggerAudioEvent(O.Timer.Pause),y.pauseMatching(Co)}async resume(){return this.eventHandler.triggerAudioEvent(O.Resume),this.resumeContext().then(()=>(this.eventHandler.triggerAudioEvent(O.Timer.Resume),y.resumeMatching(Co),!0)).catch(()=>!1)}async pauseContext(){l().debug("[ecas] pause - before:",o(this,D).state),this.eventHandler.triggerAudioEvent(O.Context.Pause),o(this,D).state==="running"&&(await o(this,D).suspend().catch(l().error),l().debug("[ecas] pause - after:",o(this,D).state))}async resumeContext(){if(l().debug("[ecas] resume - before:",o(this,D).state),this.eventHandler.triggerAudioEvent(O.Context.Resume),o(this,D).state==="running")return l().debug("[ecas] audio context is already running"),!0;if(o(this,D).state==="closed")return l().warn("[ecas] audio context is closed, cannot resume."),!1;let e=await new Promise(t=>{let i=()=>o(this,D).resume(),s=()=>{removeEventListener("onclick",i),removeEventListener("keypress",i),removeEventListener("touchstart",i),t(o(this,D).state)};window.addEventListener("onclick",i),window.addEventListener("keypress",i),window.addEventListener("touchstart",i),i().then(s).catch(a=>{l().warn("[ecas] failed to resume audio context",a),t(o(this,D).state)})}).catch(l().error);return l().debug("[ecas] resume - after:",e),e==="running"}setMasterVolume(e){if(l().debug("[ecas] setMasterVolume",e),!this.isMuted){this.busSetGain({busId:ys,gain:e});return}l().debug("[ecas] tried to set gain while muted.")}getMasterVolume(){return o(this,B).buses.get(ys).gain.value}get mixer(){return o(this,B)}muteUnmute(){this.isMuted?this.unmute():this.mute()}unmute(){this.eventHandler.triggerAudioEvent(O.Unmute),this.isMuted&&(this.isMuted=!1,this.busApplyEnvelope({busId:Hi,paramId:"gain",points:[{pos:0,val:"current"},{pos:500,val:1}]}))}mute(){this.eventHandler.triggerAudioEvent(O.Mute),!this.isMuted&&(this.busApplyEnvelope({busId:Hi,paramId:"gain",points:[{pos:0,val:"current"},{pos:500,val:0}]}),this.isMuted=!0)}getAudioContext(){return o(this,D)}now(){return o(this,B).now()}getActiveSounds(){return o(this,B).getActiveSounds()}async triggerGameEvent(e,...t){this.eventHandler.triggerGameEvent(e,...t)}async dispose(){l().debug("[ecas] dispose"),this.stopAll(),o(this,nt)&&Object.keys(o(this,nt)).forEach(this.busRemoveAnalyser),o(this,B).dispose(),this.eventHandler.dispose(),this.assetHandler.dispose(),o(this,Vi).dispose(),await this.pauseContext(),await o(this,D).close(),this.eventHandler=null,this.assetHandler=null,P(this,B,null),this.isMuted=!0,P(this,ee,null)}setTempo(e){l().debug("[ecas] setTempo",e),o(this,U).setTempo(e)}setTriggerQuantize(e){l().debug("[ecas] setTriggerQuantize",e),o(this,U).setTriggerQuantize(c.defaultNumber(e))}setTimeSignature(e){l().debug("[ecas] setTimeSignature",e),o(this,U).setTimeSignature(cr(e)||{meter:4,unit:4})}async loadAllSounds(){l().debug("[ecas] loadAllSounds"),await this.assetHandler.soundHandler.loadAll()}async loadTheseSounds(e){l().debug("[ecas] loadTheseSounds",e),await this.assetHandler.soundHandler.load(e)}async loadTheseEvents(e){l().debug("[ecas] loadTheseEvents",e),this.eventHandler.triggerAudioEvent(O.Events.LoadStart),await this.assetHandler.loadAssetsRelatedToEvents(e),this.eventHandler.triggerAudioEvent(O.Events.LoadDone)}playEnvelope(e,t={}){l().debug("[ecas] playEnvelope",e);let i=on(t);o(this,U).playEnvelope(e,i,e)}applyEnvelope({automator:e,paramId:t,curve:i,points:s,delay:a}){let n=this.audioContext.currentTime+(a||0),r=({val:v})=>v==="default"?e.getDefault(t):v==="current"?e.current(t):v,u=s.map(r),d=s.map(({pos:v})=>v),[h,p]=Qh[i||"linear"]([u,d]);return e.automate({paramId:t,valueCurve:h,when:n,duration:p}),_o(o(this,D),n)}cancelEnvelope({automator:e,paramId:t,delay:i}){let s=this.audioContext.currentTime+(i||0);return e.cancel({paramId:t,when:s}),_o(o(this,D),s)}playPattern(e,t){l().debug("[ecas] playPattern",e),t=c.defaultValue(t,{}),t.onEnded=c.defaultValue(t.onEnded,ce),t.startTime&&!Fe(t.startTime)&&(t.startTime=c.defaultNumber(t.startTime)/1e3),t.duration&&!Fe(t.duration)&&(t.duration=c.defaultNumber(t.duration)/1e3),t.startPos&&!Fe(t.startPos)&&(t.startPos=c.defaultNumber(t.startPos)/1e3);let i=o(this,ee).soundConfig.patterns.reduce((s,a)=>a.id===e?a:s);i.timeSignature&&this.setTimeSignature(i.timeSignature),i.tempo&&this.setTempo(i.tempo),o(this,U).playPattern(e,t)}pausePattern(e,t){l().debug("[ecas] pausePattern",e),t=c.defaultValue(t,{}),Q(t.delay)&&(t.delay=c.defaultNumber(t.delay)/1e3),o(this,U).pausePattern(e,t.delay)}resumePattern(e,t){l().debug("[ecas] resumePattern",e),t=c.defaultValue(t,{}),Q(t.delay)&&(t.delay=c.defaultNumber(t.delay)/1e3),o(this,U).resumePattern(e,t.delay,e)}stopPattern(e,t={}){l().debug("[ecas] stopPattern"),Q(t.delay)&&(t.delay=c.defaultNumber(t.delay)/1e3),o(this,U).stopPattern(e,t.delay)}playPool(e,t){l().debug("[ecas] playPool;",e),t=c.defaultValue(t,{}),t.volume=c.defaultNumber(t.volume,1),t.pan=c.defaultNumber(t.pan),t.loop=c.defaultValue(t.loop,!1),t.pitch=c.defaultNumber(t.pitch),t.startItem=c.defaultNumber(t.startItem,null),t.onEnded=c.defaultValue(t.onEnded,null),t.onItemEnded=c.defaultValue(t.onItemEnded,ce),t.startTime&&!Fe(t.startTime)&&(t.startTime=c.defaultNumber(t.startTime)/1e3),t.duration&&!Fe(t.duration)&&(t.duration=c.defaultNumber(t.duration)/1e3),t.startPos&&!Fe(t.startPos)&&(t.startPos=c.defaultNumber(t.startPos)/1e3),o(this,U).playPool(e,t)}resetPool(e){l().debug("[ecas] resetPool",e),o(this,U).resetPool(e)}pausePool(e,t={}){l().debug("[ecas] pausePool",e),Q(t.delay)&&(t.delay=c.defaultNumber(t.delay)/1e3),o(this,U).pausePool(e,t.delay)}resumePool(e,t){l().debug("[ecas] resumePool",e),t=c.defaultValue(t,{}),Q(t.delay)&&(t.delay=c.defaultNumber(t.delay)/1e3),o(this,U).resumePool(e,t.delay)}stopPool(e,t={}){l().debug("[ecas] stopPool"),Q(t.delay)&&(t.delay=c.defaultNumber(t.delay)/1e3),o(this,U).stopPool(e,t.delay)}async playSound(e,t={}){l().debug("[ecas] playSound",e),t.loop&&(t.duration&&l().warn("[ecas] playSound:",e,"duration argument will not work when loop is true"),t.fadeOut&&l().warn("[ecas] playSound:",e,"fadeout argument will not work when loop is true"));let i=this.assetHandler.soundHandler.getSound(e),s=new Ls(t),a=()=>o(this,U).playSound(i.id,s),n=this.assetHandler.soundHandler.details.get(e);return n!==void 0&&n.isLoaded?a():this.assetHandler.soundHandler.load([e]).then(a).catch(l().error)}stopSound(e,t={}){l().debug("[ecas] stopSound",e,{args:t});let i=new Wi(t);o(this,U).stopSound(e,i)}resumeSound(e,t){l().debug("[ecas] resumeSound",e),t=c.defaultValue(t,{}),Q(t.delay)&&(t.delay=c.defaultNumber(t.delay)/1e3),o(this,U).resumeSound(e,t.delay)}pauseSound(e,t={}){l().debug("[ecas] pauseSound",e),Q(t.delay)&&(t.delay=c.defaultNumber(t.delay)/1e3),o(this,U).pauseSound(e,t.delay)}stopAll(e={}){l().debug("[ecas] stopAll"),o(this,U).stopAll(e)}busGet({busId:e}){return l().debug("[ecas] busGet",e),o(this,B).buses.get(e)}busSetGain({busId:e,gain:t}){o(this,B).buses.get(e).automator.get("gain").value=t}busAddInsert(e){var t=e,{busId:i,typename:s}=t,a=Xt(t,["busId","typename"]);return X(i)&&(i=[i]),i.map(n=>o(this,B).buses.get(n).inserts.create(s,a))}busRemoveInsert({busId:e,insertId:t}){return X(e)&&(e=[e]),e.map(i=>this.mixer.buses.get(i).inserts.remove(t))}busAddFilter(e){return this.busAddInsert(C({typename:di.typename},e))}busAddCompressor(e){return this.busAddInsert(C({typename:ci.typename},e))}busAddAlgorithmicReverb(e){return this.busAddInsert(C({typename:ui.typename},e))}busAddConvolverReverb(e){return this.busAddInsert(C({typename:li.typename},e))}busAddDelay(e){return this.busAddInsert(C({typename:hi.typename},e))}busAddPingPongDelay(e){return this.busAddInsert(C({typename:Ui.typename},e))}busModifyInsert(e){var t=e,{busId:i,typename:s,duration:a}=t,n=Xt(t,["busId","typename","duration"]);X(i)&&(i=[i]);let r=u=>{let d=o(this,B).buses.get(u).inserts.get(n.id);if(Go(d,s)){let h=M(this,Ja,Fr).call(this,a);d.modify(n,h,o(this,D).sampleRate)}};return Promise.all(i.map(r))}busModifyAlgorithmicReverb(e){return this.busModifyInsert(C({typename:ui.typename},e))}busModifyConvolverReverb(e){return this.busModifyInsert(C({typename:li.typename},e))}busModifyDelay(e){return this.busModifyInsert(C({typename:hi.typename},e))}busModifyFilter(e){return this.busModifyInsert(C({typename:di.typename},e))}busModifyCompressor(e){return this.busModifyInsert(C({typename:ci.typename},e))}busAnalyse(e={}){e.callback=c.defaultValue(e.callback,ce),e.bus=c.defaultValue(e.bus,"master"),e.config=c.defaultValue(e.config,new Tf);let t=e.config?e.config.smoothingTimeConstant:.95;o(this,nt)||P(this,nt,{});let i=new Sf(t,a=>{e.callback(e.bus,a)});o(this,nt)[e.bus]=i;let s=i.create(o(this,D));o(this,B).buses.get(e.bus).output.connect(s)}busRemoveAnalyser(e){e=c.defaultValue(e,ys),o(this,nt)[e].destroy()}busApplyEnvelope(e){var t=e,{busId:i}=t,s=Xt(t,["busId"]);X(i)&&(i=[i]);let a=n=>this.applyEnvelope(C({automator:this.mixer.buses.get(n).automator},s));return Promise.all(i.map(a))}busCancelEnvelope(e){var t=e,{busId:i}=t,s=Xt(t,["busId"]);X(i)&&(i=[i]);let a=n=>this.cancelEnvelope(C({automator:this.mixer.buses.get(n).automator},s));return Promise.all(i.map(a))}busCancelEnvelopeOnInsert(e){var t=e,{busId:i,insertId:s}=t,a=Xt(t,["busId","insertId"]);X(i)&&(i=[i]);let n=r=>this.cancelEnvelope(C({automator:this.mixer.buses.get(r).inserts.get(s).automator},a));return Promise.all(i.map(n))}busApplyEnvelopeToCompressor(e){return this.busApplyEnvelopeToInsert(Re(C({},e),{typename:ci.typename}))}busApplyEnvelopeToAlgorithmicReverb(e){return this.busApplyEnvelopeToInsert(Re(C({},e),{typename:ui.typename}))}busApplyEnvelopeToFilter(e){return this.busApplyEnvelopeToInsert(Re(C({},e),{typename:di.typename}))}busApplyEnvelopeToDelay(e){return this.busApplyEnvelopeToInsert(Re(C({},e),{typename:hi.typename}))}busApplyEnvelopeToPingPongDelay(e){return this.busApplyEnvelopeToInsert(Re(C({},e),{typename:Ui.typename}))}busApplyEnvelopeToConvolverReverb(e){return this.busApplyEnvelopeToInsert(Re(C({},e),{typename:li.typename}))}busApplyEnvelopeToInsert(e){var t=e,{busId:i,insertId:s,typename:a}=t,n=Xt(t,["busId","insertId","typename"]);X(i)&&(i=[i]);let r=u=>{let d=o(this,B).buses.get(u).inserts.get(s);if(Go(d,a)){let h=d.automator;return this.applyEnvelope(C({automator:h},n))}return Promise.reject(`no insert with id: ${s} found on bus: ${u}`)};return Promise.all(i.map(r))}},Of=Za;B=new WeakMap,D=new WeakMap,Vi=new WeakMap,U=new WeakMap,nt=new WeakMap,ee=new WeakMap,Ka=new WeakMap,Ja=new WeakSet,Fr=function(e=0){return o(this,D).currentTime+.03+Math.max(e,0)};var Dt,Cf=class{constructor(){Ah(this,Dt,[])}add(e,...t){return Ai(this,Dt).push([e,...t]),this}at(e){return Ai(this,Dt).at(e)}*drain(){let e=Ai(this,Dt).shift();for(;e!==void 0;)yield e,e=Ai(this,Dt).shift()}length(){return Ai(this,Dt).length}};Dt=new WeakMap;var _f=class extends Error{constructor(e){super(e),this.name="EcasProviderError"}},If={NOT_READY:new _f("ecas is not ready")},Rf=class{constructor(){Pt(this,"ecas"),Pt(this,"creator",Of.create),Pt(this,"queue",new Cf),Pt(this,"options",{loadrConfig:{}}),Pt(this,"onerror",()=>{}),Pt(this,"ready",new Promise(e=>{let t=setInterval(()=>{this.ecas!==void 0&&(clearInterval(t),e(this.ecas))},64)})),Pt(this,"maybeQueue",e=>{function t(i,s){return s!==void 0&&(s===!0||s.includes(i))}t(e[0],this.options.loadrConfig.queue)&&this.queue.add(...e)})}withOptions(e){return this.options=e,this}load(){return this.creator(this.options).then(e=>{this.ecas=e;for(let t of this.queue.drain())this.fire(...t)}).catch(this.onerror),this}trigger(...e){return this.ecas===void 0?this.maybeQueue(e):this.fire(...e),this}fire(...e){var t;try{(t=this.ecas)==null||t.triggerGameEvent(...e).catch(this.onerror)}catch(i){this.onerror(i)}return this}get requiredEcas(){if(this.ecas===void 0)throw If.NOT_READY;return this.ecas}async dispose(){var e;let t=(e=this.ecas)==null?void 0:e.dispose().then(()=>{this.ecas=void 0}).catch(this.onerror);t!==void 0&&(await t,this.ecas=void 0)}withOnerror(e){return this.onerror=e,this}withCreator(e){return this.creator=e,this}},Fi=new Rf;(async()=>{var a;let t=(a=new URLSearchParams(window.location.search).get("ecas-load-path"))!=null?a:"https://jadujoel.github.io/template-sounds/",s=await(await fetch(`${t}/config.json`)).json();s.soundConfig.settings.loadPath=t,Fi.withOptions(s).load()})().catch(console.log);var Df=["start","spin","inactive","active","mute","unmute","stop","reverb_on","reverb_off"],un=class{load(){Df.forEach(t=>Vf(t)),Fi.ready.then(t=>{t.eventHandler.on(ua.Sound.Ended,i=>{console.log("[game]: SOUND ENDED: "+i)})})}};function Vf(e,...t){var s;let i=()=>{Fi.trigger(e,...t)};(s=document.getElementById(e))==null||s.addEventListener("click",i)}var $r=new un;$r.load();})();
//# sourceMappingURL=index.js.map
